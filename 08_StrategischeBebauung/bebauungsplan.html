<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EA Bebauungsplan</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: {
        primary: { 50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',300:'#93c5fd',400:'#60a5fa',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',800:'#1e40af',900:'#1e3a8a' },
        surface: { 50:'#f8fafc',100:'#f1f5f9',200:'#e2e8f0',300:'#cbd5e1',700:'#334155',800:'#1e293b',900:'#0f172a',950:'#020617' },
      }}}
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <style>
    [v-cloak] { display: none !important; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    .fade-enter-active, .fade-leave-active { transition: opacity .2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .domain-swatch { width: 12px; height: 12px; border-radius: 3px; display: inline-block; }
    .maturity-bar { height: 8px; border-radius: 4px; transition: width .5s ease; }
    .time-grid-line { stroke: #e2e8f0; stroke-width: 1; stroke-dasharray: 4,4; }
    .matrix-cell:hover { transform: scale(1.15); z-index: 10; }
    .matrix-cell { transition: transform .15s ease; }
    .dep-link { fill: none; stroke-opacity: 0.6; }
    .dep-node text { font-size: 11px; pointer-events: none; }
    .nav-item { transition: background-color .15s ease, color .15s ease; }
    .nav-item:hover { background-color: #e2e8f0; }
    .nav-item.active { background-color: #dbeafe; color: #1d4ed8; font-weight: 600; }
    @media (max-width: 1024px) { .sidebar-collapsed { transform: translateX(-100%); } }
    @media print { .no-print { display: none !important; } .sidebar { display: none !important; } }
  </style>
</head>
<body class="h-full bg-surface-50 text-gray-800 antialiased">
  <div id="app" v-cloak>
    <app-layout></app-layout>
  </div>

  <script>
// EA Bebauungsplan - Metallwerk Vorarlberg GmbH
// Single-File Build - works as file:// without server

// ── Vue API destructuring (global build) ──
const { reactive, watch } = Vue;

// ── SEED DATA ──
const SEED_DATA = {
  "meta": {
    "version": "1.0",
    "lastUpdated": "2026-02-07",
    "owner": "Enterprise Architecture",
    "company": "Metallwerk Vorarlberg GmbH",
    "description": "Strategischer Bebauungsplan — Datenmodell für ein mittelständisches Industrieunternehmen"
  },
  "enums": {
    "criticality": ["Mission-Critical", "Business-Critical", "Business-Operational", "Administrative"],
    "timeQuadrant": ["Tolerate", "Invest", "Migrate", "Eliminate"],
    "appType": ["SaaS", "On-Prem", "Custom", "PaaS"],
    "capabilityMaturity": [
      { "value": 1, "label": "Initial", "description": "Kaum vorhanden oder rein manuell (Excel, Papier)" },
      { "value": 2, "label": "Managed", "description": "Grundfunktionalität vorhanden, aber fragmentiert" },
      { "value": 3, "label": "Defined", "description": "Strukturiert umgesetzt, definierte Prozesse" },
      { "value": 4, "label": "Measured", "description": "Automatisiert, integriert, KPI-gesteuert" },
      { "value": 5, "label": "Optimized", "description": "Best-in-Class, kontinuierlich optimiert" }
    ],
    "capabilityCriticality": ["High", "Medium", "Low"],
    "mappingRole": ["Primary", "Secondary"],
    "projectCategory": ["Run / Pflicht", "Modernisierung", "Optimierung", "Innovation / Grow", "Infrastruktur"],
    "projectStatus": ["green", "yellow", "red"],
    "conformity": ["Konform", "Teilkonform", "Widerspricht"],
    "dependencyType": [
      { "value": "T", "label": "Technische Abhängigkeit", "symbol": "→T" },
      { "value": "D", "label": "Datenabhängigkeit", "symbol": "→D" },
      { "value": "P", "label": "Plattformabhängigkeit", "symbol": "→P" },
      { "value": "R", "label": "Ressourcenkonflikt", "symbol": "→R" },
      { "value": "F", "label": "Fachliche Abhängigkeit", "symbol": "→F" },
      { "value": "Z", "label": "Zeitliche Abhängigkeit", "symbol": "→Z" }
    ],
    "appAction": ["einführen", "verändern", "ablösen"],
    "kpiTrend": ["improving", "stable", "declining"],
    "processStatus": ["active", "optimization", "transformation"]
  },
  "domains": [
    {
      "id": 1,
      "name": "IT Infrastructure & Operations",
      "color": "#3B82F6",
      "icon": "server",
      "description": "Fundament der gesamten IT — Datacenter, Cloud, Netzwerk, Security, ITSM",
      "domainOwner": "CIO",
      "strategicFocus": "Stabilität, Hybrid Cloud, Kosteneffizienz",
      "vision": "Hybrid Cloud First — alle non-critical Workloads in Azure bis 2028, Zero-Trust Security Baseline",
      "kpis": [
        { "id": "KPI-D1-1", "name": "Cloud Workload %", "target": "60", "current": "25", "unit": "%", "trend": "improving" },
        { "id": "KPI-D1-2", "name": "Infrastructure Availability", "target": "99.9", "current": "99.5", "unit": "%", "trend": "stable" },
        { "id": "KPI-D1-3", "name": "Mean Time to Recovery", "target": "2", "current": "4.5", "unit": "h", "trend": "improving" }
      ],
      "capabilities": [
        {
          "id": "1.1", "name": "Datacenter Management", "maturity": 3, "targetMaturity": 3, "criticality": "High",
          "subCapabilities": [
            { "id": "1.1.1", "name": "Server & Compute Management" },
            { "id": "1.1.2", "name": "Storage Management" },
            { "id": "1.1.3", "name": "Netzwerk & Konnektivität" },
            { "id": "1.1.4", "name": "Physical Security & Facility" }
          ]
        },
        {
          "id": "1.2", "name": "Cloud Platform Management", "maturity": 2, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "1.2.1", "name": "Cloud Governance & Landing Zones" },
            { "id": "1.2.2", "name": "Cloud Compute & Container Services" },
            { "id": "1.2.3", "name": "Cloud Networking & Connectivity" },
            { "id": "1.2.4", "name": "Cloud Cost Management (FinOps)" }
          ]
        },
        {
          "id": "1.3", "name": "Hybrid Infrastructure", "maturity": 2, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "1.3.1", "name": "Hybrid Connectivity (VPN, ExpressRoute)" },
            { "id": "1.3.2", "name": "Identity & Access Management (Entra ID)" },
            { "id": "1.3.3", "name": "Monitoring & Observability" }
          ]
        },
        {
          "id": "1.4", "name": "IT Security & Compliance", "maturity": 3, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "1.4.1", "name": "Endpoint Security" },
            { "id": "1.4.2", "name": "Network Security" },
            { "id": "1.4.3", "name": "Security Operations (SOC/SIEM)" },
            { "id": "1.4.4", "name": "Backup & Disaster Recovery" }
          ]
        },
        {
          "id": "1.5", "name": "IT Service Management", "maturity": 3, "targetMaturity": 4, "criticality": "Medium",
          "subCapabilities": [
            { "id": "1.5.1", "name": "Incident & Problem Management" },
            { "id": "1.5.2", "name": "Change & Release Management" },
            { "id": "1.5.3", "name": "Asset & Configuration Management (CMDB)" }
          ]
        }
      ]
    },
    {
      "id": 2,
      "name": "Digital Workplace & Collaboration",
      "color": "#8B5CF6",
      "icon": "monitor",
      "description": "Arbeitsplatz, Zusammenarbeit, Wissensmanagement, Citizen Development",
      "domainOwner": "CIO",
      "strategicFocus": "Enablement, Adoption, Copilot-Readiness",
      "vision": "Intelligent Workplace — M365 Copilot-Ready, Knowledge Graph als Wissensbasis, Power Platform als Citizen-Dev-Plattform",
      "kpis": [
        { "id": "KPI-D2-1", "name": "M365 Adoption Score", "target": "80", "current": "52", "unit": "%", "trend": "improving" },
        { "id": "KPI-D2-2", "name": "Citizen Dev Apps", "target": "30", "current": "8", "unit": "#", "trend": "improving" }
      ],
      "capabilities": [
        {
          "id": "2.1", "name": "Modern Workplace", "maturity": 3, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "2.1.1", "name": "Workplace Provisioning & Lifecycle" },
            { "id": "2.1.2", "name": "Unified Communication (Teams Voice, Video)" },
            { "id": "2.1.3", "name": "Email & Calendar (Exchange Online)" },
            { "id": "2.1.4", "name": "Workplace Analytics & Adoption" }
          ]
        },
        {
          "id": "2.2", "name": "Collaboration & Content Management", "maturity": 2, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "2.2.1", "name": "Team Collaboration" },
            { "id": "2.2.2", "name": "Document Management & Governance" },
            { "id": "2.2.3", "name": "Intranet & Internal Communication" },
            { "id": "2.2.4", "name": "Content Lifecycle Management" }
          ]
        },
        {
          "id": "2.3", "name": "Enterprise Knowledge & Search", "maturity": 1, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "2.3.1", "name": "Knowledge Graph & Taxonomy" },
            { "id": "2.3.2", "name": "Enterprise Search (Microsoft Search)" },
            { "id": "2.3.3", "name": "AI-Assisted Knowledge Access (M365 Copilot)" },
            { "id": "2.3.4", "name": "Information Architecture & Metadata" }
          ]
        },
        {
          "id": "2.4", "name": "Citizen Development Platform", "maturity": 2, "targetMaturity": 4, "criticality": "Medium",
          "subCapabilities": [
            { "id": "2.4.1", "name": "Low-Code App Development (Power Apps)" },
            { "id": "2.4.2", "name": "Business Process Automation (Power Automate)" },
            { "id": "2.4.3", "name": "Data Visualization & Self-Service BI (Power BI)" },
            { "id": "2.4.4", "name": "Platform Governance & CoE" }
          ]
        }
      ]
    },
    {
      "id": 3,
      "name": "Vertrieb & Kundenmanagement",
      "color": "#10B981",
      "icon": "users",
      "description": "CRM, Auftrags- & Angebotswesen, Vertriebssteuerung, Pricing, After-Sales",
      "domainOwner": "Vertriebsleiter",
      "strategicFocus": "CRM-Konsolidierung, CPQ, Kundenportal",
      "vision": "360°-Kundenblick — Durchgängiger Lead-to-Cash-Prozess mit Salesforce als Kern-CRM",
      "kpis": [
        { "id": "KPI-D3-1", "name": "CRM Adoption Rate", "target": "95", "current": "72", "unit": "%", "trend": "improving" },
        { "id": "KPI-D3-2", "name": "Forecast Accuracy", "target": "85", "current": "60", "unit": "%", "trend": "stable" }
      ],
      "capabilities": [
        {
          "id": "3.1", "name": "CRM", "maturity": 3, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "3.1.1", "name": "Kundenstammdatenverwaltung" },
            { "id": "3.1.2", "name": "Kontakt- & Aktivitätenmanagement" },
            { "id": "3.1.3", "name": "Kundensegmentierung & -klassifizierung" },
            { "id": "3.1.4", "name": "Kundenportal & Self-Service" }
          ]
        },
        {
          "id": "3.2", "name": "Angebots- & Auftragswesen", "maturity": 3, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "3.2.1", "name": "Angebotskalkulation & -erstellung" },
            { "id": "3.2.2", "name": "Auftragserfassung & -bestätigung" },
            { "id": "3.2.3", "name": "Konfiguration & Variantenmanagement (CPQ)" },
            { "id": "3.2.4", "name": "Vertragsmanagement" }
          ]
        },
        {
          "id": "3.3", "name": "Vertriebssteuerung", "maturity": 2, "targetMaturity": 4, "criticality": "Medium",
          "subCapabilities": [
            { "id": "3.3.1", "name": "Pipeline- & Forecast-Management" },
            { "id": "3.3.2", "name": "Gebiets- & Key-Account-Management" },
            { "id": "3.3.3", "name": "Provisionsabrechnung" },
            { "id": "3.3.4", "name": "Vertriebsreporting & KPIs" }
          ]
        },
        {
          "id": "3.4", "name": "Pricing & Konditionen", "maturity": 2, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "3.4.1", "name": "Preisfindung & Rabattmanagement" },
            { "id": "3.4.2", "name": "Konditionsvereinbarungen" },
            { "id": "3.4.3", "name": "Wettbewerbsanalyse (Pricing Intelligence)" }
          ]
        },
        {
          "id": "3.5", "name": "After-Sales & Service", "maturity": 1, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "3.5.1", "name": "Reklamationsmanagement" },
            { "id": "3.5.2", "name": "Technischer Kundendienst / Field Service" },
            { "id": "3.5.3", "name": "Ersatzteilmanagement" },
            { "id": "3.5.4", "name": "Service-Level-Agreements (SLA)" }
          ]
        }
      ]
    },
    {
      "id": 4,
      "name": "Produktion & Fertigung",
      "color": "#F59E0B",
      "icon": "cog",
      "description": "PPS, MES, Qualitätsmanagement, Instandhaltung, Lean/CI",
      "domainOwner": "Werksleiter",
      "strategicFocus": "MES-ERP-Integration, Shopfloor-Digitalisierung",
      "vision": "Smart Factory — Durchgängige MES-ERP-Integration, OEE >85%, Predictive Maintenance für Kernmaschinen",
      "kpis": [
        { "id": "KPI-D4-1", "name": "OEE (Overall Equipment Effectiveness)", "target": "85", "current": "71", "unit": "%", "trend": "improving" },
        { "id": "KPI-D4-2", "name": "First Pass Yield", "target": "95", "current": "91", "unit": "%", "trend": "stable" },
        { "id": "KPI-D4-3", "name": "Schedule Adherence", "target": "90", "current": "83", "unit": "%", "trend": "improving" }
      ],
      "capabilities": [
        {
          "id": "4.1", "name": "Produktionsplanung (PPS)", "maturity": 4, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "4.1.1", "name": "Kapazitätsplanung" },
            { "id": "4.1.2", "name": "Feinplanung & Reihenfolgeoptimierung" },
            { "id": "4.1.3", "name": "Schichtplanung" },
            { "id": "4.1.4", "name": "Material- & Bedarfsplanung (MRP)" }
          ]
        },
        {
          "id": "4.2", "name": "Fertigungssteuerung (MES)", "maturity": 3, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "4.2.1", "name": "Fertigungsauftragsmanagement" },
            { "id": "4.2.2", "name": "Betriebsdatenerfassung (BDE)" },
            { "id": "4.2.3", "name": "Maschinendatenerfassung (MDE)" },
            { "id": "4.2.4", "name": "Rückmeldung & Fortschrittskontrolle" }
          ]
        },
        {
          "id": "4.3", "name": "Qualitätsmanagement", "maturity": 2, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "4.3.1", "name": "Wareneingangsprüfung" },
            { "id": "4.3.2", "name": "In-Prozess-Qualitätskontrolle (SPC)" },
            { "id": "4.3.3", "name": "Endprüfung & Freigabe" },
            { "id": "4.3.4", "name": "Reklamations- & CAPA-Management" },
            { "id": "4.3.5", "name": "Audit- & Zertifizierungsmanagement" }
          ]
        },
        {
          "id": "4.4", "name": "Instandhaltung & Maintenance", "maturity": 1, "targetMaturity": 3, "criticality": "High",
          "subCapabilities": [
            { "id": "4.4.1", "name": "Präventive Instandhaltung" },
            { "id": "4.4.2", "name": "Korrektive Instandhaltung" },
            { "id": "4.4.3", "name": "Predictive Maintenance (Condition Monitoring)" },
            { "id": "4.4.4", "name": "Ersatzteil- & Werkzeugverwaltung" }
          ]
        },
        {
          "id": "4.5", "name": "Lean & Continuous Improvement", "maturity": 2, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "4.5.1", "name": "Shopfloor-Management" },
            { "id": "4.5.2", "name": "KVP / Kaizen-Prozess" },
            { "id": "4.5.3", "name": "OEE-Tracking & Verlustanalyse" }
          ]
        }
      ]
    },
    {
      "id": 5,
      "name": "Supply Chain & Logistik",
      "color": "#EF4444",
      "icon": "truck",
      "description": "Einkauf, Lagerverwaltung, Logistik, SC Planning, Lieferantenintegration",
      "domainOwner": "Supply Chain Manager",
      "strategicFocus": "E2E-Transparenz, Lieferantenintegration",
      "vision": "Transparente Supply Chain — E2E-Transparenz vom Lieferanten bis zum Kunden, S&OP-Integration",
      "kpis": [
        { "id": "KPI-D5-1", "name": "P2P Cycle Time", "target": "30", "current": "48", "unit": "days", "trend": "improving" },
        { "id": "KPI-D5-2", "name": "Touchless Invoice Rate", "target": "60", "current": "25", "unit": "%", "trend": "stable" }
      ],
      "capabilities": [
        {
          "id": "5.1", "name": "Einkauf & Beschaffung", "maturity": 3, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "5.1.1", "name": "Strategischer Einkauf & Sourcing" },
            { "id": "5.1.2", "name": "Operativer Einkauf" },
            { "id": "5.1.3", "name": "Lieferantenmanagement & -bewertung" },
            { "id": "5.1.4", "name": "Vertrags- & Konditionsmanagement" },
            { "id": "5.1.5", "name": "E-Procurement & Katalogmanagement" }
          ]
        },
        {
          "id": "5.2", "name": "Lagerverwaltung & Bestandsmanagement", "maturity": 3, "targetMaturity": 3, "criticality": "High",
          "subCapabilities": [
            { "id": "5.2.1", "name": "Warehouse Management System (WMS)" },
            { "id": "5.2.2", "name": "Bestandsführung & Inventur" },
            { "id": "5.2.3", "name": "Lagerplatzoptimierung" },
            { "id": "5.2.4", "name": "Konsignationslager" }
          ]
        },
        {
          "id": "5.3", "name": "Logistik & Distribution", "maturity": 2, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "5.3.1", "name": "Versandabwicklung" },
            { "id": "5.3.2", "name": "Transportmanagement (TMS)" },
            { "id": "5.3.3", "name": "Zoll & Außenhandel" },
            { "id": "5.3.4", "name": "Track & Trace" }
          ]
        },
        {
          "id": "5.4", "name": "Supply Chain Planning", "maturity": 2, "targetMaturity": 4, "criticality": "Medium",
          "subCapabilities": [
            { "id": "5.4.1", "name": "Demand Planning & Forecasting" },
            { "id": "5.4.2", "name": "Sales & Operations Planning (S&OP)" },
            { "id": "5.4.3", "name": "Supply Network Design" },
            { "id": "5.4.4", "name": "Bestandsoptimierung" }
          ]
        },
        {
          "id": "5.5", "name": "Lieferantenintegration", "maturity": 1, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "5.5.1", "name": "EDI & Datenaustausch" },
            { "id": "5.5.2", "name": "Supplier Portal" },
            { "id": "5.5.3", "name": "Vendor Managed Inventory (VMI)" }
          ]
        }
      ]
    },
    {
      "id": 6,
      "name": "Engineering & Produktentwicklung",
      "color": "#06B6D4",
      "icon": "compass",
      "description": "CAD, PLM, Requirements, Test & Validation, Innovation",
      "domainOwner": "Entwicklungsleiter",
      "strategicFocus": "PLM-ERP-Brücke, Änderungsmanagement",
      "vision": "Digital Engineering — Durchgängiger digitaler Faden von Design über PLM bis Fertigung",
      "kpis": [
        { "id": "KPI-D6-1", "name": "Engineering Change Lead Time", "target": "5", "current": "12", "unit": "days", "trend": "improving" },
        { "id": "KPI-D6-2", "name": "BOM Accuracy", "target": "99", "current": "94", "unit": "%", "trend": "stable" }
      ],
      "capabilities": [
        {
          "id": "6.1", "name": "Produktdesign & Konstruktion", "maturity": 3, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "6.1.1", "name": "CAD / 3D-Modellierung" },
            { "id": "6.1.2", "name": "Simulation & FEM-Analyse" },
            { "id": "6.1.3", "name": "Rapid Prototyping / Additive Fertigung" },
            { "id": "6.1.4", "name": "Design Review & Freigabe" }
          ]
        },
        {
          "id": "6.2", "name": "Product Lifecycle Management (PLM)", "maturity": 3, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "6.2.1", "name": "Stücklistenmanagement (BOM)" },
            { "id": "6.2.2", "name": "Änderungsmanagement (ECR/ECO)" },
            { "id": "6.2.3", "name": "Dokumentenmanagement (technische Doku)" },
            { "id": "6.2.4", "name": "Konfigurationsmanagement" }
          ]
        },
        {
          "id": "6.3", "name": "Anforderungs- & Spezifikationsmanagement", "maturity": 2, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "6.3.1", "name": "Requirements Engineering" },
            { "id": "6.3.2", "name": "Normen- & Standardverwaltung" },
            { "id": "6.3.3", "name": "Technische Spezifikationen" }
          ]
        },
        {
          "id": "6.4", "name": "Test & Validation", "maturity": 2, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "6.4.1", "name": "Prüfplanung & -durchführung" },
            { "id": "6.4.2", "name": "Testergebnisdokumentation" },
            { "id": "6.4.3", "name": "Zulassung & Zertifizierung" }
          ]
        },
        {
          "id": "6.5", "name": "Innovation & Portfolio Management", "maturity": 1, "targetMaturity": 2, "criticality": "Low",
          "subCapabilities": [
            { "id": "6.5.1", "name": "Ideenmanagement / Innovation Pipeline" },
            { "id": "6.5.2", "name": "Technologie-Scouting" },
            { "id": "6.5.3", "name": "Produktportfolio-Steuerung" }
          ]
        }
      ]
    },
    {
      "id": 7,
      "name": "Finanzen & Controlling",
      "color": "#84CC16",
      "icon": "dollar-sign",
      "description": "Finanzbuchhaltung, Controlling, Planung, Reporting, Treasury",
      "domainOwner": "CFO",
      "strategicFocus": "Single Source of Truth, Planungsintegration",
      "vision": "Integrated Finance — Ein konsolidiertes Finanzreporting, durchgängige Planungsintegration, CSRD-Readiness",
      "kpis": [
        { "id": "KPI-D7-1", "name": "Days to Close", "target": "5", "current": "8", "unit": "days", "trend": "improving" },
        { "id": "KPI-D7-2", "name": "Forecast Variance", "target": "5", "current": "12", "unit": "%", "trend": "stable" }
      ],
      "capabilities": [
        {
          "id": "7.1", "name": "Finanzbuchhaltung", "maturity": 4, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "7.1.1", "name": "Hauptbuchhaltung" },
            { "id": "7.1.2", "name": "Debitorenbuchhaltung" },
            { "id": "7.1.3", "name": "Kreditorenbuchhaltung" },
            { "id": "7.1.4", "name": "Anlagenbuchhaltung" },
            { "id": "7.1.5", "name": "Konzernkonsolidierung" }
          ]
        },
        {
          "id": "7.2", "name": "Controlling", "maturity": 4, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "7.2.1", "name": "Kostenstellenrechnung" },
            { "id": "7.2.2", "name": "Kostenträgerrechnung / Produktkalkulation" },
            { "id": "7.2.3", "name": "Profit-Center-Rechnung" },
            { "id": "7.2.4", "name": "Deckungsbeitragsrechnung" }
          ]
        },
        {
          "id": "7.3", "name": "Planung & Budgetierung", "maturity": 2, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "7.3.1", "name": "Budgetplanung & Forecasting" },
            { "id": "7.3.2", "name": "Investitionsplanung (CapEx)" },
            { "id": "7.3.3", "name": "Liquiditätsplanung" },
            { "id": "7.3.4", "name": "Szenarioanalysen" }
          ]
        },
        {
          "id": "7.4", "name": "Reporting & Analytics", "maturity": 3, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "7.4.1", "name": "Management Reporting / MIS" },
            { "id": "7.4.2", "name": "Statutory Reporting" },
            { "id": "7.4.3", "name": "ESG / Nachhaltigkeitsreporting (CSRD)" },
            { "id": "7.4.4", "name": "Ad-hoc-Analysen & Dashboards" }
          ]
        },
        {
          "id": "7.5", "name": "Treasury & Compliance", "maturity": 3, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "7.5.1", "name": "Zahlungsverkehr" },
            { "id": "7.5.2", "name": "Bankanbindung" },
            { "id": "7.5.3", "name": "Steuerliche Compliance" },
            { "id": "7.5.4", "name": "Internes Kontrollsystem (IKS)" }
          ]
        }
      ]
    },
    {
      "id": 8,
      "name": "HR & Organisation",
      "color": "#EC4899",
      "icon": "user",
      "description": "Personaladministration, Abrechnung, Recruiting, Talent Management, HR Analytics",
      "domainOwner": "HR-Leiterin",
      "strategicFocus": "Digitalisierung, integrierte HR-Suite",
      "vision": "Digital HR — Ablösung der Insellösungen durch integrierte HR-Plattform (SAP SuccessFactors), Employee Self-Service",
      "kpis": [
        { "id": "KPI-D8-1", "name": "Time-to-Hire", "target": "45", "current": "68", "unit": "days", "trend": "stable" },
        { "id": "KPI-D8-2", "name": "Onboarding Completeness", "target": "90", "current": "55", "unit": "%", "trend": "improving" }
      ],
      "capabilities": [
        {
          "id": "8.1", "name": "Personaladministration", "maturity": 2, "targetMaturity": 3, "criticality": "High",
          "subCapabilities": [
            { "id": "8.1.1", "name": "Personalstammdatenverwaltung" },
            { "id": "8.1.2", "name": "Personalaktenführung (digital)" },
            { "id": "8.1.3", "name": "Bescheinigungs- & Dokumentenwesen" },
            { "id": "8.1.4", "name": "Organisationsmanagement (Organigramm)" }
          ]
        },
        {
          "id": "8.2", "name": "Personalabrechnung & Zeitwirtschaft", "maturity": 2, "targetMaturity": 3, "criticality": "High",
          "subCapabilities": [
            { "id": "8.2.1", "name": "Lohn- & Gehaltsabrechnung" },
            { "id": "8.2.2", "name": "Zeiterfassung & Abwesenheitsmanagement" },
            { "id": "8.2.3", "name": "Schichtplanung (Produktion)" },
            { "id": "8.2.4", "name": "Reisekostenmanagement" }
          ]
        },
        {
          "id": "8.3", "name": "Recruiting & Onboarding", "maturity": 2, "targetMaturity": 4, "criticality": "Medium",
          "subCapabilities": [
            { "id": "8.3.1", "name": "Bewerbermanagement (ATS)" },
            { "id": "8.3.2", "name": "Stellenausschreibung & Employer Branding" },
            { "id": "8.3.3", "name": "Onboarding-Prozess" },
            { "id": "8.3.4", "name": "Assessment & Auswahlverfahren" }
          ]
        },
        {
          "id": "8.4", "name": "Personalentwicklung & Talent Management", "maturity": 1, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "8.4.1", "name": "Mitarbeitergespräche & Zielvereinbarungen" },
            { "id": "8.4.2", "name": "Kompetenzmanagement" },
            { "id": "8.4.3", "name": "Nachfolgeplanung" },
            { "id": "8.4.4", "name": "Learning Management (LMS)" }
          ]
        },
        {
          "id": "8.5", "name": "HR Analytics & Strategie", "maturity": 1, "targetMaturity": 2, "criticality": "Low",
          "subCapabilities": [
            { "id": "8.5.1", "name": "Personalplanung & Workforce Planning" },
            { "id": "8.5.2", "name": "HR KPIs & Dashboards" },
            { "id": "8.5.3", "name": "Mitarbeiterbefragungen" }
          ]
        }
      ]
    },
    {
      "id": 9,
      "name": "Corporate & Querschnittsfunktionen",
      "color": "#6366F1",
      "icon": "briefcase",
      "description": "Unternehmenssteuerung, Recht, Facility, EHS, Dokumentenmanagement",
      "domainOwner": "COO",
      "strategicFocus": "Governance, EHS, PPM",
      "vision": "Integrated Governance — Zentrale Steuerung mit PPM, Risikomanagement und EHS-Digitalisierung",
      "kpis": [
        { "id": "KPI-D9-1", "name": "EHS Incident Rate", "target": "0", "current": "3", "unit": "#/year", "trend": "improving" },
        { "id": "KPI-D9-2", "name": "Compliance Audit Score", "target": "95", "current": "82", "unit": "%", "trend": "stable" }
      ],
      "capabilities": [
        {
          "id": "9.1", "name": "Unternehmenssteuerung & Strategie", "maturity": 1, "targetMaturity": 3, "criticality": "High",
          "subCapabilities": [
            { "id": "9.1.1", "name": "Strategisches Portfolio-Management" },
            { "id": "9.1.2", "name": "Risikomanagement (Enterprise)" },
            { "id": "9.1.3", "name": "Projektportfolio-Management (PPM)" },
            { "id": "9.1.4", "name": "OKR / Zielmanagement" }
          ]
        },
        {
          "id": "9.2", "name": "Recht & Compliance", "maturity": 2, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "9.2.1", "name": "Vertragsmanagement (CLM)" },
            { "id": "9.2.2", "name": "Datenschutz (DSGVO)" },
            { "id": "9.2.3", "name": "Regulatorik & Normenmanagement" },
            { "id": "9.2.4", "name": "Whistleblowing / Hinweisgebersystem" }
          ]
        },
        {
          "id": "9.3", "name": "Facility & Gebäudemanagement", "maturity": 2, "targetMaturity": 2, "criticality": "Low",
          "subCapabilities": [
            { "id": "9.3.1", "name": "Gebäudeverwaltung & Flächenmanagement" },
            { "id": "9.3.2", "name": "Gebäudetechnik (GLT/BMS)" },
            { "id": "9.3.3", "name": "Zutrittskontrolle & Sicherheit" },
            { "id": "9.3.4", "name": "Energiemanagement" }
          ]
        },
        {
          "id": "9.4", "name": "Environment, Health & Safety (EHS)", "maturity": 2, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "9.4.1", "name": "Arbeitssicherheit & Gefährdungsbeurteilungen" },
            { "id": "9.4.2", "name": "Umweltmanagement" },
            { "id": "9.4.3", "name": "Gefahrstoffmanagement" },
            { "id": "9.4.4", "name": "Incident- & Unfallmanagement" }
          ]
        },
        {
          "id": "9.5", "name": "Dokumentenmanagement & Archivierung", "maturity": 2, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "9.5.1", "name": "Enterprise Content Management (ECM)" },
            { "id": "9.5.2", "name": "Archivierung & Aufbewahrungsfristen" },
            { "id": "9.5.3", "name": "Workflow & Freigabeprozesse" },
            { "id": "9.5.4", "name": "Formular- & Template-Management" }
          ]
        }
      ]
    },
    {
      "id": 10,
      "name": "Data & Analytics",
      "color": "#F97316",
      "icon": "bar-chart",
      "description": "Data Platform, BI & Reporting, Advanced Analytics & AI, Industrial IoT",
      "domainOwner": "CDO / CIO",
      "strategicFocus": "Datenstrategie, AI/ML, IoT",
      "vision": "Data-Driven Enterprise — Zentrale Datenplattform (Azure), Self-Service Analytics, AI/ML für Predictive Use Cases",
      "kpis": [
        { "id": "KPI-D10-1", "name": "Data Quality Score", "target": "90", "current": "62", "unit": "%", "trend": "improving" },
        { "id": "KPI-D10-2", "name": "Self-Service BI Adoption", "target": "50", "current": "15", "unit": "%", "trend": "improving" },
        { "id": "KPI-D10-3", "name": "AI/ML Use Cases in Production", "target": "5", "current": "0", "unit": "#", "trend": "stable" }
      ],
      "capabilities": [
        {
          "id": "10.1", "name": "Data Platform & Integration", "maturity": 1, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "10.1.1", "name": "Data Warehouse / Data Lakehouse" },
            { "id": "10.1.2", "name": "ETL / ELT / Datenintegration" },
            { "id": "10.1.3", "name": "Master Data Management (MDM)" },
            { "id": "10.1.4", "name": "Data Governance & Data Quality" }
          ]
        },
        {
          "id": "10.2", "name": "BI & Reporting", "maturity": 3, "targetMaturity": 4, "criticality": "High",
          "subCapabilities": [
            { "id": "10.2.1", "name": "Standard-Reporting & Dashboards" },
            { "id": "10.2.2", "name": "Self-Service Analytics" },
            { "id": "10.2.3", "name": "Embedded Analytics" },
            { "id": "10.2.4", "name": "Mobile BI" }
          ]
        },
        {
          "id": "10.3", "name": "Advanced Analytics & AI", "maturity": 1, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "10.3.1", "name": "Predictive Analytics" },
            { "id": "10.3.2", "name": "Machine Learning Operations (MLOps)" },
            { "id": "10.3.3", "name": "NLP & Textanalyse" },
            { "id": "10.3.4", "name": "Computer Vision" }
          ]
        },
        {
          "id": "10.4", "name": "Industrial IoT & Datenerfassung", "maturity": 1, "targetMaturity": 3, "criticality": "Medium",
          "subCapabilities": [
            { "id": "10.4.1", "name": "Sensor-/Maschinendaten-Erfassung" },
            { "id": "10.4.2", "name": "Edge Computing & Gateway" },
            { "id": "10.4.3", "name": "Time-Series Data Management" },
            { "id": "10.4.4", "name": "Digital Twin Data Layer" }
          ]
        }
      ]
    }
  ],
  "applications": [
    {
      "id": "APP-001",
      "name": "SAP S/4HANA",
      "vendor": "SAP SE",
      "category": "ERP",
      "type": "On-Prem",
      "criticality": "Mission-Critical",
      "timeQuadrant": "Invest",
      "businessOwner": "CFO / Leiter Controlling",
      "itOwner": "SAP Basis Team",
      "costPerYear": 450000,
      "userCount": 320,
      "goLiveDate": "2019-04-01",
      "description": "Zentrales ERP-System für Finanzen, Controlling, Einkauf, Produktion, Lager, Vertrieb. Backbone aller Geschäftsprozesse.",
      "scores": { "businessValue": 9, "technicalHealth": 7 }
    },
    {
      "id": "APP-002",
      "name": "Salesforce Sales Cloud",
      "vendor": "Salesforce",
      "category": "CRM",
      "type": "SaaS",
      "criticality": "Business-Critical",
      "timeQuadrant": "Invest",
      "businessOwner": "Vertriebsleiter",
      "itOwner": "IT Application Management",
      "costPerYear": 120000,
      "userCount": 45,
      "goLiveDate": "2022-01-15",
      "description": "CRM-System für Vertrieb. Pipeline-Management, Kundenstamm, Angebotsverfolgung. Phase 1 ausgerollt, Phase 2 in Planung.",
      "scores": { "businessValue": 7, "technicalHealth": 9 }
    },
    {
      "id": "APP-003",
      "name": "MPDV HYDRA X",
      "vendor": "MPDV Mikrolab",
      "category": "MES",
      "type": "On-Prem",
      "criticality": "Mission-Critical",
      "timeQuadrant": "Invest",
      "businessOwner": "Werksleiter",
      "itOwner": "IT Produktion",
      "costPerYear": 180000,
      "userCount": 150,
      "goLiveDate": "2020-06-01",
      "description": "Manufacturing Execution System. BDE/MDE, Fertigungssteuerung, Rückmeldung. Aktuell nur Werk 1, Erweiterung Werk 2 geplant.",
      "scores": { "businessValue": 8, "technicalHealth": 7 }
    },
    {
      "id": "APP-004",
      "name": "Siemens Teamcenter",
      "vendor": "Siemens Digital Industries Software",
      "category": "PLM",
      "type": "On-Prem",
      "criticality": "Business-Critical",
      "timeQuadrant": "Tolerate",
      "businessOwner": "Leiter Engineering",
      "itOwner": "IT Engineering",
      "costPerYear": 200000,
      "userCount": 60,
      "goLiveDate": "2017-03-01",
      "description": "Product Lifecycle Management. Stücklisten (eBOM/mBOM), ECR/ECO, Dokumentenmanagement. Version veraltet, Upgrade zurückgestellt.",
      "scores": { "businessValue": 7, "technicalHealth": 5 }
    },
    {
      "id": "APP-005",
      "name": "Microsoft 365 E5",
      "vendor": "Microsoft",
      "category": "Workplace",
      "type": "SaaS",
      "criticality": "Mission-Critical",
      "timeQuadrant": "Invest",
      "businessOwner": "COO",
      "itOwner": "IT Workplace Team",
      "costPerYear": 280000,
      "userCount": 850,
      "goLiveDate": "2021-01-01",
      "description": "Digitaler Arbeitsplatz: Exchange Online, Teams, OneDrive, Office Apps. Basis für Zusammenarbeit und Kommunikation.",
      "scores": { "businessValue": 9, "technicalHealth": 9 }
    },
    {
      "id": "APP-006",
      "name": "SharePoint Online",
      "vendor": "Microsoft",
      "category": "Collaboration",
      "type": "SaaS",
      "criticality": "Business-Critical",
      "timeQuadrant": "Invest",
      "businessOwner": "Leiter Unternehmenskommunikation",
      "itOwner": "IT Workplace Team",
      "costPerYear": 0,
      "userCount": 600,
      "goLiveDate": "2021-01-01",
      "description": "Dokumentenmanagement, Intranet, Team-Sites. Im M365-Lizenzpaket enthalten. Governance noch unzureichend — Wildwuchs an Sites.",
      "scores": { "businessValue": 7, "technicalHealth": 8 }
    },
    {
      "id": "APP-007",
      "name": "Power BI Premium",
      "vendor": "Microsoft",
      "category": "BI & Reporting",
      "type": "SaaS",
      "criticality": "Business-Critical",
      "timeQuadrant": "Invest",
      "businessOwner": "Leiter Controlling",
      "itOwner": "IT Data & Analytics",
      "costPerYear": 60000,
      "userCount": 200,
      "goLiveDate": "2022-06-01",
      "description": "Self-Service BI und Management-Dashboards. Wird aktuell stark ausgebaut. Datenqualität aus SAP teilweise mangelhaft.",
      "scores": { "businessValue": 8, "technicalHealth": 8 }
    },
    {
      "id": "APP-008",
      "name": "ServiceNow ITSM",
      "vendor": "ServiceNow",
      "category": "ITSM",
      "type": "SaaS",
      "criticality": "Business-Operational",
      "timeQuadrant": "Invest",
      "businessOwner": "IT-Leiter",
      "itOwner": "IT Service Management",
      "costPerYear": 95000,
      "userCount": 25,
      "goLiveDate": "2023-03-01",
      "description": "IT Service Management: Incidents, Changes, Problems, Asset Management. Erst kürzlich eingeführt, noch nicht voll ausgerollt.",
      "scores": { "businessValue": 6, "technicalHealth": 9 }
    },
    {
      "id": "APP-009",
      "name": "Personio",
      "vendor": "Personio SE",
      "category": "HR",
      "type": "SaaS",
      "criticality": "Business-Critical",
      "timeQuadrant": "Migrate",
      "businessOwner": "HR-Leiterin",
      "itOwner": "IT Application Management",
      "costPerYear": 45000,
      "userCount": 30,
      "goLiveDate": "2020-09-01",
      "description": "HR-System: Personaladmin, Recruiting, Onboarding. Funktional ok, aber keine SAP-Integration. Ablösung durch SAP SuccessFactors geplant.",
      "scores": { "businessValue": 6, "technicalHealth": 7 }
    },
    {
      "id": "APP-010",
      "name": "SolidWorks Professional",
      "vendor": "Dassault Systèmes",
      "category": "CAD",
      "type": "On-Prem",
      "criticality": "Business-Critical",
      "timeQuadrant": "Tolerate",
      "businessOwner": "Leiter Konstruktion",
      "itOwner": "IT Engineering",
      "costPerYear": 85000,
      "userCount": 25,
      "goLiveDate": "2015-01-01",
      "description": "3D-CAD für Produktkonstruktion. Bewährt, aber Integration mit Teamcenter PLM ist manuell (Doppelerfassung Stücklisten).",
      "scores": { "businessValue": 7, "technicalHealth": 6 }
    },
    {
      "id": "APP-011",
      "name": "Microsoft Azure",
      "vendor": "Microsoft",
      "category": "Cloud Platform",
      "type": "PaaS",
      "criticality": "Mission-Critical",
      "timeQuadrant": "Invest",
      "businessOwner": "CIO",
      "itOwner": "IT Infrastructure & Cloud",
      "costPerYear": 320000,
      "userCount": 15,
      "goLiveDate": "2022-01-01",
      "description": "Cloud-Plattform: Azure AD (Entra ID), Virtual Machines, Azure SQL, Storage. Cloud-Migration Wave 1 läuft.",
      "scores": { "businessValue": 8, "technicalHealth": 9 }
    },
    {
      "id": "APP-012",
      "name": "Zabbix",
      "vendor": "Zabbix LLC",
      "category": "Monitoring",
      "type": "On-Prem",
      "criticality": "Business-Operational",
      "timeQuadrant": "Migrate",
      "businessOwner": "IT-Leiter",
      "itOwner": "IT Infrastructure",
      "costPerYear": 15000,
      "userCount": 8,
      "goLiveDate": "2018-06-01",
      "description": "Monitoring on-prem Infrastruktur. Deckt nicht Cloud-Workloads ab. Ablösung durch Azure Monitor + Sentinel geplant.",
      "scores": { "businessValue": 5, "technicalHealth": 4 }
    },
    {
      "id": "APP-013",
      "name": "SAGE DPW",
      "vendor": "SAGE",
      "category": "Zeitwirtschaft",
      "type": "On-Prem",
      "criticality": "Business-Operational",
      "timeQuadrant": "Eliminate",
      "businessOwner": "HR-Leiterin",
      "itOwner": "IT Application Management",
      "costPerYear": 25000,
      "userCount": 850,
      "goLiveDate": "2014-01-01",
      "description": "Zeiterfassung und Abwesenheitsmanagement. Veraltet, kein Support mehr. Ablösung durch SAP SuccessFactors Employee Central Payroll.",
      "scores": { "businessValue": 4, "technicalHealth": 2 }
    },
    {
      "id": "APP-014",
      "name": "Excel-basierte QM-Lösung",
      "vendor": "Eigenentwicklung",
      "category": "Quality Management",
      "type": "Custom",
      "criticality": "Business-Critical",
      "timeQuadrant": "Eliminate",
      "businessOwner": "Qualitätsleiter",
      "itOwner": "—",
      "costPerYear": 5000,
      "userCount": 80,
      "goLiveDate": "2012-01-01",
      "description": "Sammlung von Excel-Dateien und VBA-Makros für Prüfprotokolle, CAPA-Tracking, Audit-Checklisten. Fehleranfällig, keine Revisionssicherheit. Ablösung durch SAP QM dringend.",
      "scores": { "businessValue": 6, "technicalHealth": 1 }
    },
    {
      "id": "APP-015",
      "name": "Veeam Backup & Replication",
      "vendor": "Veeam Software",
      "category": "Backup & DR",
      "type": "On-Prem",
      "criticality": "Business-Critical",
      "timeQuadrant": "Tolerate",
      "businessOwner": "IT-Leiter",
      "itOwner": "IT Infrastructure",
      "costPerYear": 35000,
      "userCount": 3,
      "goLiveDate": "2019-01-01",
      "description": "Backup & Disaster Recovery für on-prem VMs und Datenbanken. Ergänzung durch Azure Backup für Cloud-Workloads nötig.",
      "scores": { "businessValue": 5, "technicalHealth": 7 }
    },
    {
      "id": "APP-016",
      "name": "Power Platform",
      "vendor": "Microsoft",
      "category": "Low-Code / BPA",
      "type": "PaaS",
      "criticality": "Business-Operational",
      "timeQuadrant": "Invest",
      "businessOwner": "Diverse (Citizen Devs)",
      "itOwner": "IT Workplace Team",
      "costPerYear": 40000,
      "userCount": 50,
      "goLiveDate": "2023-06-01",
      "description": "Power Apps, Power Automate, Power Pages. Aktuell ~15 aktive Apps, kein CoE, keine Governance. Wildwuchs droht.",
      "scores": { "businessValue": 6, "technicalHealth": 7 }
    },
    {
      "id": "APP-017",
      "name": "Atlassian Confluence",
      "vendor": "Atlassian",
      "category": "Knowledge Management",
      "type": "SaaS",
      "criticality": "Business-Operational",
      "timeQuadrant": "Migrate",
      "businessOwner": "IT-Leiter",
      "itOwner": "IT Application Management",
      "costPerYear": 18000,
      "userCount": 200,
      "goLiveDate": "2019-06-01",
      "description": "Wiki und Wissensbasis. Parallel zu SharePoint — Fragmentierung der Inhalte. Konsolidierung nach SharePoint/Viva geplant.",
      "scores": { "businessValue": 5, "technicalHealth": 7 }
    },
    {
      "id": "APP-018",
      "name": "Multicash (Banking)",
      "vendor": "Omikron Systemhaus",
      "category": "Treasury",
      "type": "On-Prem",
      "criticality": "Business-Operational",
      "timeQuadrant": "Tolerate",
      "businessOwner": "Leiter Finanzbuchhaltung",
      "itOwner": "IT Application Management",
      "costPerYear": 12000,
      "userCount": 5,
      "goLiveDate": "2016-01-01",
      "description": "Bankanbindung und Zahlungsverkehr. Läuft stabil, geringe strategische Relevanz.",
      "scores": { "businessValue": 4, "technicalHealth": 6 }
    }
  ],
  "capabilityMappings": [
    { "capabilityId": "1.1", "applicationId": "APP-011", "role": "Primary" },
    { "capabilityId": "1.2", "applicationId": "APP-011", "role": "Primary" },
    { "capabilityId": "1.3", "applicationId": "APP-011", "role": "Primary" },
    { "capabilityId": "1.3", "applicationId": "APP-012", "role": "Secondary" },
    { "capabilityId": "1.4", "applicationId": "APP-011", "role": "Primary" },
    { "capabilityId": "1.4", "applicationId": "APP-015", "role": "Secondary" },
    { "capabilityId": "1.5", "applicationId": "APP-008", "role": "Primary" },
    { "capabilityId": "2.1", "applicationId": "APP-005", "role": "Primary" },
    { "capabilityId": "2.2", "applicationId": "APP-006", "role": "Primary" },
    { "capabilityId": "2.2", "applicationId": "APP-005", "role": "Secondary" },
    { "capabilityId": "2.3", "applicationId": "APP-017", "role": "Primary" },
    { "capabilityId": "2.3", "applicationId": "APP-006", "role": "Secondary" },
    { "capabilityId": "2.4", "applicationId": "APP-016", "role": "Primary" },
    { "capabilityId": "3.1", "applicationId": "APP-002", "role": "Primary" },
    { "capabilityId": "3.2", "applicationId": "APP-001", "role": "Primary" },
    { "capabilityId": "3.2", "applicationId": "APP-002", "role": "Secondary" },
    { "capabilityId": "3.3", "applicationId": "APP-002", "role": "Primary" },
    { "capabilityId": "3.4", "applicationId": "APP-001", "role": "Primary" },
    { "capabilityId": "4.1", "applicationId": "APP-001", "role": "Primary" },
    { "capabilityId": "4.1", "applicationId": "APP-003", "role": "Secondary" },
    { "capabilityId": "4.2", "applicationId": "APP-003", "role": "Primary" },
    { "capabilityId": "4.3", "applicationId": "APP-014", "role": "Primary" },
    { "capabilityId": "4.3", "applicationId": "APP-001", "role": "Secondary" },
    { "capabilityId": "5.1", "applicationId": "APP-001", "role": "Primary" },
    { "capabilityId": "5.2", "applicationId": "APP-001", "role": "Primary" },
    { "capabilityId": "5.3", "applicationId": "APP-001", "role": "Primary" },
    { "capabilityId": "5.4", "applicationId": "APP-001", "role": "Secondary" },
    { "capabilityId": "6.1", "applicationId": "APP-010", "role": "Primary" },
    { "capabilityId": "6.2", "applicationId": "APP-004", "role": "Primary" },
    { "capabilityId": "6.2", "applicationId": "APP-010", "role": "Secondary" },
    { "capabilityId": "7.1", "applicationId": "APP-001", "role": "Primary" },
    { "capabilityId": "7.2", "applicationId": "APP-001", "role": "Primary" },
    { "capabilityId": "7.3", "applicationId": "APP-001", "role": "Secondary" },
    { "capabilityId": "7.4", "applicationId": "APP-007", "role": "Primary" },
    { "capabilityId": "7.4", "applicationId": "APP-001", "role": "Secondary" },
    { "capabilityId": "7.5", "applicationId": "APP-018", "role": "Primary" },
    { "capabilityId": "7.5", "applicationId": "APP-001", "role": "Secondary" },
    { "capabilityId": "8.1", "applicationId": "APP-009", "role": "Primary" },
    { "capabilityId": "8.2", "applicationId": "APP-013", "role": "Primary" },
    { "capabilityId": "8.2", "applicationId": "APP-009", "role": "Secondary" },
    { "capabilityId": "8.3", "applicationId": "APP-009", "role": "Primary" },
    { "capabilityId": "9.5", "applicationId": "APP-006", "role": "Primary" },
    { "capabilityId": "10.2", "applicationId": "APP-007", "role": "Primary" }
  ],
  "projects": [
    {
      "id": "PRJ-001",
      "name": "SAP S/4HANA Upgrade 2025",
      "primaryDomain": 7,
      "secondaryDomains": [4, 5, 3],
      "capabilities": ["7.1", "7.2", "4.1", "5.1", "5.2", "3.2"],
      "affectedApps": [{ "appId": "APP-001", "action": "verändern" }],
      "category": "Modernisierung",
      "budget": 480000,
      "start": "Q1/2026",
      "end": "Q4/2026",
      "status": "yellow",
      "statusText": "Ressourcenengpass SAP-Berater",
      "sponsor": "CFO",
      "projectLead": "Thomas Weber",
      "strategicContribution": "Basis für alle nachfolgenden SAP-Erweiterungen. Enabler-Projekt.",
      "timeReference": "Invest",
      "e2eProcesses": ["O2C", "P2P", "P2Prod", "R2R"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-002",
      "name": "Salesforce Phase 2 Rollout",
      "primaryDomain": 3,
      "secondaryDomains": [],
      "capabilities": ["3.1", "3.3", "3.4"],
      "affectedApps": [{ "appId": "APP-002", "action": "verändern" }],
      "category": "Optimierung",
      "budget": 150000,
      "start": "Q2/2026",
      "end": "Q4/2026",
      "status": "green",
      "statusText": "In Planung",
      "sponsor": "Vertriebsleiter",
      "projectLead": "Maria Schmidt",
      "strategicContribution": "Vertriebscode-Abdeckung auf 100%, Forecast-Qualität verbessern",
      "timeReference": "Invest",
      "e2eProcesses": ["O2C"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-003",
      "name": "MES Erweiterung Werk 2",
      "primaryDomain": 4,
      "secondaryDomains": [10],
      "capabilities": ["4.2", "4.5"],
      "affectedApps": [{ "appId": "APP-003", "action": "verändern" }],
      "category": "Innovation / Grow",
      "budget": 280000,
      "start": "Q1/2026",
      "end": "Q3/2027",
      "status": "green",
      "statusText": "Anforderungsanalyse läuft",
      "sponsor": "Werksleiter",
      "projectLead": "Klaus Berger",
      "strategicContribution": "Durchgängige Fertigungssteuerung über beide Werke, OEE-Transparenz",
      "timeReference": "Invest",
      "e2eProcesses": ["P2Prod"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-004",
      "name": "Cloud Migration Wave 1",
      "primaryDomain": 1,
      "secondaryDomains": [],
      "capabilities": ["1.2", "1.3"],
      "affectedApps": [{ "appId": "APP-011", "action": "verändern" }],
      "category": "Infrastruktur",
      "budget": 350000,
      "start": "Q1/2026",
      "end": "Q2/2027",
      "status": "yellow",
      "statusText": "Azure Landing Zone Konzept in Abstimmung",
      "sponsor": "CIO",
      "projectLead": "Stefan Hofer",
      "strategicContribution": "Erste 15 Workloads in Azure, Basis für Hybrid Cloud Strategie",
      "timeReference": "Invest",
      "e2eProcesses": ["R2F"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-005",
      "name": "Power Platform CoE Setup",
      "primaryDomain": 2,
      "secondaryDomains": [],
      "capabilities": ["2.4"],
      "affectedApps": [{ "appId": "APP-016", "action": "verändern" }],
      "category": "Optimierung",
      "budget": 80000,
      "start": "Q2/2026",
      "end": "Q4/2026",
      "status": "green",
      "statusText": "Budgetfreigabe erteilt",
      "sponsor": "CIO",
      "projectLead": "Anna Mayer",
      "strategicContribution": "Governance für Citizen Development, Shadow IT vermeiden",
      "timeReference": "Invest",
      "e2eProcesses": ["R2F"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-006",
      "name": "Identity Management (Entra ID)",
      "primaryDomain": 1,
      "secondaryDomains": [2],
      "capabilities": ["1.3", "1.4"],
      "affectedApps": [{ "appId": "APP-011", "action": "verändern" }],
      "category": "Infrastruktur",
      "budget": 120000,
      "start": "Q1/2026",
      "end": "Q3/2026",
      "status": "green",
      "statusText": "Implementierung läuft",
      "sponsor": "CIO",
      "projectLead": "Stefan Hofer",
      "strategicContribution": "Single Sign-On, Conditional Access, Zero Trust Basis",
      "timeReference": "Invest",
      "e2eProcesses": ["R2F", "H2R"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-007",
      "name": "Data Warehouse / BI Modernisierung",
      "primaryDomain": 10,
      "secondaryDomains": [7],
      "capabilities": ["10.1", "10.2", "7.4"],
      "affectedApps": [
        { "appId": "APP-007", "action": "verändern" },
        { "appId": "APP-011", "action": "verändern" }
      ],
      "category": "Innovation / Grow",
      "budget": 250000,
      "start": "Q3/2026",
      "end": "Q2/2027",
      "status": "green",
      "statusText": "Konzeptphase",
      "sponsor": "CFO",
      "projectLead": "Lisa Gruber",
      "strategicContribution": "Zentrale Datenbasis (Azure Synapse), Self-Service Analytics für Fachbereiche",
      "timeReference": "Invest",
      "e2eProcesses": ["R2R"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-008",
      "name": "QM-Digitalisierung (Excel → SAP QM)",
      "primaryDomain": 4,
      "secondaryDomains": [],
      "capabilities": ["4.3"],
      "affectedApps": [
        { "appId": "APP-001", "action": "verändern" },
        { "appId": "APP-014", "action": "ablösen" }
      ],
      "category": "Modernisierung",
      "budget": 180000,
      "start": "Q2/2026",
      "end": "Q1/2027",
      "status": "green",
      "statusText": "Warten auf SAP Upgrade",
      "sponsor": "Qualitätsleiter",
      "projectLead": "Thomas Weber",
      "strategicContribution": "Excel-QM ablösen, Revisionssicherheit, ISO-Audit-Readiness",
      "timeReference": "Migrate",
      "e2eProcesses": ["P2Prod", "O2C"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-009",
      "name": "SharePoint Governance & Migration",
      "primaryDomain": 2,
      "secondaryDomains": [9],
      "capabilities": ["2.2", "9.5"],
      "affectedApps": [
        { "appId": "APP-006", "action": "verändern" },
        { "appId": "APP-017", "action": "ablösen" }
      ],
      "category": "Modernisierung",
      "budget": 90000,
      "start": "Q1/2026",
      "end": "Q3/2026",
      "status": "yellow",
      "statusText": "Informationsarchitektur-Konzept in Arbeit",
      "sponsor": "COO",
      "projectLead": "Anna Mayer",
      "strategicContribution": "Konsolidierung Confluence → SharePoint, Governance-Framework, Copilot-Readiness",
      "timeReference": "Invest",
      "e2eProcesses": [],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-010",
      "name": "HR System Modernisierung (→ SAP SF)",
      "primaryDomain": 8,
      "secondaryDomains": [],
      "capabilities": ["8.1", "8.2", "8.3", "8.4"],
      "affectedApps": [
        { "appId": "APP-009", "action": "ablösen" },
        { "appId": "APP-013", "action": "ablösen" }
      ],
      "category": "Modernisierung",
      "budget": 200000,
      "start": "Q1/2027",
      "end": "Q3/2027",
      "status": "green",
      "statusText": "Vorprojekt / Evaluation",
      "sponsor": "HR-Leiterin",
      "projectLead": "Sandra Kofler",
      "strategicContribution": "Ganzheitliche HR-Plattform, SAP-Integration, End-of-Support Personio/SAGE",
      "timeReference": "Migrate",
      "e2eProcesses": ["H2R"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-011",
      "name": "Cybersecurity Enhancement",
      "primaryDomain": 1,
      "secondaryDomains": [],
      "capabilities": ["1.4"],
      "affectedApps": [
        { "appId": "APP-011", "action": "verändern" },
        { "appId": "APP-012", "action": "ablösen" }
      ],
      "category": "Run / Pflicht",
      "budget": 160000,
      "start": "Q1/2026",
      "end": "Q4/2026",
      "status": "green",
      "statusText": "NIS2-Compliance Deadline beachten",
      "sponsor": "CIO",
      "projectLead": "Stefan Hofer",
      "strategicContribution": "NIS2-Compliance, SOC/SIEM aufbauen (Azure Sentinel), Zabbix → Azure Monitor",
      "timeReference": "Invest",
      "e2eProcesses": ["I2R"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    },
    {
      "id": "PRJ-012",
      "name": "IoT Pilotprojekt Produktion",
      "primaryDomain": 10,
      "secondaryDomains": [4],
      "capabilities": ["10.4", "4.4"],
      "affectedApps": [{ "appId": "APP-011", "action": "verändern" }],
      "category": "Innovation / Grow",
      "budget": 120000,
      "start": "Q3/2026",
      "end": "Q2/2027",
      "status": "green",
      "statusText": "Business Case in Erstellung",
      "sponsor": "Werksleiter",
      "projectLead": "Klaus Berger",
      "strategicContribution": "Sensor-Daten von 5 Pilotmaschinen, Predictive Maintenance Proof-of-Concept",
      "timeReference": "Invest",
      "e2eProcesses": ["P2Prod"],
      "mediaBreakRefs": [],
      "conformity": "Konform"
    }
  ],
  "projectDependencies": [
    { "sourceProjectId": "PRJ-003", "targetProjectId": "PRJ-001", "type": "T", "description": "MES-Integration benötigt neue SAP-Schnittstellen aus dem Upgrade" },
    { "sourceProjectId": "PRJ-007", "targetProjectId": "PRJ-001", "type": "D", "description": "DWH braucht saubere SAP-Extraktoren (CDS Views) aus dem neuen Release" },
    { "sourceProjectId": "PRJ-008", "targetProjectId": "PRJ-001", "type": "T", "description": "SAP QM Modul benötigt S/4HANA 2025 Release" },
    { "sourceProjectId": "PRJ-005", "targetProjectId": "PRJ-006", "type": "P", "description": "CoE benötigt Entra ID Conditional Access für Environment-Management" },
    { "sourceProjectId": "PRJ-010", "targetProjectId": "PRJ-001", "type": "T", "description": "SAP SuccessFactors Integration benötigt S/4HANA Upgrade" },
    { "sourceProjectId": "PRJ-009", "targetProjectId": "PRJ-006", "type": "P", "description": "SharePoint Governance baut auf Entra ID Gruppen auf" },
    { "sourceProjectId": "PRJ-012", "targetProjectId": "PRJ-003", "type": "D", "description": "IoT-Daten sollen mit MES-Daten korreliert werden" },
    { "sourceProjectId": "PRJ-012", "targetProjectId": "PRJ-007", "type": "D", "description": "Sensordaten fließen in Data Warehouse" },
    { "sourceProjectId": "PRJ-004", "targetProjectId": "PRJ-006", "type": "T", "description": "Cloud Landing Zone braucht Entra ID als Identity Provider" },
    { "sourceProjectId": "PRJ-011", "targetProjectId": "PRJ-006", "type": "T", "description": "Azure Sentinel/SOC benötigt Entra ID Integration" },
    { "sourceProjectId": "PRJ-010", "targetProjectId": "PRJ-006", "type": "P", "description": "SuccessFactors SSO über Entra ID" },
    { "sourceProjectId": "PRJ-003", "targetProjectId": "PRJ-004", "type": "P", "description": "MES Cloud-Anbindung läuft über Azure-Infrastruktur" }
  ],
  "managementKPIs": [
    { "id": "MKPI-1", "name": "Capability Coverage", "description": "% der Capabilities mit ausreichender IT-Unterstützung (Maturity ≥3)", "target": "85", "current": "52", "unit": "%", "trend": "improving", "category": "Architecture" },
    { "id": "MKPI-2", "name": "Redundanz-Index", "description": "% der Capabilities mit >1 Primary-System", "target": "10", "current": "18", "unit": "%", "trend": "stable", "category": "Architecture" },
    { "id": "MKPI-3", "name": "Architektur-Compliance", "description": "% der neuen Demands, die konform zum Bebauungsplan sind", "target": "90", "current": "75", "unit": "%", "trend": "improving", "category": "Governance" },
    { "id": "MKPI-4", "name": "TIME Invest Ratio", "description": "% des IT-Budgets, das in Invest-Quadrant fließt", "target": "35", "current": "42", "unit": "%", "trend": "stable", "category": "Budget" },
    { "id": "MKPI-5", "name": "Roadmap Progress", "description": "% der Roadmap-Items die on-track sind", "target": "75", "current": "67", "unit": "%", "trend": "improving", "category": "Execution" }
  ],
  "e2eProcesses": [
    {
      "id": "O2C", "name": "Order-to-Cash", "owner": "Vertriebsleiter",
      "description": "Vom Kundenauftrag über Fertigung und Versand bis zur Rechnungsstellung und Zahlungseingang",
      "domains": [3, 4, 5, 7],
      "status": "optimization",
      "kpis": [
        { "id": "KPI-O2C-1", "name": "Order-to-Delivery Time", "target": "5", "current": "8", "unit": "workdays", "trend": "improving" },
        { "id": "KPI-O2C-2", "name": "Perfect Order Rate", "target": "95", "current": "88", "unit": "%", "trend": "stable" }
      ]
    },
    {
      "id": "P2P", "name": "Procure-to-Pay", "owner": "Supply Chain Manager",
      "description": "Von der Bedarfsanforderung über Bestellung und Wareneingang bis zur Rechnungsprüfung und Zahlung",
      "domains": [5, 7],
      "status": "optimization",
      "kpis": [
        { "id": "KPI-P2P-1", "name": "P2P Cycle Time", "target": "30", "current": "48", "unit": "days", "trend": "improving" },
        { "id": "KPI-P2P-2", "name": "Touchless Invoice Rate", "target": "60", "current": "25", "unit": "%", "trend": "improving" }
      ]
    },
    {
      "id": "P2Prod", "name": "Plan-to-Produce", "owner": "Werksleiter",
      "description": "Von der Produktionsplanung über Fertigungssteuerung bis zur Qualitätssicherung und Einlagerung",
      "domains": [4, 5, 6],
      "status": "transformation",
      "kpis": [
        { "id": "KPI-P2P2-1", "name": "Schedule Adherence", "target": "90", "current": "83", "unit": "%", "trend": "improving" },
        { "id": "KPI-P2P2-2", "name": "First Pass Yield", "target": "95", "current": "91", "unit": "%", "trend": "stable" }
      ]
    },
    {
      "id": "H2R", "name": "Hire-to-Retire", "owner": "HR-Leiterin",
      "description": "Vom Recruiting über Onboarding, Entwicklung bis zum Austritt",
      "domains": [8],
      "status": "transformation",
      "kpis": [
        { "id": "KPI-H2R-1", "name": "Time-to-Hire", "target": "45", "current": "68", "unit": "days", "trend": "stable" },
        { "id": "KPI-H2R-2", "name": "Onboarding Completeness", "target": "90", "current": "55", "unit": "%", "trend": "improving" }
      ]
    },
    {
      "id": "R2R", "name": "Record-to-Report", "owner": "CFO",
      "description": "Von der Buchung über Monatsabschluss bis zum Management-Reporting und Konzernkonsolidierung",
      "domains": [7, 10],
      "status": "optimization",
      "kpis": [
        { "id": "KPI-R2R-1", "name": "Days to Close", "target": "5", "current": "8", "unit": "workdays", "trend": "improving" },
        { "id": "KPI-R2R-2", "name": "Report Automation Rate", "target": "70", "current": "35", "unit": "%", "trend": "improving" }
      ]
    },
    {
      "id": "I2R", "name": "Issue-to-Resolution", "owner": "CIO",
      "description": "Vom IT-Incident über Troubleshooting bis zur Lösung und Ursachenanalyse",
      "domains": [1],
      "status": "active",
      "kpis": [
        { "id": "KPI-I2R-1", "name": "Mean Time to Resolve", "target": "4", "current": "6.5", "unit": "h", "trend": "improving" },
        { "id": "KPI-I2R-2", "name": "First Contact Resolution Rate", "target": "70", "current": "52", "unit": "%", "trend": "stable" }
      ]
    },
    {
      "id": "D2D", "name": "Design-to-Deliver", "owner": "Entwicklungsleiter",
      "description": "Von der Produktidee über Engineering, Prototyping bis zur Serienfreigabe",
      "domains": [6, 4],
      "status": "active",
      "kpis": [
        { "id": "KPI-D2D-1", "name": "Time-to-Market", "target": "12", "current": "18", "unit": "months", "trend": "stable" },
        { "id": "KPI-D2D-2", "name": "Engineering Change Lead Time", "target": "5", "current": "12", "unit": "days", "trend": "improving" }
      ]
    },
    {
      "id": "R2F", "name": "Request-to-Fulfill (IT)", "owner": "CIO",
      "description": "Von der IT-Anforderung über Bewertung, Umsetzung bis zur Bereitstellung",
      "domains": [1, 2, 9],
      "status": "optimization",
      "kpis": [
        { "id": "KPI-R2F-1", "name": "IT Demand Fulfillment Time", "target": "30", "current": "52", "unit": "days", "trend": "improving" },
        { "id": "KPI-R2F-2", "name": "IT Demand Compliance Rate", "target": "90", "current": "75", "unit": "%", "trend": "improving" }
      ]
    },
    {
      "id": "S2S", "name": "Sense-to-Sustain (Data)", "owner": "CDO / CIO",
      "description": "Von der Datenerfassung (IoT/Sensoren) über Integration und Analyse bis zur nachhaltigen Nutzung",
      "domains": [10, 4],
      "status": "transformation",
      "kpis": [
        { "id": "KPI-S2S-1", "name": "Data Pipeline Reliability", "target": "99", "current": "85", "unit": "%", "trend": "improving" },
        { "id": "KPI-S2S-2", "name": "Analytics User Adoption", "target": "40", "current": "15", "unit": "%", "trend": "improving" }
      ]
    }
  ]
}
;

// ══════ STORE ══════
// store.js — Reactive application store (Vue 3 Composition API)

const STORAGE_KEY = 'ea-bebauungsplan-v1'
let debounceTimer = null

// ────────────────────────────────────────────
// Default state shape
// ────────────────────────────────────────────
function createEmptyState () {
  return {
    meta: { version: '1.0', lastUpdated: '', owner: '', company: '', description: '' },
    domains: [],
    applications: [],
    capabilityMappings: [],
    projects: [],
    projectDependencies: [],
    managementKPIs: [],
    e2eProcesses: [],
    enums: {}
  }
}

// ────────────────────────────────────────────
// Reactive store
// ────────────────────────────────────────────
const store = reactive({
  data: createEmptyState(),
  loaded: false,
  sidebarOpen: true,

  // ── Getters (computed-like but on reactive) ──

  get totalApps () { return this.data.applications.length },
  get totalProjects () { return this.data.projects.length },

  get totalCapabilities () {
    return this.data.domains.reduce((n, d) => n + d.capabilities.length, 0)
  },

  get totalSubCapabilities () {
    return this.data.domains.reduce((n, d) =>
      n + d.capabilities.reduce((m, c) => m + (c.subCapabilities ? c.subCapabilities.length : 0), 0), 0)
  },

  get avgMaturity () {
    let sum = 0; let count = 0
    this.data.domains.forEach(d => d.capabilities.forEach(c => { sum += c.maturity; count++ }))
    return count ? +(sum / count).toFixed(1) : 0
  },

  get totalBudget () {
    return this.data.projects.reduce((s, p) => s + (p.budget || 0), 0)
  },

  get timeDistribution () {
    const dist = { Invest: 0, Tolerate: 0, Migrate: 0, Eliminate: 0 }
    this.data.applications.forEach(a => { if (dist[a.timeQuadrant] !== undefined) dist[a.timeQuadrant]++ })
    return dist
  },

  get projectStatusCounts () {
    const c = { green: 0, yellow: 0, red: 0 }
    this.data.projects.forEach(p => { if (c[p.status] !== undefined) c[p.status]++ })
    return c
  },

  get avgTargetMaturity () {
    let sum = 0; let count = 0
    this.data.domains.forEach(d => d.capabilities.forEach(c => {
      if (c.targetMaturity) { sum += c.targetMaturity; count++ }
    }))
    return count ? +(sum / count).toFixed(1) : 0
  },

  get maturityGaps () {
    const gaps = []
    this.data.domains.forEach(d => d.capabilities.forEach(c => {
      const gap = (c.targetMaturity || c.maturity) - c.maturity
      if (gap > 0) gaps.push({ capId: c.id, capName: c.name, domainName: d.name, domainColor: d.color, current: c.maturity, target: c.targetMaturity, gap })
    }))
    return gaps.sort((a, b) => b.gap - a.gap)
  },

  // ── Domain helpers ──

  domainById (id) {
    return this.data.domains.find(d => d.id === Number(id))
  },

  capabilityById (capId) {
    for (const d of this.data.domains) {
      const c = d.capabilities.find(cap => cap.id === capId)
      if (c) return { ...c, domain: d }
    }
    return null
  },

  domainForCapability (capId) {
    return this.data.domains.find(d => d.capabilities.some(c => c.id === capId))
  },

  // ── Application CRUD ──

  appById (id) {
    return this.data.applications.find(a => a.id === id)
  },

  addApp (app) {
    app.id = app.id || 'APP-' + String(this.data.applications.length + 1).padStart(3, '0')
    this.data.applications.push(app)
  },

  updateApp (id, patch) {
    const idx = this.data.applications.findIndex(a => a.id === id)
    if (idx !== -1) Object.assign(this.data.applications[idx], patch)
  },

  deleteApp (id) {
    this.data.applications = this.data.applications.filter(a => a.id !== id)
    this.data.capabilityMappings = this.data.capabilityMappings.filter(m => m.applicationId !== id)
    this.data.projects.forEach(p => {
      if (p.affectedApps) p.affectedApps = p.affectedApps.filter(a => a.appId !== id)
    })
  },

  appsForCapability (capId) {
    const mappings = this.data.capabilityMappings.filter(m => m.capabilityId === capId)
    return mappings.map(m => ({
      ...this.appById(m.applicationId),
      role: m.role
    })).filter(a => a.id)
  },

  capabilitiesForApp (appId) {
    const mappings = this.data.capabilityMappings.filter(m => m.applicationId === appId)
    return mappings.map(m => ({
      ...this.capabilityById(m.capabilityId),
      role: m.role
    })).filter(c => c)
  },

  // ── Mapping CRUD ──

  addMapping (capId, appId, role = 'Primary') {
    const exists = this.data.capabilityMappings.find(m => m.capabilityId === capId && m.applicationId === appId)
    if (!exists) this.data.capabilityMappings.push({ capabilityId: capId, applicationId: appId, role })
  },

  removeMapping (capId, appId) {
    this.data.capabilityMappings = this.data.capabilityMappings.filter(
      m => !(m.capabilityId === capId && m.applicationId === appId)
    )
  },

  // ── Project CRUD ──

  projectById (id) {
    return this.data.projects.find(p => p.id === id)
  },

  addProject (proj) {
    proj.id = proj.id || 'PRJ-' + String(this.data.projects.length + 1).padStart(3, '0')
    this.data.projects.push(proj)
  },

  updateProject (id, patch) {
    const idx = this.data.projects.findIndex(p => p.id === id)
    if (idx !== -1) Object.assign(this.data.projects[idx], patch)
  },

  deleteProject (id) {
    this.data.projects = this.data.projects.filter(p => p.id !== id)
    this.data.projectDependencies = this.data.projectDependencies.filter(
      d => d.sourceProjectId !== id && d.targetProjectId !== id
    )
  },

  depsForProject (id) {
    return this.data.projectDependencies.filter(d => d.sourceProjectId === id || d.targetProjectId === id)
  },

  projectsForDomain (domainId) {
    return this.data.projects.filter(p =>
      p.primaryDomain === Number(domainId) ||
      (p.secondaryDomains && p.secondaryDomains.includes(Number(domainId)))
    )
  },

  // ── Dependency CRUD ──

  addDependency (dep) {
    this.data.projectDependencies.push(dep)
  },

  removeDependency (sourceId, targetId) {
    this.data.projectDependencies = this.data.projectDependencies.filter(
      d => !(d.sourceProjectId === sourceId && d.targetProjectId === targetId)
    )
  },

  // ── Domain CRUD ──

  addDomain (domain) {
    const maxId = this.data.domains.reduce((m, d) => Math.max(m, d.id), 0)
    domain.id = maxId + 1
    if (!domain.capabilities) domain.capabilities = []
    if (!domain.kpis) domain.kpis = []
    this.data.domains.push(domain)
    return domain.id
  },

  updateDomain (id, patch) {
    const d = this.domainById(id)
    if (d) Object.assign(d, patch)
  },

  deleteDomain (id) {
    const d = this.domainById(id)
    if (!d) return
    const capIds = d.capabilities.map(c => c.id)
    this.data.capabilityMappings = this.data.capabilityMappings.filter(m => !capIds.includes(m.capabilityId))
    this.data.projects.forEach(p => {
      if (p.primaryDomain === Number(id)) p.primaryDomain = null
      if (p.secondaryDomains) p.secondaryDomains = p.secondaryDomains.filter(x => x !== Number(id))
      if (p.capabilities) p.capabilities = p.capabilities.filter(c => !capIds.includes(c))
    })
    this.data.e2eProcesses?.forEach(proc => {
      if (proc.domains) proc.domains = proc.domains.filter(x => x !== Number(id))
    })
    this.data.domains = this.data.domains.filter(d => d.id !== Number(id))
  },

  // ── Capability CRUD ──

  addCapability (domainId, cap) {
    const d = this.domainById(domainId)
    if (!d) return
    const nextIdx = d.capabilities.length + 1
    cap.id = cap.id || `${d.id}.${nextIdx}`
    if (!cap.subCapabilities) cap.subCapabilities = []
    if (cap.targetMaturity === undefined) cap.targetMaturity = cap.maturity || 1
    d.capabilities.push(cap)
  },

  updateCapability (capId, patch) {
    for (const d of this.data.domains) {
      const c = d.capabilities.find(cap => cap.id === capId)
      if (c) { Object.assign(c, patch); return }
    }
  },

  deleteCapability (capId) {
    this.data.capabilityMappings = this.data.capabilityMappings.filter(m => m.capabilityId !== capId)
    this.data.projects.forEach(p => {
      if (p.capabilities) p.capabilities = p.capabilities.filter(c => c !== capId)
    })
    for (const d of this.data.domains) {
      const idx = d.capabilities.findIndex(c => c.id === capId)
      if (idx !== -1) { d.capabilities.splice(idx, 1); return }
    }
  },

  addSubCapability (capId, sub) {
    for (const d of this.data.domains) {
      const c = d.capabilities.find(cap => cap.id === capId)
      if (c) {
        if (!c.subCapabilities) c.subCapabilities = []
        const nextIdx = c.subCapabilities.length + 1
        sub.id = sub.id || `${capId}.${nextIdx}`
        c.subCapabilities.push(sub)
        return
      }
    }
  },

  deleteSubCapability (capId, subId) {
    for (const d of this.data.domains) {
      const c = d.capabilities.find(cap => cap.id === capId)
      if (c && c.subCapabilities) {
        c.subCapabilities = c.subCapabilities.filter(s => s.id !== subId)
        return
      }
    }
  },

  // ── E2E Process CRUD ──

  processById (id) {
    return (this.data.e2eProcesses || []).find(p => p.id === id)
  },

  addProcess (proc) {
    if (!this.data.e2eProcesses) this.data.e2eProcesses = []
    this.data.e2eProcesses.push(proc)
  },

  updateProcess (id, patch) {
    const p = this.processById(id)
    if (p) Object.assign(p, patch)
  },

  deleteProcess (id) {
    if (!this.data.e2eProcesses) return
    this.data.e2eProcesses = this.data.e2eProcesses.filter(p => p.id !== id)
  },

  processesForDomain (domainId) {
    return (this.data.e2eProcesses || []).filter(p => p.domains && p.domains.includes(Number(domainId)))
  },

  /** Derive applications involved in an E2E process via domain→capability→mapping chain */
  appsForProcess (processId) {
    const proc = this.processById(processId)
    if (!proc || !proc.domains) return []
    const appMap = new Map()
    proc.domains.forEach(domId => {
      const d = this.domainById(domId)
      if (!d) return
      d.capabilities.forEach(cap => {
        const mappings = this.data.capabilityMappings.filter(m => m.capabilityId === cap.id)
        mappings.forEach(m => {
          const app = this.appById(m.applicationId)
          if (app && !appMap.has(app.id)) {
            appMap.set(app.id, { ...app, roles: new Set(), capCount: 0 })
          }
          if (app && appMap.has(app.id)) {
            appMap.get(app.id).roles.add(m.role)
            appMap.get(app.id).capCount++
          }
        })
      })
    })
    return Array.from(appMap.values()).map(a => ({
      ...a, roles: Array.from(a.roles).join(', ')
    })).sort((a, b) => b.capCount - a.capCount)
  },

  /** Find all E2E processes that touch an application (derived via mapping chain) */
  processesForApp (appId) {
    const capMappings = this.data.capabilityMappings.filter(m => m.applicationId === appId)
    const domainIds = new Set()
    capMappings.forEach(m => {
      const d = this.domainForCapability(m.capabilityId)
      if (d) domainIds.add(d.id)
    })
    return (this.data.e2eProcesses || []).filter(p =>
      p.domains && p.domains.some(did => domainIds.has(did))
    )
  },

  // ── Management KPI CRUD ──

  updateManagementKPI (id, patch) {
    const kpi = (this.data.managementKPIs || []).find(k => k.id === id)
    if (kpi) Object.assign(kpi, patch)
  }
})

// ────────────────────────────────────────────
// Persistence — localStorage with debounce
// ────────────────────────────────────────────
function persist () {
  clearTimeout(debounceTimer)
  debounceTimer = setTimeout(() => {
    try {
      const raw = JSON.parse(JSON.stringify(store.data))
      raw.meta.lastUpdated = new Date().toISOString()
      localStorage.setItem(STORAGE_KEY, JSON.stringify(raw))
    } catch (e) {
      console.warn('[store] persist failed', e)
    }
  }, 500)
}

// Watch deeply and auto-persist
function startWatching () {
  watch(() => store.data, persist, { deep: true })
}

// ────────────────────────────────────────────
// Load — from localStorage or seed JSON
// ────────────────────────────────────────────
function loadData () {
  const saved = localStorage.getItem(STORAGE_KEY)
  if (saved) {
    try {
      store.data = JSON.parse(saved)
      store.loaded = true
      return
    } catch (e) { console.warn('[store] corrupt localStorage, loading seed', e) }
  }
  try {
    store.data  = JSON.parse(JSON.stringify(SEED_DATA))
    store.loaded = true
    persist()
  } catch (e) {
    console.error('[store] failed to load seed data', e)
    store.data  = createEmptyState()
    store.loaded = true
  }
}

// ────────────────────────────────────────────
// Import / Export / Reset
// ────────────────────────────────────────────
function exportJSON () {
  const raw = JSON.parse(JSON.stringify(store.data))
  raw.meta.lastUpdated = new Date().toISOString()
  const blob = new Blob([JSON.stringify(raw, null, 2)], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `bebauungsplan_${new Date().toISOString().slice(0, 10)}.json`
  a.click()
  URL.revokeObjectURL(url)
}

function importJSON (file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result)
        store.data = data
        persist()
        resolve()
      } catch (e) { reject(e) }
    }
    reader.onerror = reject
    reader.readAsText(file)
  })
}

function resetToSeed () {
  localStorage.removeItem(STORAGE_KEY)
  loadData()
  return Promise.resolve()
}


// ══════ ROUTER ══════
// router.js — Minimal hash-based SPA router

const router = reactive({
  path: '',
  params: {},
  query: {}
})

// Route definitions: pattern → component name
const routes = [
  { pattern: /^\/$/,                        component: 'dashboard-view' },
  { pattern: /^\/domains$/,                 component: 'domain-list' },
  { pattern: /^\/domains\/(\d+)$/,          component: 'domain-detail',   paramNames: ['id'] },
  { pattern: /^\/apps$/,                    component: 'app-list' },
  { pattern: /^\/apps\/(APP-\d+)$/,         component: 'app-detail',      paramNames: ['id'] },
  { pattern: /^\/capability-matrix$/,       component: 'cap-app-matrix' },
  { pattern: /^\/time$/,                    component: 'time-quadrant' },
  { pattern: /^\/projects$/,                component: 'project-list' },
  { pattern: /^\/projects\/(PRJ-\d+)$/,     component: 'project-detail',   paramNames: ['id'] },
  { pattern: /^\/project-heatmap$/,         component: 'project-heatmap' },
  { pattern: /^\/dependencies$/,            component: 'dependency-graph' },
  { pattern: /^\/processes$/,               component: 'process-list' },
  { pattern: /^\/processes\/([A-Za-z0-9]+)$/, component: 'process-detail', paramNames: ['id'] },
  { pattern: /^\/maturity-gap$/,            component: 'maturity-gap' },
  { pattern: /^\/settings$/,               component: 'settings-view' }
]

function resolve () {
  const hash = window.location.hash.slice(1) || '/'
  const [pathPart, queryPart] = hash.split('?')
  const path = pathPart || '/'

  // Parse query string
  const query = {}
  if (queryPart) {
    queryPart.split('&').forEach(p => {
      const [k, v] = p.split('=')
      query[decodeURIComponent(k)] = decodeURIComponent(v || '')
    })
  }

  // Match route
  for (const r of routes) {
    const match = path.match(r.pattern)
    if (match) {
      const params = {}
      if (r.paramNames) {
        r.paramNames.forEach((name, i) => { params[name] = match[i + 1] })
      }
      router.path = path
      router.params = params
      router.query = query
      router.component = r.component
      return
    }
  }

  // 404 fallback → dashboard
  router.path = '/'
  router.params = {}
  router.query = query
  router.component = 'dashboard-view'
}

function navigateTo (path) {
  window.location.hash = '#' + path
}

function initRouter () {
  window.addEventListener('hashchange', resolve)
  resolve()
}

// Navigation helper for templates
function linkTo (path) {
  return '#' + path
}


// ══════ COMPONENTS ══════

// ── DomainForm (domain-form.js) ──
// domain-form.js — Modal form for creating/editing a domain (incl. strategy, KPIs)

const PALETTE = ['#3B82F6','#8B5CF6','#10B981','#F59E0B','#EF4444','#06B6D4','#84CC16','#EC4899','#6366F1','#F97316','#14B8A6','#A855F7']

const DomainForm = {
  name: 'DomainForm',
  props: { editDomain: { type: Object, default: null } },
  emits: ['close', 'saved'],
  template: `
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" @click.self="$emit('close')">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-surface-200 flex items-center justify-between sticky top-0 bg-white rounded-t-2xl z-10">
          <h3 class="text-base font-semibold text-gray-900">{{ editDomain ? 'Edit Domain' : 'New Domain' }}</h3>
          <button @click="$emit('close')" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>
        <form @submit.prevent="save" class="px-6 py-4 space-y-5">

          <!-- Basic Info -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="sm:col-span-2">
              <label class="block text-xs font-medium text-gray-600 mb-1">Domain Name *</label>
              <input v-model="form.name" required class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Domain Owner</label>
              <input v-model="form.domainOwner" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" placeholder="e.g. CIO, CFO, COO" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Color</label>
              <div class="flex flex-wrap gap-2 mt-1">
                <button v-for="c in palette" :key="c" type="button" @click="form.color = c"
                        class="w-7 h-7 rounded-lg border-2 transition-all"
                        :style="{ backgroundColor: c }"
                        :class="form.color === c ? 'border-gray-800 scale-110' : 'border-transparent'"></button>
              </div>
            </div>
            <div class="sm:col-span-2">
              <label class="block text-xs font-medium text-gray-600 mb-1">Description</label>
              <textarea v-model="form.description" rows="2" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none resize-vertical"></textarea>
            </div>
          </div>

          <!-- Strategy Section -->
          <div class="border-t border-surface-200 pt-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-3">Strategy & Vision</h4>
            <div class="space-y-3">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Strategic Focus</label>
                <input v-model="form.strategicFocus" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" placeholder="e.g. Cloud-Migration, Integration, Standardisierung" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Vision</label>
                <textarea v-model="form.vision" rows="2" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none resize-vertical" placeholder="Target state description for this domain"></textarea>
              </div>
            </div>
          </div>

          <!-- KPIs Section -->
          <div class="border-t border-surface-200 pt-4">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-semibold text-gray-700">Domain KPIs</h4>
              <button type="button" @click="addKpi" class="text-xs text-primary-600 hover:text-primary-800 font-medium">+ Add KPI</button>
            </div>
            <div v-if="form.kpis.length === 0" class="text-xs text-gray-400 italic">No KPIs defined yet</div>
            <div v-for="(kpi, i) in form.kpis" :key="i" class="flex items-start gap-2 mb-2 p-3 bg-surface-50 rounded-lg">
              <div class="flex-1 grid grid-cols-2 sm:grid-cols-4 gap-2">
                <div class="sm:col-span-2">
                  <input v-model="kpi.name" placeholder="KPI Name" class="w-full px-2 py-1.5 border border-surface-200 rounded text-xs focus:ring-1 focus:ring-primary-300 outline-none" />
                </div>
                <div>
                  <input v-model="kpi.target" placeholder="Target" class="w-full px-2 py-1.5 border border-surface-200 rounded text-xs focus:ring-1 focus:ring-primary-300 outline-none" />
                </div>
                <div>
                  <input v-model="kpi.current" placeholder="Current" class="w-full px-2 py-1.5 border border-surface-200 rounded text-xs focus:ring-1 focus:ring-primary-300 outline-none" />
                </div>
                <div>
                  <input v-model="kpi.unit" placeholder="Unit (%,#,h)" class="w-full px-2 py-1.5 border border-surface-200 rounded text-xs focus:ring-1 focus:ring-primary-300 outline-none" />
                </div>
                <div>
                  <select v-model="kpi.trend" class="w-full px-2 py-1.5 border border-surface-200 rounded text-xs bg-white focus:ring-1 focus:ring-primary-300 outline-none">
                    <option value="improving">↑ Improving</option>
                    <option value="stable">→ Stable</option>
                    <option value="declining">↓ Declining</option>
                  </select>
                </div>
              </div>
              <button type="button" @click="form.kpis.splice(i, 1)" class="text-gray-400 hover:text-red-500 text-lg mt-1">&times;</button>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex justify-end gap-3 pt-2 border-t border-surface-200">
            <button type="button" @click="$emit('close')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-surface-100">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm hover:bg-primary-700">{{ editDomain ? 'Update' : 'Create' }}</button>
          </div>
        </form>
      </div>
    </div>
  `,
  setup (props, { emit }) {
    const { ref, onMounted } = Vue
    const palette = PALETTE

    const defaultForm = () => ({
      name: '', color: '#3B82F6', icon: '', description: '',
      domainOwner: '', strategicFocus: '', vision: '',
      kpis: []
    })

    const form = ref(defaultForm())

    onMounted(() => {
      if (props.editDomain) {
        form.value = {
          ...defaultForm(),
          name: props.editDomain.name,
          color: props.editDomain.color,
          icon: props.editDomain.icon || '',
          description: props.editDomain.description || '',
          domainOwner: props.editDomain.domainOwner || '',
          strategicFocus: props.editDomain.strategicFocus || '',
          vision: props.editDomain.vision || '',
          kpis: (props.editDomain.kpis || []).map(k => ({ ...k }))
        }
      }
    })

    function addKpi () {
      const id = 'KPI-D-' + Date.now()
      form.value.kpis.push({ id, name: '', target: '', current: '', unit: '%', trend: 'stable' })
    }

    function save () {
      const data = { ...form.value }
      // Assign KPI IDs if missing
      data.kpis = data.kpis.filter(k => k.name).map((k, i) => ({
        ...k,
        id: k.id || `KPI-D-${Date.now()}-${i}`
      }))
      if (props.editDomain) {
        store.updateDomain(props.editDomain.id, data)
      } else {
        store.addDomain(data)
      }
      emit('saved')
    }

    return { store, form, palette, addKpi, save }
  }
}


// ── CapabilityForm (capability-form.js) ──
// capability-form.js — Modal form for creating/editing a capability (incl. target maturity, KPIs, sub-capabilities)

const CapabilityForm = {
  name: 'CapabilityForm',
  props: {
    editCapability: { type: Object, default: null },
    domainId: { type: Number, required: true }
  },
  emits: ['close', 'saved'],
  template: `
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" @click.self="$emit('close')">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-surface-200 flex items-center justify-between sticky top-0 bg-white rounded-t-2xl z-10">
          <h3 class="text-base font-semibold text-gray-900">{{ editCapability ? 'Edit Capability' : 'New Capability' }}</h3>
          <button @click="$emit('close')" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>
        <form @submit.prevent="save" class="px-6 py-4 space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="sm:col-span-2">
              <label class="block text-xs font-medium text-gray-600 mb-1">Capability Name *</label>
              <input v-model="form.name" required class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Criticality</label>
              <select v-model="form.criticality" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-primary-300 outline-none">
                <option v-for="c in store.data.enums.capabilityCriticality" :key="c" :value="c">{{ c }}</option>
              </select>
            </div>
            <div></div>

            <!-- Maturity (Ist) -->
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Current Maturity (Ist)</label>
              <div class="flex items-center gap-2">
                <input type="range" v-model.number="form.maturity" min="1" max="5" step="1" class="flex-1 accent-blue-600" />
                <span class="text-sm font-bold w-6 text-center" :style="{ color: matColor(form.maturity) }">{{ form.maturity }}</span>
              </div>
              <div class="flex justify-between text-[9px] text-gray-400 px-0.5"><span>Initial</span><span>Optimized</span></div>
            </div>

            <!-- Target Maturity (Soll) -->
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Target Maturity (Soll)</label>
              <div class="flex items-center gap-2">
                <input type="range" v-model.number="form.targetMaturity" min="1" max="5" step="1" class="flex-1 accent-indigo-600" />
                <span class="text-sm font-bold w-6 text-center" :style="{ color: matColor(form.targetMaturity) }">{{ form.targetMaturity }}</span>
              </div>
              <div class="flex justify-between text-[9px] text-gray-400 px-0.5"><span>Initial</span><span>Optimized</span></div>
            </div>

            <div class="sm:col-span-2">
              <label class="block text-xs font-medium text-gray-600 mb-1">Description</label>
              <textarea v-model="form.description" rows="2" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none resize-vertical"></textarea>
            </div>
          </div>

          <!-- Sub-Capabilities -->
          <div class="border-t border-surface-200 pt-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-gray-700">Sub-Capabilities</h4>
              <button type="button" @click="addSub" class="text-xs text-primary-600 hover:text-primary-800 font-medium">+ Add</button>
            </div>
            <div class="flex flex-wrap gap-2">
              <div v-for="(sub, i) in form.subCapabilities" :key="i" class="flex items-center gap-1 bg-surface-100 rounded px-2 py-1">
                <input v-model="sub.name" class="bg-transparent text-xs outline-none w-40" placeholder="Sub-capability name" />
                <button type="button" @click="form.subCapabilities.splice(i, 1)" class="text-gray-400 hover:text-red-500 text-sm">&times;</button>
              </div>
            </div>
          </div>

          <!-- KPIs -->
          <div class="border-t border-surface-200 pt-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-gray-700">Capability KPIs</h4>
              <button type="button" @click="addKpi" class="text-xs text-primary-600 hover:text-primary-800 font-medium">+ Add KPI</button>
            </div>
            <div v-for="(kpi, i) in form.kpis" :key="i" class="flex items-start gap-2 mb-2 p-2 bg-surface-50 rounded-lg">
              <div class="flex-1 grid grid-cols-2 sm:grid-cols-4 gap-2">
                <div class="sm:col-span-2">
                  <input v-model="kpi.name" placeholder="KPI Name" class="w-full px-2 py-1 border border-surface-200 rounded text-xs outline-none" />
                </div>
                <input v-model="kpi.target" placeholder="Target" class="px-2 py-1 border border-surface-200 rounded text-xs outline-none" />
                <input v-model="kpi.current" placeholder="Current" class="px-2 py-1 border border-surface-200 rounded text-xs outline-none" />
                <input v-model="kpi.unit" placeholder="Unit" class="px-2 py-1 border border-surface-200 rounded text-xs outline-none" />
                <select v-model="kpi.trend" class="px-2 py-1 border border-surface-200 rounded text-xs bg-white outline-none">
                  <option value="improving">↑ Improving</option>
                  <option value="stable">→ Stable</option>
                  <option value="declining">↓ Declining</option>
                </select>
              </div>
              <button type="button" @click="form.kpis.splice(i, 1)" class="text-gray-400 hover:text-red-500 text-sm mt-1">&times;</button>
            </div>
          </div>

          <div class="flex justify-end gap-3 pt-2 border-t border-surface-200">
            <button type="button" @click="$emit('close')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-surface-100">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm hover:bg-primary-700">{{ editCapability ? 'Update' : 'Create' }}</button>
          </div>
        </form>
      </div>
    </div>
  `,
  setup (props, { emit }) {
    const { ref, onMounted } = Vue

    const defaultForm = () => ({
      name: '', criticality: 'Medium', maturity: 1, targetMaturity: 3,
      description: '', subCapabilities: [], kpis: []
    })

    const form = ref(defaultForm())

    onMounted(() => {
      if (props.editCapability) {
        const c = props.editCapability
        form.value = {
          name: c.name,
          criticality: c.criticality || 'Medium',
          maturity: c.maturity || 1,
          targetMaturity: c.targetMaturity || c.maturity || 1,
          description: c.description || '',
          subCapabilities: (c.subCapabilities || []).map(s => ({ ...s })),
          kpis: (c.kpis || []).map(k => ({ ...k }))
        }
      }
    })

    function matColor (m) {
      return { 1: '#f87171', 2: '#fb923c', 3: '#facc15', 4: '#a3e635', 5: '#34d399' }[m] || '#94a3b8'
    }

    function addSub () {
      form.value.subCapabilities.push({ id: '', name: '' })
    }

    function addKpi () {
      form.value.kpis.push({ id: 'KPI-C-' + Date.now(), name: '', target: '', current: '', unit: '%', trend: 'stable' })
    }

    function save () {
      const data = { ...form.value }
      // Clean up sub-capabilities
      data.subCapabilities = data.subCapabilities.filter(s => s.name)
      data.kpis = data.kpis.filter(k => k.name)

      if (props.editCapability) {
        store.updateCapability(props.editCapability.id, data)
      } else {
        store.addCapability(props.domainId, data)
      }
      emit('saved')
    }

    return { store, form, matColor, addSub, addKpi, save }
  }
}


// ── AppForm (app-form.js) ──
// app-form.js — Modal form for creating/editing an application

const AppForm = {
  name: 'AppForm',
  props: { editApp: { type: Object, default: null } },
  emits: ['close', 'saved'],
  template: `
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" @click.self="$emit('close')">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-surface-200 flex items-center justify-between">
          <h3 class="text-base font-semibold text-gray-900">{{ editApp ? 'Edit Application' : 'New Application' }}</h3>
          <button @click="$emit('close')" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>
        <form @submit.prevent="save" class="px-6 py-4 space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="sm:col-span-2">
              <label class="block text-xs font-medium text-gray-600 mb-1">Name *</label>
              <input v-model="form.name" required class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Vendor</label>
              <input v-model="form.vendor" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Category</label>
              <input v-model="form.category" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" placeholder="e.g. ERP, CRM, MES" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Type</label>
              <select v-model="form.type" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-primary-300 outline-none">
                <option v-for="t in store.data.enums.appType" :key="t" :value="t">{{ t }}</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Criticality</label>
              <select v-model="form.criticality" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-primary-300 outline-none">
                <option v-for="c in store.data.enums.criticality" :key="c" :value="c">{{ c }}</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">TIME Quadrant</label>
              <select v-model="form.timeQuadrant" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-primary-300 outline-none">
                <option v-for="t in store.data.enums.timeQuadrant" :key="t" :value="t">{{ t }}</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Cost per Year (€)</label>
              <input v-model.number="form.costPerYear" type="number" min="0" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">User Count</label>
              <input v-model.number="form.userCount" type="number" min="0" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Business Owner</label>
              <input v-model="form.businessOwner" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">IT Owner</label>
              <input v-model="form.itOwner" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Go-Live Date</label>
              <input v-model="form.goLiveDate" type="date" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Business Value (1-10)</label>
              <input v-model.number="form.businessValue" type="number" min="1" max="10" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Technical Health (1-10)</label>
              <input v-model.number="form.technicalHealth" type="number" min="1" max="10" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div class="sm:col-span-2">
              <label class="block text-xs font-medium text-gray-600 mb-1">Description</label>
              <textarea v-model="form.description" rows="3" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none resize-vertical"></textarea>
            </div>
          </div>
          <div class="flex justify-end gap-3 pt-2">
            <button type="button" @click="$emit('close')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-surface-100">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm hover:bg-primary-700">{{ editApp ? 'Update' : 'Create' }}</button>
          </div>
        </form>
      </div>
    </div>
  `,
  setup (props, { emit }) {
    const { ref, onMounted } = Vue

    const defaultForm = () => ({
      name: '', vendor: '', category: '', type: 'On-Prem',
      criticality: 'Business-Operational', timeQuadrant: 'Tolerate',
      costPerYear: 0, userCount: 0, businessOwner: '', itOwner: '',
      goLiveDate: '', businessValue: 5, technicalHealth: 5, description: ''
    })

    const form = ref(defaultForm())

    onMounted(() => {
      if (props.editApp) {
        form.value = {
          ...defaultForm(),
          ...props.editApp,
          businessValue: props.editApp.scores?.businessValue || 5,
          technicalHealth: props.editApp.scores?.technicalHealth || 5
        }
      }
    })

    function save () {
      const data = { ...form.value, scores: { businessValue: form.value.businessValue, technicalHealth: form.value.technicalHealth } }
      delete data.businessValue
      delete data.technicalHealth
      if (props.editApp) {
        store.updateApp(props.editApp.id, data)
      } else {
        store.addApp(data)
      }
      emit('saved')
    }

    return { store, form, save }
  }
}


// ── ProjectForm (project-form.js) ──
// project-form.js — Modal for creating/editing a project

const ProjectForm = {
  name: 'ProjectForm',
  props: { editProject: { type: Object, default: null } },
  emits: ['close', 'saved'],
  template: `
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" @click.self="$emit('close')">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-surface-200 flex items-center justify-between">
          <h3 class="text-base font-semibold text-gray-900">{{ editProject ? 'Edit Project' : 'New Project' }}</h3>
          <button @click="$emit('close')" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>
        <form @submit.prevent="save" class="px-6 py-4 space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="sm:col-span-2">
              <label class="block text-xs font-medium text-gray-600 mb-1">Name *</label>
              <input v-model="form.name" required class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Category</label>
              <select v-model="form.category" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white">
                <option v-for="c in store.data.enums.projectCategory" :key="c" :value="c">{{ c }}</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Primary Domain</label>
              <select v-model.number="form.primaryDomain" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white">
                <option v-for="d in store.data.domains" :key="d.id" :value="d.id">{{ d.id }}. {{ d.name }}</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Budget (€)</label>
              <input v-model.number="form.budget" type="number" min="0" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Status</label>
              <select v-model="form.status" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white">
                <option value="green">🟢 Green</option>
                <option value="yellow">🟡 Yellow</option>
                <option value="red">🔴 Red</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Start (Quarter)</label>
              <input v-model="form.start" placeholder="Q1/2026" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">End (Quarter)</label>
              <input v-model="form.end" placeholder="Q4/2026" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Sponsor</label>
              <input v-model="form.sponsor" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Project Lead</label>
              <input v-model="form.projectLead" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
            </div>
            <div class="sm:col-span-2">
              <label class="block text-xs font-medium text-gray-600 mb-1">Status Text</label>
              <input v-model="form.statusText" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" placeholder="e.g. On track / Ressourcenengpass" />
            </div>
            <div class="sm:col-span-2">
              <label class="block text-xs font-medium text-gray-600 mb-1">Strategic Contribution</label>
              <textarea v-model="form.strategicContribution" rows="2" class="w-full px-3 py-2 border border-surface-200 rounded-lg text-sm resize-vertical focus:ring-2 focus:ring-primary-300 outline-none"></textarea>
            </div>
          </div>
          <div class="flex justify-end gap-3 pt-2">
            <button type="button" @click="$emit('close')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-surface-100">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm hover:bg-primary-700">{{ editProject ? 'Update' : 'Create' }}</button>
          </div>
        </form>
      </div>
    </div>
  `,
  setup (props, { emit }) {
    const { ref, onMounted } = Vue

    const defaultForm = () => ({
      name: '', category: 'Modernisierung', primaryDomain: 1, secondaryDomains: [],
      budget: 0, status: 'green', statusText: '', start: '', end: '',
      sponsor: '', projectLead: '', strategicContribution: '',
      capabilities: [], affectedApps: [], timeReference: 'Invest',
      e2eProcesses: [], conformity: 'Konform'
    })

    const form = ref(defaultForm())

    onMounted(() => {
      if (props.editProject) {
        form.value = { ...defaultForm(), ...props.editProject }
      }
    })

    function save () {
      if (props.editProject) {
        store.updateProject(props.editProject.id, { ...form.value })
      } else {
        store.addProject({ ...form.value })
      }
      emit('saved')
    }

    return { store, form, save }
  }
}


// ── ProcessForm (process-form.js) ──
// process-form.js — Modal for E2E Process CRUD

const ProcessForm = {
  name: 'ProcessForm',
  props: { editProcess: { type: Object, default: null } },
  emits: ['close', 'saved'],
  template: `
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" @click.self="$emit('close')">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 space-y-4">
        <h3 class="text-lg font-bold text-gray-900">{{ editProcess ? 'Edit Process' : 'New E2E Process' }}</h3>

        <!-- ID -->
        <div>
          <label class="text-xs font-medium text-gray-600">Process ID (e.g. O2C)</label>
          <input v-model="form.id" :disabled="!!editProcess" class="mt-1 w-full border border-surface-200 rounded-lg px-3 py-2 text-sm" placeholder="O2C" />
        </div>

        <!-- Name -->
        <div>
          <label class="text-xs font-medium text-gray-600">Name</label>
          <input v-model="form.name" class="mt-1 w-full border border-surface-200 rounded-lg px-3 py-2 text-sm" />
        </div>

        <!-- Owner -->
        <div>
          <label class="text-xs font-medium text-gray-600">Owner</label>
          <input v-model="form.owner" class="mt-1 w-full border border-surface-200 rounded-lg px-3 py-2 text-sm" />
        </div>

        <!-- Description -->
        <div>
          <label class="text-xs font-medium text-gray-600">Description</label>
          <textarea v-model="form.description" rows="2" class="mt-1 w-full border border-surface-200 rounded-lg px-3 py-2 text-sm"></textarea>
        </div>

        <!-- Status -->
        <div>
          <label class="text-xs font-medium text-gray-600">Status</label>
          <select v-model="form.status" class="mt-1 w-full border border-surface-200 rounded-lg px-3 py-2 text-sm">
            <option v-for="s in statusOptions" :key="s" :value="s">{{ s }}</option>
          </select>
        </div>

        <!-- Domain Multi-Select -->
        <div>
          <label class="text-xs font-medium text-gray-600">Linked Domains</label>
          <div class="mt-1 flex flex-wrap gap-2">
            <label v-for="d in store.data.domains" :key="d.id"
                   class="flex items-center gap-1.5 text-xs px-2 py-1 rounded border cursor-pointer"
                   :class="form.domains.includes(d.id) ? 'border-primary-400 bg-primary-50' : 'border-surface-200'">
              <input type="checkbox" :value="d.id" v-model="form.domains" class="sr-only" />
              <span class="w-4 h-4 rounded flex items-center justify-center text-white text-[8px] font-bold"
                    :style="{ backgroundColor: d.color }">{{ d.id }}</span>
              {{ d.name }}
            </label>
          </div>
        </div>

        <!-- KPIs -->
        <div>
          <div class="flex items-center justify-between">
            <label class="text-xs font-medium text-gray-600">Process KPIs</label>
            <button type="button" @click="addKpi" class="text-xs text-primary-600 hover:text-primary-800">+ Add KPI</button>
          </div>
          <div v-for="(kpi, i) in form.kpis" :key="i" class="mt-2 flex flex-wrap items-center gap-2">
            <input v-model="kpi.name" placeholder="Name" class="flex-1 border border-surface-200 rounded px-2 py-1 text-xs" />
            <input v-model="kpi.current" placeholder="Ist" class="w-14 border border-surface-200 rounded px-2 py-1 text-xs text-right" />
            <input v-model="kpi.target" placeholder="Soll" class="w-14 border border-surface-200 rounded px-2 py-1 text-xs text-right" />
            <input v-model="kpi.unit" placeholder="%" class="w-10 border border-surface-200 rounded px-2 py-1 text-xs" />
            <select v-model="kpi.trend" class="w-16 border border-surface-200 rounded px-1 py-1 text-xs">
              <option v-for="t in trendOptions" :key="t" :value="t">{{ t }}</option>
            </select>
            <button @click="form.kpis.splice(i, 1)" class="text-red-400 hover:text-red-600 text-xs">✕</button>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-3 pt-2">
          <button @click="$emit('close')" class="px-4 py-2 text-sm border border-surface-200 rounded-lg hover:bg-surface-50">Cancel</button>
          <button @click="save" :disabled="!form.id || !form.name" class="px-4 py-2 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-40">Save</button>
        </div>
      </div>
    </div>
  `,
  setup (props, { emit }) {
    const { ref, onMounted } = Vue
    const statusOptions = (store.data.enums?.processStatus || ['active', 'optimization', 'transformation'])
    const trendOptions = (store.data.enums?.kpiTrend || ['improving', 'stable', 'declining'])

    const form = ref({
      id: '', name: '', owner: '', description: '', status: 'active', domains: [], kpis: []
    })

    onMounted(() => {
      if (props.editProcess) {
        const p = props.editProcess
        form.value = {
          id: p.id,
          name: p.name,
          owner: p.owner || '',
          description: p.description || '',
          status: p.status || 'active',
          domains: [...(p.domains || [])],
          kpis: (p.kpis || []).map(k => ({ ...k }))
        }
      }
    })

    function addKpi () {
      const idx = form.value.kpis.length + 1
      form.value.kpis.push({ id: 'PKI-' + idx, name: '', current: '', target: '', unit: '%', trend: 'stable' })
    }

    function save () {
      const f = form.value
      const data = {
        id: f.id, name: f.name, owner: f.owner, description: f.description,
        status: f.status, domains: f.domains,
        kpis: f.kpis.map((k, i) => ({ ...k, id: k.id || ('PKI-' + (i + 1)), current: Number(k.current) || k.current, target: Number(k.target) || k.target }))
      }
      if (props.editProcess) {
        store.updateProcess(data.id, data)
      } else {
        store.addProcess(data)
      }
      emit('saved')
    }

    return { store, form, statusOptions, trendOptions, addKpi, save }
  }
}


// ── DashboardView (dashboard.js) ──
// dashboard.js — KPI cards, charts, quick stats

const DashboardView = {
  name: 'DashboardView',
  template: `
    <div class="space-y-6">
      <!-- KPI Cards Row -->
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <div v-for="kpi in kpis" :key="kpi.label"
             class="bg-white rounded-xl border border-surface-200 p-4 hover:shadow-md transition-shadow">
          <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">{{ kpi.label }}</div>
          <div class="mt-1 text-2xl font-bold" :style="{ color: kpi.color || '#1e293b' }">{{ kpi.value }}</div>
          <div v-if="kpi.sub" class="text-xs text-gray-400 mt-0.5">{{ kpi.sub }}</div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Management KPIs -->
        <div v-if="mgmtKpis.length" class="bg-white rounded-xl border border-surface-200 p-5 lg:col-span-2">
          <h3 class="text-sm font-semibold text-gray-700 mb-4">Management KPIs</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <div v-for="kpi in mgmtKpis" :key="kpi.id" class="border border-surface-200 rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-medium text-gray-700 line-clamp-1">{{ kpi.name }}</span>
                <span class="text-[10px] px-1.5 py-0.5 rounded-full"
                      :class="mgmtTrendClass(kpi.trend)">{{ mgmtTrendIcon(kpi.trend) }}</span>
              </div>
              <div class="flex items-baseline gap-1">
                <span class="text-xl font-bold" :style="{ color: mgmtKpiColor(kpi) }">{{ kpi.current }}</span>
                <span class="text-xs text-gray-400">/ {{ kpi.target }} {{ kpi.unit }}</span>
              </div>
              <div class="mt-2 w-full h-1.5 bg-surface-100 rounded-full overflow-hidden">
                <div class="h-full rounded-full" :style="{ width: mgmtKpiPct(kpi) + '%', backgroundColor: mgmtKpiColor(kpi) }"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- TIME Distribution Pie -->
        <div class="bg-white rounded-xl border border-surface-200 p-5">
          <h3 class="text-sm font-semibold text-gray-700 mb-4">TIME Distribution</h3>
          <div class="h-64 flex items-center justify-center">
            <canvas ref="timeChartCanvas"></canvas>
          </div>
        </div>

        <!-- Maturity by Domain Bar -->
        <div class="bg-white rounded-xl border border-surface-200 p-5">
          <h3 class="text-sm font-semibold text-gray-700 mb-4">Avg Maturity by Domain</h3>
          <div class="h-64">
            <canvas ref="maturityChartCanvas"></canvas>
          </div>
        </div>
      </div>

      <!-- Second Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Project Status -->
        <div class="bg-white rounded-xl border border-surface-200 p-5">
          <h3 class="text-sm font-semibold text-gray-700 mb-4">Project Status Overview</h3>
          <div class="h-48">
            <canvas ref="projectStatusCanvas"></canvas>
          </div>
        </div>

        <!-- Project Budget by Category -->
        <div class="bg-white rounded-xl border border-surface-200 p-5">
          <h3 class="text-sm font-semibold text-gray-700 mb-4">Budget by Category</h3>
          <div class="h-48">
            <canvas ref="budgetChartCanvas"></canvas>
          </div>
        </div>
      </div>

      <!-- Quick Lists -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Eliminate Apps -->
        <div class="bg-white rounded-xl border border-surface-200 p-5">
          <h3 class="text-sm font-semibold text-gray-700 mb-3">
            <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 mr-2"></span>
            Applications to Eliminate
          </h3>
          <div v-if="eliminateApps.length === 0" class="text-sm text-gray-400 italic">None</div>
          <div v-for="app in eliminateApps" :key="app.id" class="flex items-center justify-between py-2 border-b border-surface-100 last:border-0">
            <a :href="linkTo('/apps/' + app.id)" class="text-sm text-primary-600 hover:underline">{{ app.name }}</a>
            <span class="text-xs text-gray-400">{{ app.category }}</span>
          </div>
        </div>

        <!-- Yellow/Red Projects -->
        <div class="bg-white rounded-xl border border-surface-200 p-5">
          <h3 class="text-sm font-semibold text-gray-700 mb-3">
            <span class="inline-block w-2.5 h-2.5 rounded-full bg-yellow-500 mr-2"></span>
            Projects Needing Attention
          </h3>
          <div v-if="attentionProjects.length === 0" class="text-sm text-gray-400 italic">All green</div>
          <div v-for="p in attentionProjects" :key="p.id" class="flex items-center justify-between py-2 border-b border-surface-100 last:border-0">
            <a :href="linkTo('/projects/' + p.id)" class="text-sm text-primary-600 hover:underline">{{ p.name }}</a>
            <span class="text-xs px-2 py-0.5 rounded-full"
                  :class="p.status === 'red' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'">
              {{ p.statusText }}
            </span>
          </div>
        </div>
      </div>
    </div>
  `,
  setup () {
    const { ref, computed, onMounted, nextTick } = Vue

    const timeChartCanvas = ref(null)
    const maturityChartCanvas = ref(null)
    const projectStatusCanvas = ref(null)
    const budgetChartCanvas = ref(null)

    const kpis = computed(() => [
      { label: 'Domains', value: store.data.domains.length, color: '#3b82f6' },
      { label: 'Capabilities', value: store.totalCapabilities, sub: store.totalSubCapabilities + ' L2' },
      { label: 'Applications', value: store.totalApps },
      { label: 'Projects', value: store.totalProjects },
      { label: 'Avg Maturity', value: store.avgMaturity + '/5', color: store.avgMaturity >= 3 ? '#10b981' : '#f59e0b' },
      { label: 'Total Budget', value: '€' + (store.totalBudget / 1000).toFixed(0) + 'k', color: '#6366f1' }
    ])

    const eliminateApps = computed(() =>
      store.data.applications.filter(a => a.timeQuadrant === 'Eliminate')
    )

    const mgmtKpis = computed(() => store.data.managementKPIs || [])

    function mgmtTrendClass (t) {
      return { improving: 'bg-green-100 text-green-700', stable: 'bg-gray-100 text-gray-600', declining: 'bg-red-100 text-red-700' }[t] || 'bg-gray-100 text-gray-600'
    }
    function mgmtTrendIcon (t) { return { improving: '↑', stable: '→', declining: '↓' }[t] || '→' }
    function mgmtKpiPct (kpi) { const c = parseFloat(kpi.current) || 0; const t = parseFloat(kpi.target) || 1; return Math.min(100, (c / t) * 100) }
    function mgmtKpiColor (kpi) { const p = mgmtKpiPct(kpi); if (p >= 80) return '#10b981'; if (p >= 50) return '#f59e0b'; return '#ef4444' }

    const attentionProjects = computed(() =>
      store.data.projects.filter(p => p.status === 'yellow' || p.status === 'red')
    )

    function renderCharts () {
      // TIME Pie
      if (timeChartCanvas.value) {
        const dist = store.timeDistribution
        new Chart(timeChartCanvas.value, {
          type: 'doughnut',
          data: {
            labels: Object.keys(dist),
            datasets: [{
              data: Object.values(dist),
              backgroundColor: ['#f59e0b', '#10b981', '#3b82f6', '#ef4444']
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: window.innerWidth < 640 ? 'bottom' : 'right', labels: { usePointStyle: true, padding: 16 } } }
          }
        })
      }

      // Maturity Bar
      if (maturityChartCanvas.value) {
        const domains = store.data.domains
        const labels = domains.map(d => d.name.length > 18 ? d.name.slice(0, 18) + '…' : d.name)
        const data = domains.map(d => {
          const caps = d.capabilities
          return caps.length ? +(caps.reduce((s, c) => s + c.maturity, 0) / caps.length).toFixed(1) : 0
        })
        new Chart(maturityChartCanvas.value, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              data,
              backgroundColor: domains.map(d => d.color + 'CC'),
              borderColor: domains.map(d => d.color),
              borderWidth: 1,
              borderRadius: 4
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            scales: { x: { min: 0, max: 5, ticks: { stepSize: 1 } } },
            plugins: { legend: { display: false } }
          }
        })
      }

      // Project Status Doughnut
      if (projectStatusCanvas.value) {
        const sc = store.projectStatusCounts
        new Chart(projectStatusCanvas.value, {
          type: 'doughnut',
          data: {
            labels: ['Green', 'Yellow', 'Red'],
            datasets: [{
              data: [sc.green, sc.yellow, sc.red],
              backgroundColor: ['#22c55e', '#eab308', '#ef4444']
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: window.innerWidth < 640 ? 'bottom' : 'right', labels: { usePointStyle: true, padding: 16 } } }
          }
        })
      }

      // Budget by Category Bar
      if (budgetChartCanvas.value) {
        const cats = {}
        store.data.projects.forEach(p => {
          cats[p.category] = (cats[p.category] || 0) + (p.budget || 0)
        })
        const colors = { 'Run / Pflicht': '#64748b', 'Modernisierung': '#3b82f6', 'Optimierung': '#10b981', 'Innovation / Grow': '#8b5cf6', 'Infrastruktur': '#f97316' }
        new Chart(budgetChartCanvas.value, {
          type: 'bar',
          data: {
            labels: Object.keys(cats),
            datasets: [{
              data: Object.values(cats).map(v => v / 1000),
              backgroundColor: Object.keys(cats).map(k => colors[k] || '#94a3b8'),
              borderRadius: 4
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { callback: v => '€' + v + 'k' } } },
            plugins: { legend: { display: false } }
          }
        })
      }
    }

    onMounted(() => { nextTick(renderCharts) })

    return { store, linkTo, kpis, eliminateApps, attentionProjects, mgmtKpis, mgmtTrendClass, mgmtTrendIcon, mgmtKpiPct, mgmtKpiColor, timeChartCanvas, maturityChartCanvas, projectStatusCanvas, budgetChartCanvas }
  }
}


// ── SettingsView (settings.js) ──
// settings.js — Import/export JSON, reset to seed data

const SettingsView = {
  name: 'SettingsView',
  template: `
    <div class="max-w-2xl space-y-8">
      <!-- Data Management -->
      <section class="bg-white rounded-xl border border-surface-200 p-6">
        <h2 class="text-base font-semibold text-gray-800 mb-4">Data Management</h2>
        <div class="space-y-4">
          <!-- Export -->
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium text-gray-700">Export Data</div>
              <div class="text-xs text-gray-500">Download the entire dataset as a JSON file</div>
            </div>
            <button @click="doExport"
                    class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm hover:bg-primary-700 transition-colors">
              Export JSON
            </button>
          </div>

          <!-- Import -->
          <div class="flex items-center justify-between border-t border-surface-100 pt-4">
            <div>
              <div class="text-sm font-medium text-gray-700">Import Data</div>
              <div class="text-xs text-gray-500">Replace current data with a JSON file</div>
            </div>
            <label class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-surface-100 cursor-pointer transition-colors">
              Import JSON
              <input type="file" accept=".json" @change="doImport" class="hidden" />
            </label>
          </div>

          <!-- Reset -->
          <div class="flex items-center justify-between border-t border-surface-100 pt-4">
            <div>
              <div class="text-sm font-medium text-red-600">Reset to Seed Data</div>
              <div class="text-xs text-gray-500">Discard all changes and reload the original dataset</div>
            </div>
            <button @click="confirmReset"
                    class="px-4 py-2 border border-red-300 text-red-600 rounded-lg text-sm hover:bg-red-50 transition-colors">
              Reset
            </button>
          </div>
        </div>
      </section>

      <!-- Data Statistics -->
      <section class="bg-white rounded-xl border border-surface-200 p-6">
        <h2 class="text-base font-semibold text-gray-800 mb-4">Data Statistics</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
          <div v-for="stat in stats" :key="stat.label" class="flex justify-between py-1">
            <span class="text-gray-500">{{ stat.label }}</span>
            <span class="font-medium text-gray-800">{{ stat.value }}</span>
          </div>
        </div>
      </section>

      <!-- About -->
      <section class="bg-white rounded-xl border border-surface-200 p-6">
        <h2 class="text-base font-semibold text-gray-800 mb-3">About</h2>
        <div class="text-sm text-gray-600 space-y-1">
          <p><strong>Version:</strong> {{ store.data.meta.version }}</p>
          <p><strong>Company:</strong> {{ store.data.meta.company }}</p>
          <p><strong>Owner:</strong> {{ store.data.meta.owner }}</p>
          <p><strong>Last Updated:</strong> {{ store.data.meta.lastUpdated }}</p>
        </div>
        <div class="mt-4 text-xs text-gray-400">
          Built with Vue 3, Tailwind CSS, Chart.js, D3.js. Data stored in localStorage.
        </div>
      </section>

      <!-- Toast -->
      <div v-if="toast" class="fixed bottom-6 right-6 px-4 py-3 rounded-lg shadow-lg text-sm text-white z-50 transition-opacity"
           :class="toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'">
        {{ toast.message }}
      </div>
    </div>
  `,
  setup () {
    const { ref, computed } = Vue
    const toast = ref(null)

    function showToast (message, type = 'success') {
      toast.value = { message, type }
      setTimeout(() => { toast.value = null }, 3000)
    }

    const stats = computed(() => [
      { label: 'Domains', value: store.data.domains.length },
      { label: 'L1 Capabilities', value: store.totalCapabilities },
      { label: 'L2 Sub-Capabilities', value: store.totalSubCapabilities },
      { label: 'Applications', value: store.totalApps },
      { label: 'Capability Mappings', value: store.data.capabilityMappings.length },
      { label: 'Projects', value: store.totalProjects },
      { label: 'Dependencies', value: store.data.projectDependencies.length },
      { label: 'localStorage Size', value: (() => {
        const s = localStorage.getItem('ea-bebauungsplan-v1')
        return s ? (s.length / 1024).toFixed(1) + ' KB' : '—'
      })() }
    ])

    function doExport () {
      exportJSON()
      showToast('Data exported successfully')
    }

    async function doImport (e) {
      const file = e.target.files[0]
      if (!file) return
      try {
        await importJSON(file)
        showToast('Data imported successfully')
      } catch (err) {
        showToast('Import failed: ' + err.message, 'error')
      }
      e.target.value = ''
    }

    function confirmReset () {
      if (confirm('Are you sure? This will discard all changes and reload the original seed data.')) {
        resetToSeed().then(() => showToast('Reset to seed data'))
      }
    }

    return { store, stats, toast, doExport, doImport, confirmReset }
  }
}


// ── DomainList (domain-list.js) ──
// domain-list.js — Grid of all capability domains with strategy info

const DomainList = {
  name: 'DomainList',
  template: `
    <div class="space-y-6">
      <!-- Header with Add button -->
      <div class="flex items-center justify-between">
        <div></div>
        <button @click="showDomainForm = true" class="px-4 py-2 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700">+ Add Domain</button>
      </div>

      <!-- Domain Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
        <a v-for="domain in store.data.domains" :key="domain.id"
           :href="linkTo('/domains/' + domain.id)"
           class="bg-white rounded-xl border border-surface-200 p-5 hover:shadow-lg transition-all group">
          <!-- Domain Header -->
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white text-sm font-bold"
                 :style="{ backgroundColor: domain.color }">
              {{ domain.id }}
            </div>
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold text-gray-900 truncate group-hover:text-primary-600">{{ domain.name }}</div>
              <div class="text-xs text-gray-400">{{ domain.capabilities.length }} capabilities</div>
            </div>
          </div>

          <!-- Owner badge -->
          <div v-if="domain.domainOwner" class="mb-2">
            <span class="text-[10px] px-2 py-0.5 rounded-full bg-surface-100 text-gray-500">{{ domain.domainOwner }}</span>
          </div>

          <!-- Maturity Overview -->
          <div class="space-y-1.5 mb-3">
            <div v-for="cap in domain.capabilities" :key="cap.id" class="flex items-center gap-2">
              <span class="text-[10px] text-gray-500 w-7 shrink-0">{{ cap.id }}</span>
              <span class="text-xs text-gray-600 flex-1 truncate">{{ cap.name }}</span>
              <div class="w-16 h-1.5 bg-surface-100 rounded-full shrink-0 overflow-hidden relative">
                <div class="maturity-bar" :style="{ width: (cap.maturity / 5 * 100) + '%', backgroundColor: maturityColor(cap.maturity) }"></div>
              </div>
              <span class="text-[10px] text-gray-400 w-3 text-right">{{ cap.maturity }}</span>
            </div>
          </div>

          <!-- Stats Row -->
          <div class="flex items-center justify-between text-xs text-gray-400 pt-2 border-t border-surface-100">
            <span>Ist: {{ avgMaturity(domain) }}/5</span>
            <span v-if="avgGap(domain) > 0" class="text-indigo-500 font-medium">Gap: {{ avgGap(domain) }}</span>
            <span>{{ appCount(domain) }} apps</span>
          </div>
        </a>
      </div>

      <!-- Legend -->
      <div class="flex flex-wrap items-center gap-4 sm:gap-6 text-xs text-gray-500">
        <span class="font-medium">Maturity:</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-red-400"></span> 1 Initial</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-orange-400"></span> 2 Managed</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-yellow-400"></span> 3 Defined</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-lime-500"></span> 4 Measured</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-500"></span> 5 Optimized</span>
      </div>

      <!-- Add Domain Modal -->
      <domain-form v-if="showDomainForm" @close="showDomainForm = false" @saved="showDomainForm = false" />
    </div>
  `,
  setup () {
    const { ref } = Vue
    const showDomainForm = ref(false)

    function maturityColor (m) {
      const colors = { 1: '#f87171', 2: '#fb923c', 3: '#facc15', 4: '#a3e635', 5: '#34d399' }
      return colors[m] || '#94a3b8'
    }

    function avgMaturity (domain) {
      const caps = domain.capabilities
      if (!caps.length) return 0
      return (caps.reduce((s, c) => s + c.maturity, 0) / caps.length).toFixed(1)
    }

    function avgGap (domain) {
      const caps = domain.capabilities
      if (!caps.length) return 0
      const gapSum = caps.reduce((s, c) => s + ((c.targetMaturity || c.maturity) - c.maturity), 0)
      return (gapSum / caps.length).toFixed(1)
    }

    function appCount (domain) {
      const capIds = domain.capabilities.map(c => c.id)
      const appIds = new Set(
        store.data.capabilityMappings
          .filter(m => capIds.includes(m.capabilityId))
          .map(m => m.applicationId)
      )
      return appIds.size
    }

    return { store, linkTo, showDomainForm, maturityColor, avgMaturity, avgGap, appCount }
  }
}


// ── DomainDetail (domain-detail.js) ──
// domain-detail.js — Domain drill-down: strategy, KPIs, capabilities with Ist/Soll, mapped apps, projects

const DomainDetail = {
  name: 'DomainDetail',
  template: `
    <div v-if="domain" class="space-y-6">
      <!-- Back link -->
      <div class="flex items-center gap-4">
        <a :href="linkTo('/domains')" class="text-sm text-gray-500 hover:text-primary-600">← Domains</a>
      </div>

      <!-- Header -->
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-xl flex items-center justify-center text-white text-xl font-bold"
               :style="{ backgroundColor: domain.color }">
            {{ domain.id }}
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">{{ domain.name }}</h2>
            <p class="text-sm text-gray-500">{{ domain.description }}</p>
            <div v-if="domain.domainOwner" class="mt-1 flex items-center gap-2">
              <span class="text-xs px-2 py-0.5 rounded-full bg-surface-100 text-gray-600">Owner: {{ domain.domainOwner }}</span>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <button @click="showDomainForm = true" class="px-3 py-1.5 text-xs bg-primary-600 text-white rounded-lg hover:bg-primary-700">Edit Domain</button>
          <button @click="deleteDomain" class="px-3 py-1.5 text-xs border border-red-300 text-red-600 rounded-lg hover:bg-red-50">Delete</button>
        </div>
      </div>

      <!-- Stats Row -->
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4">
        <div class="bg-white rounded-xl border border-surface-200 p-4 text-center">
          <div class="text-2xl font-bold" :style="{ color: domain.color }">{{ domain.capabilities.length }}</div>
          <div class="text-xs text-gray-500">Capabilities</div>
        </div>
        <div class="bg-white rounded-xl border border-surface-200 p-4 text-center">
          <div class="text-2xl font-bold text-gray-700">{{ subCapCount }}</div>
          <div class="text-xs text-gray-500">Sub-Capabilities</div>
        </div>
        <div class="bg-white rounded-xl border border-surface-200 p-4 text-center">
          <div class="text-2xl font-bold" :style="{ color: avgMat >= 3 ? '#10b981' : '#f59e0b' }">{{ avgMat }}/5</div>
          <div class="text-xs text-gray-500">Avg Maturity (Ist)</div>
        </div>
        <div class="bg-white rounded-xl border border-surface-200 p-4 text-center">
          <div class="text-2xl font-bold text-indigo-600">{{ avgTarget }}/5</div>
          <div class="text-xs text-gray-500">Avg Target (Soll)</div>
        </div>
        <div class="bg-white rounded-xl border border-surface-200 p-4 text-center">
          <div class="text-2xl font-bold text-primary-600">{{ mappedAppIds.size }}</div>
          <div class="text-xs text-gray-500">Mapped Apps</div>
        </div>
      </div>

      <!-- Strategy & Vision -->
      <div v-if="domain.strategicFocus || domain.vision" class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Strategy & Vision</h3>
        </div>
        <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div v-if="domain.strategicFocus">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Strategic Focus</div>
            <p class="text-sm text-gray-800">{{ domain.strategicFocus }}</p>
          </div>
          <div v-if="domain.vision">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Vision</div>
            <p class="text-sm text-gray-800">{{ domain.vision }}</p>
          </div>
        </div>
      </div>

      <!-- Domain KPIs -->
      <div v-if="domain.kpis && domain.kpis.length" class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Domain KPIs</h3>
        </div>
        <div class="p-5 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <div v-for="kpi in domain.kpis" :key="kpi.id" class="border border-surface-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-medium text-gray-700">{{ kpi.name }}</span>
              <span class="text-[10px] px-1.5 py-0.5 rounded-full"
                    :class="trendClass(kpi.trend)">
                {{ trendIcon(kpi.trend) }}
              </span>
            </div>
            <div class="flex items-baseline gap-2">
              <span class="text-2xl font-bold" :style="{ color: kpiColor(kpi) }">{{ kpi.current }}</span>
              <span class="text-xs text-gray-400">/ {{ kpi.target }} {{ kpi.unit }}</span>
            </div>
            <div class="mt-2 w-full h-1.5 bg-surface-100 rounded-full overflow-hidden">
              <div class="h-full rounded-full transition-all" :style="{ width: kpiProgress(kpi) + '%', backgroundColor: kpiColor(kpi) }"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Capabilities Table with Ist/Soll -->
      <div class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50 flex items-center justify-between">
          <h3 class="text-sm font-semibold text-gray-700">Capabilities</h3>
          <button @click="showCapForm = true; editCap = null" class="text-xs text-primary-600 hover:text-primary-800 font-medium">+ Add Capability</button>
        </div>
        <div class="divide-y divide-surface-100">
          <div v-for="cap in domain.capabilities" :key="cap.id" class="p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-3">
                <span class="text-xs font-mono text-gray-500 bg-surface-100 px-2 py-0.5 rounded">{{ cap.id }}</span>
                <span class="text-sm font-medium text-gray-800">{{ cap.name }}</span>
                <span class="text-[10px] px-2 py-0.5 rounded-full"
                      :class="criticalityClass(cap.criticality)">{{ cap.criticality }}</span>
              </div>
              <div class="flex items-center gap-2">
                <button @click="editCap = cap; showCapForm = true" class="text-xs text-gray-400 hover:text-primary-600">Edit</button>
                <button @click="deleteCap(cap)" class="text-xs text-gray-400 hover:text-red-500">Delete</button>
              </div>
            </div>

            <!-- Ist/Soll double bar -->
            <div class="flex items-center gap-3 mb-2 ml-12">
              <div class="flex-1 relative">
                <div class="w-full h-2 bg-surface-100 rounded-full overflow-hidden">
                  <div class="maturity-bar h-full rounded-full" :style="{ width: (cap.maturity / 5 * 100) + '%', backgroundColor: maturityColor(cap.maturity) }"></div>
                </div>
                <div v-if="cap.targetMaturity && cap.targetMaturity !== cap.maturity"
                     class="absolute top-0 h-2 border-r-2 border-dashed border-indigo-500"
                     :style="{ left: (cap.targetMaturity / 5 * 100) + '%' }"></div>
              </div>
              <span class="text-xs text-gray-500 w-14 text-right">{{ cap.maturity }}/{{ cap.targetMaturity || cap.maturity }}</span>
              <button @click="adjustMaturity(cap, -1)" class="w-8 h-8 sm:w-5 sm:h-5 rounded text-xs bg-surface-100 hover:bg-surface-200 text-gray-500 flex items-center justify-center" :disabled="cap.maturity <= 1">−</button>
              <button @click="adjustMaturity(cap, 1)" class="w-8 h-8 sm:w-5 sm:h-5 rounded text-xs bg-surface-100 hover:bg-surface-200 text-gray-500 flex items-center justify-center" :disabled="cap.maturity >= 5">+</button>
            </div>

            <!-- Sub-capabilities -->
            <div v-if="cap.subCapabilities && cap.subCapabilities.length" class="ml-12 mt-1 flex flex-wrap gap-1.5">
              <span v-for="sub in cap.subCapabilities" :key="sub.id"
                    class="text-[10px] px-2 py-0.5 bg-surface-100 text-gray-600 rounded">
                {{ sub.id }} {{ sub.name }}
              </span>
            </div>

            <!-- Capability KPIs -->
            <div v-if="cap.kpis && cap.kpis.length" class="ml-12 mt-2 flex flex-wrap gap-3">
              <div v-for="kpi in cap.kpis" :key="kpi.id" class="text-[10px] px-2 py-1 border border-surface-200 rounded bg-white">
                <span class="font-medium">{{ kpi.name }}:</span>
                <span :style="{ color: kpiColor(kpi) }"> {{ kpi.current }}</span> / {{ kpi.target }} {{ kpi.unit }}
              </div>
            </div>

            <!-- Mapped Applications -->
            <div v-if="appsForCap(cap.id).length" class="ml-12 mt-2 flex flex-wrap gap-1.5">
              <a v-for="app in appsForCap(cap.id)" :key="app.id"
                 :href="linkTo('/apps/' + app.id)"
                 class="text-[10px] px-2 py-0.5 rounded border hover:bg-primary-50 transition-colors"
                 :class="app.role === 'Primary' ? 'border-primary-300 text-primary-700 bg-primary-50' : 'border-gray-300 text-gray-600'">
                {{ app.name }} ({{ app.role }})
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- E2E Processes for this domain -->
      <div v-if="relatedProcesses.length" class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Related E2E Processes</h3>
        </div>
        <div class="divide-y divide-surface-100">
          <a v-for="proc in relatedProcesses" :key="proc.id" :href="linkTo('/processes/' + proc.id)"
             class="flex items-center justify-between px-5 py-3 hover:bg-surface-50 transition-colors">
            <div class="flex items-center gap-3">
              <span class="text-xs font-mono text-gray-500 bg-surface-100 px-2 py-0.5 rounded">{{ proc.id }}</span>
              <span class="text-sm text-gray-800">{{ proc.name }}</span>
            </div>
            <div class="flex items-center gap-3 text-xs text-gray-400">
              <span class="px-2 py-0.5 rounded-full"
                    :class="procStatusClass(proc.status)">{{ proc.status }}</span>
              <span>{{ proc.kpis ? proc.kpis.length : 0 }} KPIs</span>
            </div>
          </a>
        </div>
      </div>

      <!-- Related Projects -->
      <div v-if="relatedProjects.length" class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Related Projects</h3>
        </div>
        <div class="divide-y divide-surface-100">
          <a v-for="p in relatedProjects" :key="p.id" :href="linkTo('/projects/' + p.id)"
             class="flex items-center justify-between px-5 py-3 hover:bg-surface-50 transition-colors">
            <div class="flex items-center gap-3">
              <span class="w-2.5 h-2.5 rounded-full" :class="statusDot(p.status)"></span>
              <span class="text-sm text-gray-800">{{ p.name }}</span>
            </div>
            <div class="flex items-center gap-4 text-xs text-gray-400">
              <span>{{ p.category }}</span>
              <span>€{{ (p.budget / 1000).toFixed(0) }}k</span>
            </div>
          </a>
        </div>
      </div>

      <!-- Modals -->
      <domain-form v-if="showDomainForm" :edit-domain="domain" @close="showDomainForm = false" @saved="showDomainForm = false" />
      <capability-form v-if="showCapForm" :edit-capability="editCap" :domain-id="domain.id" @close="showCapForm = false; editCap = null" @saved="showCapForm = false; editCap = null" />
    </div>
    <div v-else class="text-center py-12 text-gray-500">Domain not found.</div>
  `,
  setup () {
    const { ref, computed } = Vue

    const showDomainForm = ref(false)
    const showCapForm = ref(false)
    const editCap = ref(null)

    const domain = computed(() => store.domainById(router.params.id))

    const subCapCount = computed(() => {
      if (!domain.value) return 0
      return domain.value.capabilities.reduce((n, c) => n + (c.subCapabilities ? c.subCapabilities.length : 0), 0)
    })

    const avgMat = computed(() => {
      if (!domain.value) return 0
      const caps = domain.value.capabilities
      return caps.length ? (caps.reduce((s, c) => s + c.maturity, 0) / caps.length).toFixed(1) : 0
    })

    const avgTarget = computed(() => {
      if (!domain.value) return 0
      const caps = domain.value.capabilities
      return caps.length ? (caps.reduce((s, c) => s + (c.targetMaturity || c.maturity), 0) / caps.length).toFixed(1) : 0
    })

    const mappedAppIds = computed(() => {
      if (!domain.value) return new Set()
      const capIds = domain.value.capabilities.map(c => c.id)
      return new Set(store.data.capabilityMappings.filter(m => capIds.includes(m.capabilityId)).map(m => m.applicationId))
    })

    function appsForCap (capId) { return store.appsForCapability(capId) }

    const relatedProjects = computed(() => {
      if (!domain.value) return []
      return store.projectsForDomain(domain.value.id)
    })

    const relatedProcesses = computed(() => {
      if (!domain.value) return []
      return store.processesForDomain(domain.value.id)
    })

    function maturityColor (m) {
      return { 1: '#f87171', 2: '#fb923c', 3: '#facc15', 4: '#a3e635', 5: '#34d399' }[m] || '#94a3b8'
    }

    function criticalityClass (c) {
      return { 'High': 'bg-red-100 text-red-700', 'Medium': 'bg-yellow-100 text-yellow-700', 'Low': 'bg-green-100 text-green-700' }[c] || 'bg-gray-100 text-gray-600'
    }

    function statusDot (s) {
      return { green: 'bg-green-500', yellow: 'bg-yellow-500', red: 'bg-red-500' }[s] || 'bg-gray-400'
    }

    function procStatusClass (s) {
      return { active: 'bg-green-100 text-green-700', optimization: 'bg-blue-100 text-blue-700', transformation: 'bg-purple-100 text-purple-700' }[s] || 'bg-gray-100 text-gray-600'
    }

    function trendClass (t) {
      return { improving: 'bg-green-100 text-green-700', stable: 'bg-gray-100 text-gray-600', declining: 'bg-red-100 text-red-700' }[t] || 'bg-gray-100 text-gray-600'
    }
    function trendIcon (t) {
      return { improving: '↑', stable: '→', declining: '↓' }[t] || '→'
    }

    function kpiProgress (kpi) {
      const c = parseFloat(kpi.current) || 0
      const t = parseFloat(kpi.target) || 1
      return Math.min(100, (c / t) * 100)
    }
    function kpiColor (kpi) {
      const pct = kpiProgress(kpi)
      if (pct >= 80) return '#10b981'
      if (pct >= 50) return '#f59e0b'
      return '#ef4444'
    }

    function adjustMaturity (cap, delta) {
      const newVal = cap.maturity + delta
      if (newVal >= 1 && newVal <= 5) cap.maturity = newVal
    }

    function deleteCap (cap) {
      if (confirm('Delete capability "' + cap.name + '"? Removes all mappings.')) {
        store.deleteCapability(cap.id)
      }
    }

    function deleteDomain () {
      if (!domain.value) return
      if (confirm('Delete domain "' + domain.value.name + '"? Removes all capabilities, mappings, and references.')) {
        store.deleteDomain(domain.value.id)
        navigateTo('/domains')
      }
    }

    return {
      store, domain, router, linkTo, showDomainForm, showCapForm, editCap,
      subCapCount, avgMat, avgTarget, mappedAppIds, appsForCap,
      relatedProjects, relatedProcesses,
      maturityColor, criticalityClass, statusDot, procStatusClass,
      trendClass, trendIcon, kpiProgress, kpiColor,
      adjustMaturity, deleteCap, deleteDomain
    }
  }
}


// ── AppList (app-list.js) ──
// app-list.js — Application table with sort/filter

const AppList = {
  name: 'AppList',
  template: `
    <div class="space-y-4">
      <!-- Toolbar -->
      <div class="flex flex-wrap items-center gap-3">
        <input v-model="search" type="text" placeholder="Search applications…"
               class="flex-1 min-w-[200px] px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 focus:border-primary-400 outline-none" />
        <select v-model="filterTime" class="px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white">
          <option value="">All TIME</option>
          <option v-for="t in ['Invest','Tolerate','Migrate','Eliminate']" :key="t" :value="t">{{ t }}</option>
        </select>
        <select v-model="filterCrit" class="px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white">
          <option value="">All Criticality</option>
          <option v-for="c in ['Mission-Critical','Business-Critical','Business-Operational','Administrative']" :key="c" :value="c">{{ c }}</option>
        </select>
        <button @click="showForm = true"
                class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm hover:bg-primary-700 transition-colors whitespace-nowrap">
          + Add Application
        </button>
      </div>

      <!-- Count -->
      <div class="text-xs text-gray-500">{{ filtered.length }} of {{ store.totalApps }} applications</div>

      <!-- Table -->
      <div class="bg-white rounded-xl border border-surface-200 overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-surface-200 bg-surface-50">
              <th class="text-left px-4 py-3 font-medium text-gray-600 cursor-pointer hover:text-gray-900" @click="toggleSort('name')">Name {{ sortIcon('name') }}</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600 hidden md:table-cell">Category</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600 cursor-pointer hover:text-gray-900" @click="toggleSort('criticality')">Criticality {{ sortIcon('criticality') }}</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600 cursor-pointer hover:text-gray-900" @click="toggleSort('timeQuadrant')">TIME {{ sortIcon('timeQuadrant') }}</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600 hidden md:table-cell">Type</th>
              <th class="text-right px-4 py-3 font-medium text-gray-600 cursor-pointer hover:text-gray-900 hidden md:table-cell" @click="toggleSort('costPerYear')">Cost/yr {{ sortIcon('costPerYear') }}</th>
              <th class="text-right px-4 py-3 font-medium text-gray-600 hidden lg:table-cell">Users</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-surface-100">
            <tr v-for="app in filtered" :key="app.id"
                class="hover:bg-surface-50 cursor-pointer transition-colors"
                @click="navigateTo('/apps/' + app.id)">
              <td class="px-4 py-3">
                <div class="font-medium text-gray-900">{{ app.name }}</div>
                <div class="text-xs text-gray-400">{{ app.vendor }}</div>
              </td>
              <td class="px-4 py-3 text-gray-600 hidden md:table-cell">{{ app.category }}</td>
              <td class="px-4 py-3">
                <span class="text-xs px-2 py-0.5 rounded-full" :class="critClass(app.criticality)">{{ app.criticality }}</span>
              </td>
              <td class="px-4 py-3">
                <span class="text-xs px-2 py-0.5 rounded-full" :class="timeClass(app.timeQuadrant)">{{ app.timeQuadrant }}</span>
              </td>
              <td class="px-4 py-3 text-gray-600 hidden md:table-cell">{{ app.type }}</td>
              <td class="px-4 py-3 text-right text-gray-700 font-mono hidden md:table-cell">{{ app.costPerYear > 0 ? '€' + app.costPerYear.toLocaleString() : '—' }}</td>
              <td class="px-4 py-3 text-right text-gray-600 hidden lg:table-cell">{{ app.userCount }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Total -->
      <div class="flex justify-end text-sm text-gray-500">
        Total annual cost: <strong class="ml-1 text-gray-800">€{{ totalCost.toLocaleString() }}</strong>
      </div>

      <!-- App Form Modal -->
      <app-form v-if="showForm" @close="showForm = false" @saved="onSaved"></app-form>
    </div>
  `,
  setup () {
    const { ref, computed } = Vue
    const search = ref('')
    const filterTime = ref('')
    const filterCrit = ref('')
    const sortBy = ref('name')
    const sortDir = ref(1)
    const showForm = ref(false)

    function toggleSort (field) {
      if (sortBy.value === field) sortDir.value *= -1
      else { sortBy.value = field; sortDir.value = 1 }
    }
    function sortIcon (field) {
      if (sortBy.value !== field) return ''
      return sortDir.value === 1 ? '↑' : '↓'
    }

    const filtered = computed(() => {
      let list = [...store.data.applications]
      const q = search.value.toLowerCase()
      if (q) list = list.filter(a => a.name.toLowerCase().includes(q) || a.vendor.toLowerCase().includes(q) || a.category.toLowerCase().includes(q))
      if (filterTime.value) list = list.filter(a => a.timeQuadrant === filterTime.value)
      if (filterCrit.value) list = list.filter(a => a.criticality === filterCrit.value)
      list.sort((a, b) => {
        const av = a[sortBy.value], bv = b[sortBy.value]
        if (typeof av === 'number') return (av - bv) * sortDir.value
        return String(av).localeCompare(String(bv)) * sortDir.value
      })
      return list
    })

    const totalCost = computed(() => filtered.value.reduce((s, a) => s + (a.costPerYear || 0), 0))

    function critClass (c) {
      return { 'Mission-Critical': 'bg-red-100 text-red-700', 'Business-Critical': 'bg-orange-100 text-orange-700', 'Business-Operational': 'bg-yellow-100 text-yellow-700', 'Administrative': 'bg-gray-100 text-gray-600' }[c] || 'bg-gray-100 text-gray-600'
    }
    function timeClass (t) {
      return { Invest: 'bg-green-100 text-green-700', Tolerate: 'bg-yellow-100 text-yellow-700', Migrate: 'bg-blue-100 text-blue-700', Eliminate: 'bg-red-100 text-red-700' }[t] || 'bg-gray-100 text-gray-600'
    }

    function onSaved () { showForm.value = false }

    return { store, linkTo, navigateTo, search, filterTime, filterCrit, sortBy, sortDir, filtered, totalCost, toggleSort, sortIcon, critClass, timeClass, showForm, onSaved }
  }
}


// ── AppDetail (app-detail.js) ──
// app-detail.js — Application detail view with capabilities, projects, edit/delete

const AppDetail = {
  name: 'AppDetail',
  template: `
    <div v-if="app" class="space-y-6">
      <!-- Back link -->
      <a :href="linkTo('/apps')" class="text-sm text-gray-500 hover:text-primary-600">← Applications</a>

      <!-- Header -->
      <div class="bg-white rounded-xl border border-surface-200 p-6">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
          <div>
            <div class="flex items-center gap-3 mb-1">
              <h2 class="text-xl font-bold text-gray-900">{{ app.name }}</h2>
              <span class="text-xs px-2 py-0.5 rounded-full" :class="timeClass(app.timeQuadrant)">{{ app.timeQuadrant }}</span>
              <span class="text-xs px-2 py-0.5 rounded-full" :class="critClass(app.criticality)">{{ app.criticality }}</span>
            </div>
            <div class="text-sm text-gray-500">{{ app.vendor }} · {{ app.category }} · {{ app.type }}</div>
            <p class="text-sm text-gray-600 mt-3 max-w-2xl">{{ app.description }}</p>
          </div>
          <div class="flex gap-2 shrink-0">
            <button @click="showEdit = true" class="px-3 py-1.5 border border-gray-300 rounded-lg text-xs hover:bg-surface-100">Edit</button>
            <button @click="confirmDelete" class="px-3 py-1.5 border border-red-300 text-red-600 rounded-lg text-xs hover:bg-red-50">Delete</button>
          </div>
        </div>

        <!-- Metrics -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 mt-6 pt-4 border-t border-surface-100">
          <div>
            <div class="text-xs text-gray-500">Cost / Year</div>
            <div class="text-lg font-bold text-gray-800">{{ app.costPerYear > 0 ? '€' + app.costPerYear.toLocaleString() : '—' }}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500">Users</div>
            <div class="text-lg font-bold text-gray-800">{{ app.userCount }}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500">Go-Live</div>
            <div class="text-lg font-bold text-gray-800">{{ app.goLiveDate || '—' }}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500">Business Value</div>
            <div class="text-lg font-bold" :class="app.scores?.businessValue >= 7 ? 'text-green-600' : 'text-gray-800'">{{ app.scores?.businessValue || '—' }}/10</div>
          </div>
          <div>
            <div class="text-xs text-gray-500">Technical Health</div>
            <div class="text-lg font-bold" :class="app.scores?.technicalHealth >= 7 ? 'text-green-600' : app.scores?.technicalHealth <= 3 ? 'text-red-600' : 'text-gray-800'">{{ app.scores?.technicalHealth || '—' }}/10</div>
          </div>
        </div>

        <!-- Owners -->
        <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-surface-100">
          <div>
            <div class="text-xs text-gray-500">Business Owner</div>
            <div class="text-sm text-gray-800">{{ app.businessOwner || '—' }}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500">IT Owner</div>
            <div class="text-sm text-gray-800">{{ app.itOwner || '—' }}</div>
          </div>
        </div>
      </div>

      <!-- Capability Mappings -->
      <div class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Mapped Capabilities ({{ mappedCaps.length }})</h3>
        </div>
        <div v-if="mappedCaps.length === 0" class="px-5 py-4 text-sm text-gray-400 italic">No capability mappings yet.</div>
        <div v-else class="divide-y divide-surface-100">
          <div v-for="cap in mappedCaps" :key="cap.id" class="flex items-center justify-between px-5 py-3">
            <div class="flex items-center gap-3">
              <span class="domain-swatch" :style="{ backgroundColor: cap.domain?.color || '#94a3b8' }"></span>
              <span class="text-xs font-mono text-gray-500">{{ cap.id }}</span>
              <span class="text-sm text-gray-800">{{ cap.name }}</span>
              <span class="text-[10px] text-gray-400">({{ cap.domain?.name }})</span>
            </div>
            <span class="text-xs px-2 py-0.5 rounded-full"
                  :class="cap.role === 'Primary' ? 'bg-primary-100 text-primary-700' : 'bg-gray-100 text-gray-600'">
              {{ cap.role }}
            </span>
          </div>
        </div>
      </div>

      <!-- Related Projects -->
      <div v-if="relatedProjects.length" class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Related Projects</h3>
        </div>
        <div class="divide-y divide-surface-100">
          <a v-for="p in relatedProjects" :key="p.id" :href="linkTo('/projects/' + p.id)"
             class="flex items-center justify-between px-5 py-3 hover:bg-surface-50 transition-colors">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 rounded-full" :class="statusDot(p.status)"></span>
              <span class="text-sm text-gray-800">{{ p.name }}</span>
              <span class="text-xs text-gray-400">({{ p.action }})</span>
            </div>
            <span class="text-xs text-gray-400">€{{ (p.budget / 1000).toFixed(0) }}k</span>
          </a>
        </div>
      </div>

      <!-- E2E Processes -->
      <div v-if="relatedProcesses.length" class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">E2E Prozesse ({{ relatedProcesses.length }})</h3>
        </div>
        <div class="divide-y divide-surface-100">
          <a v-for="proc in relatedProcesses" :key="proc.id" :href="linkTo('/processes/' + proc.id)"
             class="flex items-center justify-between px-5 py-3 hover:bg-surface-50 transition-colors">
            <div class="flex items-center gap-3">
              <span class="text-xs font-mono text-gray-400">{{ proc.id }}</span>
              <span class="text-sm text-gray-800">{{ proc.name }}</span>
              <span class="text-[10px] px-2 py-0.5 rounded-full" :class="procStatusClass(proc.status)">{{ proc.status }}</span>
            </div>
            <div class="flex gap-1">
              <span v-for="did in proc.domains" :key="did"
                    class="w-4 h-4 rounded text-[8px] text-white font-bold flex items-center justify-center"
                    :style="{ backgroundColor: domainColor(did) }">{{ did }}</span>
            </div>
          </a>
        </div>
      </div>

      <!-- Edit Modal -->
      <app-form v-if="showEdit" :edit-app="app" @close="showEdit = false" @saved="showEdit = false"></app-form>
    </div>
    <div v-else class="text-center py-12 text-gray-500">Application not found.</div>
  `,
  setup () {
    const { ref, computed } = Vue
    const showEdit = ref(false)

    const app = computed(() => store.appById(router.params.id))

    const mappedCaps = computed(() => {
      if (!app.value) return []
      return store.capabilitiesForApp(app.value.id)
    })

    const relatedProjects = computed(() => {
      if (!app.value) return []
      return store.data.projects
        .filter(p => p.affectedApps && p.affectedApps.some(a => a.appId === app.value.id))
        .map(p => {
          const affected = p.affectedApps.find(a => a.appId === app.value.id)
          return { ...p, action: affected?.action || '' }
        })
    })

    const relatedProcesses = computed(() => {
      if (!app.value) return []
      return store.processesForApp(app.value.id)
    })

    function timeClass (t) {
      return { Invest: 'bg-green-100 text-green-700', Tolerate: 'bg-yellow-100 text-yellow-700', Migrate: 'bg-blue-100 text-blue-700', Eliminate: 'bg-red-100 text-red-700' }[t] || ''
    }
    function critClass (c) {
      return { 'Mission-Critical': 'bg-red-100 text-red-700', 'Business-Critical': 'bg-orange-100 text-orange-700', 'Business-Operational': 'bg-yellow-100 text-yellow-700', 'Administrative': 'bg-gray-100 text-gray-600' }[c] || ''
    }
    function statusDot (s) {
      return { green: 'bg-green-500', yellow: 'bg-yellow-500', red: 'bg-red-500' }[s] || 'bg-gray-400'
    }
    function procStatusClass (s) {
      return { active: 'bg-green-100 text-green-700', optimization: 'bg-blue-100 text-blue-700', transformation: 'bg-purple-100 text-purple-700' }[s] || 'bg-gray-100 text-gray-600'
    }
    function domainColor (id) {
      const d = store.domainById(id)
      return d ? d.color : '#94a3b8'
    }

    function confirmDelete () {
      if (app.value && confirm('Delete "' + app.value.name + '"? This cannot be undone.')) {
        store.deleteApp(app.value.id)
        navigateTo('/apps')
      }
    }

    return { store, router, linkTo, navigateTo, app, mappedCaps, relatedProjects, relatedProcesses, showEdit, timeClass, critClass, statusDot, procStatusClass, domainColor, confirmDelete }
  }
}


// ── CapAppMatrix (cap-app-matrix.js) ──
// cap-app-matrix.js — Capability × Application heatmap matrix

const CapAppMatrix = {
  name: 'CapAppMatrix',
  template: `
    <div class="space-y-4">
      <p class="text-sm text-gray-500">Rows = L1 Capabilities · Columns = Applications · Cell color indicates mapping role.</p>

      <!-- Filter -->
      <div class="flex flex-wrap items-center gap-3">
        <select v-model="filterDomain" class="px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white">
          <option :value="0">All Domains</option>
          <option v-for="d in store.data.domains" :key="d.id" :value="d.id">{{ d.id }}. {{ d.name }}</option>
        </select>
        <label class="flex items-center gap-2 text-sm text-gray-600">
          <input type="checkbox" v-model="hideUnmapped" class="rounded" />
          Hide unmapped apps
        </label>
      </div>

      <!-- Matrix -->
      <div class="relative">
        <p class="text-xs text-gray-400 mb-1 md:hidden">← Horizontal scrollen →</p>
        <div class="bg-white rounded-xl border border-surface-200 overflow-auto max-h-[75vh] -webkit-overflow-scrolling-touch">
        <table class="text-xs border-collapse min-w-max">
          <thead class="sticky top-0 z-20 bg-white">
            <tr>
              <th class="sticky left-0 z-30 bg-surface-50 px-3 py-2 text-left font-medium text-gray-600 border-b border-r border-surface-200 min-w-[200px]">Capability</th>
              <th v-for="app in visibleApps" :key="app.id"
                  class="px-1 py-2 border-b border-surface-200 text-center font-medium text-gray-600 min-w-[60px]"
                  :title="app.name + ' — ' + app.vendor">
                <div class="writing-mode-vertical" style="writing-mode: vertical-lr; transform: rotate(180deg); max-height: 100px; overflow: hidden;">
                  {{ app.name }}
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <template v-for="domain in filteredDomains" :key="domain.id">
              <!-- Domain separator row -->
              <tr>
                <td :colspan="visibleApps.length + 1" class="px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider sticky left-0 z-10"
                    :style="{ backgroundColor: domain.color + '15', color: domain.color }">
                  {{ domain.id }}. {{ domain.name }}
                </td>
              </tr>
              <!-- Capability rows -->
              <tr v-for="cap in domain.capabilities" :key="cap.id" class="hover:bg-surface-50">
                <td class="sticky left-0 z-10 bg-white px-3 py-1.5 border-b border-r border-surface-100 whitespace-nowrap">
                  <span class="text-gray-400 mr-1">{{ cap.id }}</span>
                  <span class="text-gray-700">{{ cap.name }}</span>
                </td>
                <td v-for="app in visibleApps" :key="app.id"
                    class="border-b border-surface-100 text-center p-0">
                  <div v-if="getMapping(cap.id, app.id)"
                       class="matrix-cell w-full h-full flex items-center justify-center py-1.5 cursor-pointer"
                       :class="getMapping(cap.id, app.id) === 'Primary' ? 'bg-primary-500 text-white' : 'bg-primary-100 text-primary-700'"
                       :title="app.name + ' → ' + cap.name + ' (' + getMapping(cap.id, app.id) + ')'"
                       @click="toggleMapping(cap.id, app.id)">
                    {{ getMapping(cap.id, app.id) === 'Primary' ? '●' : '○' }}
                  </div>
                  <div v-else class="w-full h-full py-1.5 cursor-pointer hover:bg-surface-100 text-surface-300"
                       @click="toggleMapping(cap.id, app.id)"
                       :title="'Click to map ' + app.name + ' → ' + cap.name">
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      </div>

      <!-- Legend -->
      <div class="flex flex-wrap items-center gap-4 sm:gap-6 text-xs text-gray-500">
        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded bg-primary-500 text-white text-center text-[10px] leading-4">●</span> Primary</span>
        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded bg-primary-100 text-primary-700 text-center text-[10px] leading-4">○</span> Secondary</span>
        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded bg-surface-50 border border-surface-200"></span> No mapping (click to add)</span>
      </div>
    </div>
  `,
  setup () {
    const { ref, computed } = Vue
    const filterDomain = ref(0)
    const hideUnmapped = ref(false)

    const filteredDomains = computed(() => {
      if (filterDomain.value === 0) return store.data.domains
      return store.data.domains.filter(d => d.id === filterDomain.value)
    })

    // All app IDs that have at least one mapping
    const mappedAppIds = computed(() => new Set(store.data.capabilityMappings.map(m => m.applicationId)))

    const visibleApps = computed(() => {
      let apps = [...store.data.applications]
      if (hideUnmapped.value) apps = apps.filter(a => mappedAppIds.value.has(a.id))
      return apps
    })

    function getMapping (capId, appId) {
      const m = store.data.capabilityMappings.find(m => m.capabilityId === capId && m.applicationId === appId)
      return m ? m.role : null
    }

    function toggleMapping (capId, appId) {
      const existing = getMapping(capId, appId)
      if (!existing) {
        store.addMapping(capId, appId, 'Primary')
      } else if (existing === 'Primary') {
        store.removeMapping(capId, appId)
        store.addMapping(capId, appId, 'Secondary')
      } else {
        store.removeMapping(capId, appId)
      }
    }

    return { store, linkTo, filterDomain, hideUnmapped, filteredDomains, visibleApps, getMapping, toggleMapping }
  }
}


// ── TimeQuadrant (time-quadrant.js) ──
// time-quadrant.js — TIME (Tolerate / Invest / Migrate / Eliminate) scatter plot

const TimeQuadrant = {
  name: 'TimeQuadrant',
  template: `
    <div class="space-y-4">
      <p class="text-sm text-gray-500">Business Value (Y) vs Technical Health (X). Color & label = TIME classification. Click an application to view details.</p>

      <div class="bg-white rounded-xl border border-surface-200 p-4 sm:p-6">
        <div class="relative h-[360px] md:h-[520px]">
          <canvas ref="chartCanvas"></canvas>
        </div>
      </div>

      <!-- Applications by TIME category -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div v-for="q in quadrants" :key="q.name"
             class="rounded-xl border-2 p-4"
             :style="{ borderColor: q.color + '40', backgroundColor: q.color + '08' }">
          <div class="flex items-center gap-2 mb-2">
            <span class="w-3 h-3 rounded-full" :style="{ backgroundColor: q.color }"></span>
            <span class="text-sm font-semibold" :style="{ color: q.color }">{{ q.name }}</span>
            <span class="text-xs text-gray-400 ml-auto">{{ q.apps.length }}</span>
          </div>
          <div class="space-y-1">
            <a v-for="app in q.apps" :key="app.id"
               :href="linkTo('/apps/' + app.id)"
               class="block text-xs text-gray-700 hover:text-primary-600 truncate">
              {{ app.name }}
            </a>
          </div>
        </div>
      </div>
    </div>
  `,
  setup () {
    const { ref, computed, onMounted, nextTick } = Vue
    const chartCanvas = ref(null)

    const timeColors = { Invest: '#10b981', Tolerate: '#f59e0b', Migrate: '#3b82f6', Eliminate: '#ef4444' }

    const quadrants = computed(() => {
      const groups = { Invest: [], Tolerate: [], Migrate: [], Eliminate: [] }
      store.data.applications.forEach(a => {
        if (groups[a.timeQuadrant]) groups[a.timeQuadrant].push(a)
      })
      return Object.entries(groups).map(([name, apps]) => ({ name, apps, color: timeColors[name] }))
    })

    function renderChart () {
      if (!chartCanvas.value) return
      const apps = store.data.applications

      // Group datasets by TIME quadrant
      const datasets = Object.entries(timeColors).map(([quadrant, color]) => {
        const points = apps
          .filter(a => a.timeQuadrant === quadrant && a.scores)
          .map(a => ({
            x: a.scores.technicalHealth,
            y: a.scores.businessValue,
            r: Math.max(6, Math.sqrt(a.costPerYear / 1000) * 1.5),
            label: a.name,
            id: a.id
          }))
        return {
          label: quadrant,
          data: points,
          backgroundColor: color + '99',
          borderColor: color,
          borderWidth: 1.5
        }
      })

      const chart = new Chart(chartCanvas.value, {
        type: 'bubble',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: 'Technical Health →', font: { size: 12 } },
              min: 0, max: 11, ticks: { stepSize: 1 },
              grid: { color: '#f1f5f9' }
            },
            y: {
              title: { display: true, text: 'Business Value →', font: { size: 12 } },
              min: 0, max: 11, ticks: { stepSize: 1 },
              grid: { color: '#f1f5f9' }
            }
          },
          plugins: {
            legend: { position: 'top', labels: { usePointStyle: true, padding: 16 } },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const p = ctx.raw
                  return p.label + ' (BV=' + p.y + ', TH=' + p.x + ')'
                }
              }
            }
          },
          onClick: (evt, elements) => {
            if (elements.length > 0) {
              const el = elements[0]
              const ds = datasets[el.datasetIndex]
              const point = ds.data[el.index]
              if (point && point.id) navigateTo('/apps/' + point.id)
            }
          }
        },
        plugins: [{
          // Draw quadrant background areas
          beforeDraw: (chart) => {
            const { ctx, chartArea: { left, top, right, bottom } } = chart
            const xMid = chart.scales.x.getPixelForValue(5.5)
            const yMid = chart.scales.y.getPixelForValue(5.5)
            const areas = [
              { x1: left, y1: top, x2: xMid, y2: yMid, color: '#3b82f610', label: 'Migrate' },        // low-tech, high-biz
              { x1: xMid, y1: top, x2: right, y2: yMid, color: '#10b98110', label: 'Invest' },         // high-tech, high-biz
              { x1: left, y1: yMid, x2: xMid, y2: bottom, color: '#ef444410', label: 'Eliminate' },     // low-tech, low-biz
              { x1: xMid, y1: yMid, x2: right, y2: bottom, color: '#f59e0b10', label: 'Tolerate' }     // high-tech, low-biz
            ]
            areas.forEach(a => {
              ctx.save()
              ctx.fillStyle = a.color
              ctx.fillRect(a.x1, a.y1, a.x2 - a.x1, a.y2 - a.y1)
              // Label
              ctx.fillStyle = '#94a3b8'
              ctx.font = '11px sans-serif'
              ctx.textAlign = 'center'
              ctx.fillText(a.label, (a.x1 + a.x2) / 2, a.y1 + 16)
              ctx.restore()
            })
          }
        }]
      })
    }

    onMounted(() => { nextTick(renderChart) })

    return { store, linkTo, navigateTo, chartCanvas, quadrants }
  }
}


// ── ProjectList (project-list.js) ──
// project-list.js — Project Portfolio table with filter/sort

const ProjectList = {
  name: 'ProjectList',
  template: `
    <div class="space-y-4">
      <!-- Toolbar -->
      <div class="flex flex-wrap items-center gap-3">
        <input v-model="search" type="text" placeholder="Search projects…"
               class="flex-1 min-w-[200px] px-3 py-2 border border-surface-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-300 outline-none" />
        <select v-model="filterCat" class="px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white">
          <option value="">All Categories</option>
          <option v-for="c in store.data.enums.projectCategory" :key="c" :value="c">{{ c }}</option>
        </select>
        <select v-model="filterStatus" class="px-3 py-2 border border-surface-200 rounded-lg text-sm bg-white">
          <option value="">All Status</option>
          <option value="green">Green</option>
          <option value="yellow">Yellow</option>
          <option value="red">Red</option>
        </select>
        <button @click="showForm = true"
                class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm hover:bg-primary-700 whitespace-nowrap">
          + Add Project
        </button>
      </div>

      <div class="text-xs text-gray-500">{{ filtered.length }} of {{ store.totalProjects }} projects · Total Budget: €{{ (totalBudget / 1000).toFixed(0) }}k</div>

      <!-- Table -->
      <div class="bg-white rounded-xl border border-surface-200 overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-surface-200 bg-surface-50">
              <th class="text-left px-4 py-3 font-medium text-gray-600 w-8"></th>
              <th class="text-left px-4 py-3 font-medium text-gray-600 cursor-pointer hover:text-gray-900" @click="toggleSort('name')">Name {{ sortIcon('name') }}</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600 hidden md:table-cell">Category</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600 hidden md:table-cell">Domain</th>
              <th class="text-right px-4 py-3 font-medium text-gray-600 cursor-pointer hover:text-gray-900 hidden sm:table-cell" @click="toggleSort('budget')">Budget {{ sortIcon('budget') }}</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600 hidden lg:table-cell">Timeline</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600 hidden lg:table-cell">Sponsor</th>
              <th class="text-left px-4 py-3 font-medium text-gray-600 hidden md:table-cell">Dependencies</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-surface-100">
            <tr v-for="p in filtered" :key="p.id"
                class="hover:bg-surface-50 cursor-pointer transition-colors"
                @click="navigateTo('/projects/' + p.id)">
              <td class="px-4 py-3">
                <span class="w-2.5 h-2.5 rounded-full inline-block" :class="statusDot(p.status)"></span>
              </td>
              <td class="px-4 py-3">
                <div class="font-medium text-gray-900">{{ p.name }}</div>
                <div class="text-xs text-gray-400">{{ p.id }}</div>
              </td>
              <td class="px-4 py-3 hidden md:table-cell">
                <span class="text-xs px-2 py-0.5 rounded-full" :class="catClass(p.category)">{{ p.category }}</span>
              </td>
              <td class="px-4 py-3 hidden md:table-cell">
                <div class="flex items-center gap-1.5">
                  <span class="domain-swatch" :style="{ backgroundColor: domainColor(p.primaryDomain) }"></span>
                  <span class="text-xs text-gray-600">{{ domainName(p.primaryDomain) }}</span>
                </div>
              </td>
              <td class="px-4 py-3 text-right font-mono text-gray-700 hidden sm:table-cell">€{{ (p.budget / 1000).toFixed(0) }}k</td>
              <td class="px-4 py-3 text-xs text-gray-600 hidden lg:table-cell">{{ p.start }} → {{ p.end }}</td>
              <td class="px-4 py-3 text-xs text-gray-600 hidden lg:table-cell">{{ p.sponsor }}</td>
              <td class="px-4 py-3 text-center hidden md:table-cell">
                <span v-if="depCount(p.id) > 0" class="text-xs px-2 py-0.5 rounded-full bg-surface-100 text-gray-600">{{ depCount(p.id) }}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Project Form Modal -->
      <project-form v-if="showForm" @close="showForm = false" @saved="showForm = false"></project-form>
    </div>
  `,
  setup () {
    const { ref, computed } = Vue
    const search = ref('')
    const filterCat = ref('')
    const filterStatus = ref('')
    const sortBy = ref('name')
    const sortDir = ref(1)
    const showForm = ref(false)

    function toggleSort (f) {
      if (sortBy.value === f) sortDir.value *= -1
      else { sortBy.value = f; sortDir.value = 1 }
    }
    function sortIcon (f) { return sortBy.value === f ? (sortDir.value === 1 ? '↑' : '↓') : '' }

    const filtered = computed(() => {
      let list = [...store.data.projects]
      const q = search.value.toLowerCase()
      if (q) list = list.filter(p => p.name.toLowerCase().includes(q) || p.id.toLowerCase().includes(q))
      if (filterCat.value) list = list.filter(p => p.category === filterCat.value)
      if (filterStatus.value) list = list.filter(p => p.status === filterStatus.value)
      list.sort((a, b) => {
        const av = a[sortBy.value], bv = b[sortBy.value]
        if (typeof av === 'number') return (av - bv) * sortDir.value
        return String(av).localeCompare(String(bv)) * sortDir.value
      })
      return list
    })

    const totalBudget = computed(() => filtered.value.reduce((s, p) => s + (p.budget || 0), 0))

    function statusDot (s) { return { green: 'bg-green-500', yellow: 'bg-yellow-500', red: 'bg-red-500' }[s] || 'bg-gray-400' }
    function catClass (c) {
      return { 'Run / Pflicht': 'bg-gray-100 text-gray-700', 'Modernisierung': 'bg-blue-100 text-blue-700', 'Optimierung': 'bg-green-100 text-green-700', 'Innovation / Grow': 'bg-purple-100 text-purple-700', 'Infrastruktur': 'bg-orange-100 text-orange-700' }[c] || 'bg-gray-100 text-gray-600'
    }
    function domainColor (id) { const d = store.domainById(id); return d ? d.color : '#94a3b8' }
    function domainName (id) { const d = store.domainById(id); return d ? d.name : '—' }
    function depCount (id) { return store.depsForProject(id).length }

    return { store, linkTo, navigateTo, search, filterCat, filterStatus, filtered, totalBudget, toggleSort, sortIcon, statusDot, catClass, domainColor, domainName, depCount, showForm }
  }
}


// ── ProjectDetail (project-detail.js) ──
// project-detail.js — Project detail view

const ProjectDetail = {
  name: 'ProjectDetail',
  template: `
    <div v-if="project" class="space-y-6">
      <a :href="linkTo('/projects')" class="text-sm text-gray-500 hover:text-primary-600">← Projects</a>

      <!-- Header -->
      <div class="bg-white rounded-xl border border-surface-200 p-6">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
          <div>
            <div class="flex items-center gap-3 mb-1">
              <span class="w-3 h-3 rounded-full" :class="statusDot(project.status)"></span>
              <h2 class="text-xl font-bold text-gray-900">{{ project.name }}</h2>
              <span class="text-xs px-2 py-0.5 rounded-full" :class="catClass(project.category)">{{ project.category }}</span>
            </div>
            <div class="text-sm text-gray-500">{{ project.id }} · {{ project.start }} → {{ project.end }}</div>
            <p v-if="project.statusText" class="text-sm mt-2 px-3 py-1.5 rounded-lg"
               :class="project.status === 'red' ? 'bg-red-50 text-red-700' : project.status === 'yellow' ? 'bg-yellow-50 text-yellow-700' : 'bg-green-50 text-green-700'">
              {{ project.statusText }}
            </p>
          </div>
          <div class="flex gap-2 shrink-0">
            <button @click="showEdit = true" class="px-3 py-1.5 border border-gray-300 rounded-lg text-xs hover:bg-surface-100">Edit</button>
            <button @click="confirmDelete" class="px-3 py-1.5 border border-red-300 text-red-600 rounded-lg text-xs hover:bg-red-50">Delete</button>
          </div>
        </div>

        <!-- Metrics -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mt-6 pt-4 border-t border-surface-100">
          <div>
            <div class="text-xs text-gray-500">Budget</div>
            <div class="text-lg font-bold text-gray-800">€{{ project.budget?.toLocaleString() }}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500">Primary Domain</div>
            <div class="flex items-center gap-1.5 mt-0.5">
              <span class="domain-swatch" :style="{ backgroundColor: domainColor(project.primaryDomain) }"></span>
              <span class="text-sm font-medium text-gray-800">{{ domainName(project.primaryDomain) }}</span>
            </div>
          </div>
          <div>
            <div class="text-xs text-gray-500">Sponsor</div>
            <div class="text-sm font-medium text-gray-800">{{ project.sponsor || '—' }}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500">Project Lead</div>
            <div class="text-sm font-medium text-gray-800">{{ project.projectLead || '—' }}</div>
          </div>
        </div>

        <div v-if="project.strategicContribution" class="mt-4 pt-4 border-t border-surface-100">
          <div class="text-xs text-gray-500 mb-1">Strategic Contribution</div>
          <p class="text-sm text-gray-700">{{ project.strategicContribution }}</p>
        </div>
      </div>

      <!-- Affected Applications -->
      <div v-if="project.affectedApps && project.affectedApps.length" class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Affected Applications</h3>
        </div>
        <div class="divide-y divide-surface-100">
          <a v-for="aa in project.affectedApps" :key="aa.appId"
             :href="linkTo('/apps/' + aa.appId)"
             class="flex items-center justify-between px-5 py-3 hover:bg-surface-50 transition-colors">
            <span class="text-sm text-gray-800">{{ appName(aa.appId) }}</span>
            <span class="text-xs px-2 py-0.5 rounded-full"
                  :class="aa.action === 'ablösen' ? 'bg-red-100 text-red-700' : aa.action === 'einführen' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'">
              {{ aa.action }}
            </span>
          </a>
        </div>
      </div>

      <!-- Dependencies -->
      <div v-if="deps.length" class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Dependencies ({{ deps.length }})</h3>
        </div>
        <div class="divide-y divide-surface-100">
          <div v-for="dep in deps" :key="dep.sourceProjectId + dep.targetProjectId" class="flex items-center justify-between px-5 py-3">
            <div class="flex items-center gap-2 text-sm">
              <a :href="linkTo('/projects/' + dep.sourceProjectId)" class="text-primary-600 hover:underline">{{ projName(dep.sourceProjectId) }}</a>
              <span class="text-gray-400">→{{ depSymbol(dep.type) }}→</span>
              <a :href="linkTo('/projects/' + dep.targetProjectId)" class="text-primary-600 hover:underline">{{ projName(dep.targetProjectId) }}</a>
            </div>
            <span class="text-xs text-gray-500 max-w-[300px] truncate">{{ dep.description }}</span>
          </div>
        </div>
      </div>

      <!-- Capabilities -->
      <div v-if="project.capabilities && project.capabilities.length" class="bg-white rounded-xl border border-surface-200 p-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Touched Capabilities</h3>
        <div class="flex flex-wrap gap-2">
          <span v-for="capId in project.capabilities" :key="capId"
                class="text-xs px-2 py-1 bg-surface-100 text-gray-700 rounded">
            {{ capId }} {{ capName(capId) }}
          </span>
        </div>
      </div>

      <!-- Edit Modal -->
      <project-form v-if="showEdit" :edit-project="project" @close="showEdit = false" @saved="showEdit = false"></project-form>
    </div>
    <div v-else class="text-center py-12 text-gray-500">Project not found.</div>
  `,
  setup () {
    const { ref, computed } = Vue
    const showEdit = ref(false)

    const project = computed(() => store.projectById(router.params.id))
    const deps = computed(() => project.value ? store.depsForProject(project.value.id) : [])

    function statusDot (s) { return { green: 'bg-green-500', yellow: 'bg-yellow-500', red: 'bg-red-500' }[s] || 'bg-gray-400' }
    function catClass (c) { return { 'Run / Pflicht': 'bg-gray-100 text-gray-700', 'Modernisierung': 'bg-blue-100 text-blue-700', 'Optimierung': 'bg-green-100 text-green-700', 'Innovation / Grow': 'bg-purple-100 text-purple-700', 'Infrastruktur': 'bg-orange-100 text-orange-700' }[c] || 'bg-gray-100' }
    function domainColor (id) { const d = store.domainById(id); return d ? d.color : '#94a3b8' }
    function domainName (id) { const d = store.domainById(id); return d ? d.name : '—' }
    function appName (id) { const a = store.appById(id); return a ? a.name : id }
    function projName (id) { const p = store.projectById(id); return p ? p.name : id }
    function capName (id) { const c = store.capabilityById(id); return c ? c.name : '' }
    function depSymbol (type) {
      const dt = store.data.enums.dependencyType?.find(d => d.value === type)
      return dt ? dt.symbol.replace('→', '') : type
    }

    function confirmDelete () {
      if (project.value && confirm('Delete "' + project.value.name + '"?')) {
        store.deleteProject(project.value.id)
        navigateTo('/projects')
      }
    }

    return { store, router, linkTo, navigateTo, project, deps, showEdit, statusDot, catClass, domainColor, domainName, appName, projName, capName, depSymbol, confirmDelete }
  }
}


// ── ProjectHeatmap (project-heatmap.js) ──
// project-heatmap.js — Domain × Project mapping heatmap

const ProjectHeatmap = {
  name: 'ProjectHeatmap',
  template: `
    <div class="space-y-4">
      <p class="text-sm text-gray-500">Rows = Domains · Columns = Projects. Dark cells = primary domain, light cells = secondary involvement.</p>

      <div class="relative">
        <p class="text-xs text-gray-400 mb-1 md:hidden">← Horizontal scrollen →</p>
        <div class="bg-white rounded-xl border border-surface-200 overflow-auto">
        <table class="text-xs border-collapse min-w-max">
          <thead class="sticky top-0 z-20 bg-white">
            <tr>
              <th class="sticky left-0 z-30 bg-surface-50 px-3 py-2 text-left font-medium text-gray-600 border-b border-r border-surface-200 min-w-[200px]">Domain</th>
              <th v-for="p in store.data.projects" :key="p.id"
                  class="px-1 py-2 border-b border-surface-200 text-center font-medium text-gray-600 min-w-[50px]"
                  :title="p.name">
                <div style="writing-mode: vertical-lr; transform: rotate(180deg); max-height: 120px; overflow: hidden;">
                  {{ p.name.length > 20 ? p.name.slice(0, 18) + '…' : p.name }}
                </div>
              </th>
              <th class="px-3 py-2 border-b border-surface-200 text-center font-medium text-gray-600">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="domain in store.data.domains" :key="domain.id" class="hover:bg-surface-50">
              <td class="sticky left-0 z-10 bg-white px-3 py-2 border-b border-r border-surface-100 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <span class="domain-swatch" :style="{ backgroundColor: domain.color }"></span>
                  <a :href="linkTo('/domains/' + domain.id)" class="text-gray-700 hover:text-primary-600">{{ domain.id }}. {{ domain.name }}</a>
                </div>
              </td>
              <td v-for="p in store.data.projects" :key="p.id"
                  class="border-b border-surface-100 text-center p-0">
                <div v-if="p.primaryDomain === domain.id"
                     class="w-full h-full py-2 font-bold text-white"
                     :style="{ backgroundColor: domain.color }"
                     :title="p.name + ' — Primary'">
                  P
                </div>
                <div v-else-if="p.secondaryDomains && p.secondaryDomains.includes(domain.id)"
                     class="w-full h-full py-2"
                     :style="{ backgroundColor: domain.color + '30', color: domain.color }"
                     :title="p.name + ' — Secondary'">
                  S
                </div>
              </td>
              <td class="px-3 py-2 border-b border-surface-100 text-center text-gray-700 font-medium">
                {{ projectCount(domain.id) }}
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="bg-surface-50">
              <td class="sticky left-0 z-10 bg-surface-50 px-3 py-2 border-t border-r border-surface-200 font-medium text-gray-600">Total</td>
              <td v-for="p in store.data.projects" :key="p.id" class="px-1 py-2 border-t border-surface-200 text-center text-gray-600 font-medium">
                {{ domainCount(p) }}
              </td>
              <td class="px-3 py-2 border-t border-surface-200"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      </div>

      <!-- Summary stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl border border-surface-200 p-4 text-center" v-for="stat in summaryStats" :key="stat.label">
          <div class="text-2xl font-bold" :style="{ color: stat.color }">{{ stat.value }}</div>
          <div class="text-xs text-gray-500">{{ stat.label }}</div>
        </div>
      </div>

      <!-- Legend -->
      <div class="flex items-center gap-6 text-xs text-gray-500">
        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded bg-primary-500 text-white text-center text-[10px] leading-4 font-bold">P</span> Primary Domain</span>
        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded bg-primary-100 text-primary-600 text-center text-[10px] leading-4">S</span> Secondary Involvement</span>
      </div>
    </div>
  `,
  setup () {
    const { computed } = Vue

    function projectCount (domainId) {
      return store.data.projects.filter(p =>
        p.primaryDomain === domainId || (p.secondaryDomains && p.secondaryDomains.includes(domainId))
      ).length
    }

    function domainCount (project) {
      return 1 + (project.secondaryDomains ? project.secondaryDomains.length : 0)
    }

    const summaryStats = computed(() => {
      // Domains with most projects
      const domainCounts = store.data.domains.map(d => ({ name: d.name, count: projectCount(d.id), color: d.color }))
      domainCounts.sort((a, b) => b.count - a.count)
      const topDomain = domainCounts[0]
      const coldDomains = domainCounts.filter(d => d.count === 0)

      return [
        { label: 'Most Active Domain', value: topDomain ? topDomain.name.split(' ')[0] : '—', color: topDomain?.color || '#94a3b8' },
        { label: 'Projects', value: store.totalProjects, color: '#3b82f6' },
        { label: 'Cross-Domain Projects', value: store.data.projects.filter(p => p.secondaryDomains && p.secondaryDomains.length > 0).length, color: '#8b5cf6' },
        { label: 'Domains w/o Projects', value: coldDomains.length, color: coldDomains.length > 0 ? '#ef4444' : '#10b981' }
      ]
    })

    return { store, linkTo, projectCount, domainCount, summaryStats }
  }
}


// ── DependencyGraph (dependency-graph.js) ──
// dependency-graph.js — D3 force-directed project dependency network

const DependencyGraph = {
  name: 'DependencyGraph',
  template: `
    <div class="space-y-4">
      <p class="text-sm text-gray-500">Force-directed graph of project dependencies. Arrows show direction (source depends on target). Drag nodes to rearrange.</p>

      <!-- Legend -->
      <div class="flex flex-wrap items-center gap-4 text-xs text-gray-500">
        <span class="font-medium">Dependency types:</span>
        <span v-for="dt in depTypes" :key="dt.value" class="flex items-center gap-1">
          <span class="w-3 h-0.5 inline-block rounded" :style="{ backgroundColor: depColor(dt.value) }"></span>
          {{ dt.symbol }} {{ dt.label }}
        </span>
      </div>

      <div class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div ref="graphContainer" class="w-full h-[400px] lg:h-[560px]"></div>
      </div>

      <!-- Dependency table -->
      <div class="bg-white rounded-xl border border-surface-200 overflow-x-auto">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">All Dependencies ({{ store.data.projectDependencies.length }})</h3>
        </div>
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-surface-200 bg-surface-50">
              <th class="text-left px-4 py-2 font-medium text-gray-600">Source (depends on →)</th>
              <th class="text-left px-4 py-2 font-medium text-gray-600">Type</th>
              <th class="text-left px-4 py-2 font-medium text-gray-600">Target (blocking)</th>
              <th class="text-left px-4 py-2 font-medium text-gray-600 hidden sm:table-cell">Description</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-surface-100">
            <tr v-for="dep in store.data.projectDependencies" :key="dep.sourceProjectId + dep.targetProjectId" class="hover:bg-surface-50">
              <td class="px-4 py-2 text-gray-700">{{ projName(dep.sourceProjectId) }}</td>
              <td class="px-4 py-2">
                <span class="text-xs px-2 py-0.5 rounded-full" :style="{ backgroundColor: depColor(dep.type) + '20', color: depColor(dep.type) }">
                  {{ depLabel(dep.type) }}
                </span>
              </td>
              <td class="px-4 py-2 text-gray-700">{{ projName(dep.targetProjectId) }}</td>
              <td class="px-4 py-2 text-xs text-gray-500 hidden sm:table-cell">{{ dep.description }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  `,
  setup () {
    const { ref, onMounted, nextTick } = Vue
    const graphContainer = ref(null)
    const depTypes = store.data.enums.dependencyType || []

    const depColorMap = { T: '#ef4444', D: '#3b82f6', P: '#8b5cf6', R: '#f59e0b', F: '#10b981', Z: '#64748b' }
    function depColor (type) { return depColorMap[type] || '#94a3b8' }
    function depLabel (type) {
      const dt = depTypes.find(d => d.value === type)
      return dt ? dt.symbol : type
    }
    function projName (id) { const p = store.projectById(id); return p ? p.name : id }

    function renderGraph () {
      if (!graphContainer.value || typeof d3 === 'undefined') return

      const container = graphContainer.value
      const width = container.clientWidth
      const height = container.clientHeight || 560

      // Build nodes & links
      const projectIds = new Set()
      store.data.projectDependencies.forEach(d => { projectIds.add(d.sourceProjectId); projectIds.add(d.targetProjectId) })
      // Include all projects even if no deps
      store.data.projects.forEach(p => projectIds.add(p.id))

      const nodes = [...projectIds].map(id => {
        const p = store.projectById(id)
        return {
          id,
          name: p ? p.name : id,
          status: p ? p.status : 'gray',
          budget: p ? p.budget : 0,
          domainColor: p ? (store.domainById(p.primaryDomain)?.color || '#94a3b8') : '#94a3b8'
        }
      })

      const links = store.data.projectDependencies.map(d => ({
        source: d.sourceProjectId,
        target: d.targetProjectId,
        type: d.type
      }))

      // Clear previous
      d3.select(container).selectAll('*').remove()

      const svg = d3.select(container).append('svg')
        .attr('width', width).attr('height', height)
        .attr('viewBox', [0, 0, width, height])

      // Arrow markers
      const defs = svg.append('defs')
      Object.entries(depColorMap).forEach(([type, color]) => {
        defs.append('marker')
          .attr('id', 'arrow-' + type)
          .attr('viewBox', '0 -5 10 10')
          .attr('refX', 25).attr('refY', 0)
          .attr('markerWidth', 6).attr('markerHeight', 6)
          .attr('orient', 'auto')
          .append('path').attr('d', 'M0,-5L10,0L0,5').attr('fill', color)
      })

      const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(120))
        .force('charge', d3.forceManyBody().strength(-400))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(40))

      const link = svg.append('g').selectAll('line')
        .data(links).join('line')
        .attr('class', 'dep-link')
        .attr('stroke', d => depColor(d.type))
        .attr('stroke-width', 2)
        .attr('marker-end', d => 'url(#arrow-' + d.type + ')')

      const node = svg.append('g').selectAll('g')
        .data(nodes).join('g')
        .call(d3.drag()
          .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y })
          .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y })
          .on('end', (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null })
        )
        .style('cursor', 'pointer')
        .on('click', (e, d) => { navigateTo('/projects/' + d.id) })

      const statusColors = { green: '#22c55e', yellow: '#eab308', red: '#ef4444' }

      node.append('circle')
        .attr('r', d => Math.max(12, Math.sqrt(d.budget / 5000)))
        .attr('fill', d => d.domainColor)
        .attr('stroke', d => statusColors[d.status] || '#94a3b8')
        .attr('stroke-width', 3)
        .attr('opacity', 0.85)

      node.append('text')
        .text(d => d.name.length > 22 ? d.name.slice(0, 20) + '…' : d.name)
        .attr('x', 0).attr('y', d => Math.max(12, Math.sqrt(d.budget / 5000)) + 14)
        .attr('text-anchor', 'middle')
        .attr('fill', '#374151')
        .attr('font-size', width < 600 ? '11px' : '10px')

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x).attr('y2', d => d.target.y)
        node.attr('transform', d => 'translate(' + d.x + ',' + d.y + ')')
      })
    }

    onMounted(() => {
      nextTick(renderGraph)
      // Re-render on resize
      if (typeof ResizeObserver !== 'undefined' && graphContainer.value) {
        let resizeTimer = null
        const ro = new ResizeObserver(() => {
          clearTimeout(resizeTimer)
          resizeTimer = setTimeout(renderGraph, 200)
        })
        ro.observe(graphContainer.value)
      }
    })

    return { store, graphContainer, depTypes, depColor, depLabel, projName }
  }
}


// ── ProcessList (process-list.js) ──
// process-list.js — E2E Process overview table

const ProcessList = {
  name: 'ProcessList',
  template: `
    <div class="space-y-6">
      <div class="flex items-center justify-between">
        <div></div>
        <button @click="showForm = true" class="px-4 py-2 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700">+ Add Process</button>
      </div>

      <div class="bg-white rounded-xl border border-surface-200 overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-surface-50 text-xs text-gray-500 uppercase tracking-wide">
            <tr>
              <th class="px-5 py-3 text-left">ID</th>
              <th class="px-5 py-3 text-left">Process</th>
              <th class="px-5 py-3 text-left hidden md:table-cell">Owner</th>
              <th class="px-5 py-3 text-left">Status</th>
              <th class="px-5 py-3 text-left hidden sm:table-cell">Domains</th>
              <th class="px-5 py-3 text-right hidden sm:table-cell">Apps</th>
              <th class="px-5 py-3 text-right hidden md:table-cell">KPIs</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-surface-100">
            <tr v-for="proc in processes" :key="proc.id" class="hover:bg-surface-50 cursor-pointer"
                @click="go(proc.id)">
              <td class="px-5 py-3 font-mono text-xs text-gray-500">{{ proc.id }}</td>
              <td class="px-5 py-3 font-medium text-gray-800">{{ proc.name }}</td>
              <td class="px-5 py-3 text-gray-500 hidden md:table-cell">{{ proc.owner || '—' }}</td>
              <td class="px-5 py-3">
                <span class="text-[10px] px-2 py-0.5 rounded-full" :class="statusClass(proc.status)">{{ proc.status }}</span>
              </td>
              <td class="px-5 py-3 hidden sm:table-cell">
                <div class="flex gap-1">
                  <span v-for="did in proc.domains" :key="did"
                        class="w-5 h-5 rounded text-[9px] text-white font-bold flex items-center justify-center"
                        :style="{ backgroundColor: domainColor(did) }">{{ did }}</span>
                </div>
              </td>
              <td class="px-5 py-3 text-right text-gray-500 hidden sm:table-cell">{{ appCount(proc.id) }}</td>
              <td class="px-5 py-3 text-right text-gray-500 hidden md:table-cell">{{ proc.kpis ? proc.kpis.length : 0 }}</td>
            </tr>
          </tbody>
        </table>
        <div v-if="!processes.length" class="text-center py-8 text-gray-400 text-sm">No E2E processes defined yet.</div>
      </div>

      <process-form v-if="showForm" @close="showForm = false" @saved="showForm = false" />
    </div>
  `,
  setup () {
    const { ref, computed } = Vue
    const showForm = ref(false)

    const processes = computed(() => store.data.e2eProcesses || [])

    function domainColor (id) {
      const d = store.domainById(id)
      return d ? d.color : '#94a3b8'
    }

    function statusClass (s) {
      return { active: 'bg-green-100 text-green-700', optimization: 'bg-blue-100 text-blue-700', transformation: 'bg-purple-100 text-purple-700' }[s] || 'bg-gray-100 text-gray-600'
    }

    function appCount (procId) {
      return store.appsForProcess(procId).length
    }

    function go (id) { window.location.hash = '/processes/' + id }

    return { store, linkTo, showForm, processes, domainColor, statusClass, appCount, go }
  }
}


// ── ProcessDetail (process-detail.js) ──
// process-detail.js — E2E Process detail view with KPIs and domain links

const ProcessDetail = {
  name: 'ProcessDetail',
  template: `
    <div v-if="proc" class="space-y-6">
      <div class="flex items-center gap-4">
        <a :href="linkTo('/processes')" class="text-sm text-gray-500 hover:text-primary-600">← Processes</a>
      </div>

      <!-- Header -->
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
        <div>
          <div class="flex items-center gap-3 mb-1">
            <span class="text-xs font-mono bg-surface-100 px-2 py-0.5 rounded text-gray-500">{{ proc.id }}</span>
            <span class="text-[10px] px-2 py-0.5 rounded-full" :class="statusClass(proc.status)">{{ proc.status }}</span>
          </div>
          <h2 class="text-xl font-bold text-gray-900">{{ proc.name }}</h2>
          <p v-if="proc.description" class="text-sm text-gray-500 mt-1">{{ proc.description }}</p>
          <div v-if="proc.owner" class="mt-1">
            <span class="text-xs px-2 py-0.5 rounded-full bg-surface-100 text-gray-600">Owner: {{ proc.owner }}</span>
          </div>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <button @click="showForm = true" class="px-3 py-1.5 text-xs bg-primary-600 text-white rounded-lg hover:bg-primary-700">Edit</button>
          <button @click="deleteProc" class="px-3 py-1.5 text-xs border border-red-300 text-red-600 rounded-lg hover:bg-red-50">Delete</button>
        </div>
      </div>

      <!-- Linked Domains -->
      <div class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Linked Domains</h3>
        </div>
        <div class="p-5 flex flex-wrap gap-3">
          <a v-for="d in linkedDomains" :key="d.id" :href="linkTo('/domains/' + d.id)"
             class="flex items-center gap-2 px-3 py-2 rounded-lg border border-surface-200 hover:bg-surface-50 transition-colors">
            <div class="w-6 h-6 rounded flex items-center justify-center text-white text-[10px] font-bold"
                 :style="{ backgroundColor: d.color }">{{ d.id }}</div>
            <span class="text-sm text-gray-700">{{ d.name }}</span>
          </a>
          <div v-if="!linkedDomains.length" class="text-sm text-gray-400">No domains linked.</div>
        </div>
      </div>

      <!-- Involved Applications (derived via Domain → Capability → Mapping) -->
      <div class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Involvierte Applikationen ({{ involvedApps.length }})</h3>
          <p class="text-[10px] text-gray-400 mt-0.5">Automatisch abgeleitet über Domain → Capability → Mapping</p>
        </div>
        <div v-if="involvedApps.length" class="divide-y divide-surface-100">
          <a v-for="app in involvedApps" :key="app.id" :href="linkTo('/apps/' + app.id)"
             class="flex items-center justify-between px-5 py-3 hover:bg-surface-50 transition-colors">
            <div class="flex items-center gap-3">
              <span class="text-xs font-mono text-gray-400">{{ app.id }}</span>
              <span class="text-sm font-medium text-gray-800">{{ app.name }}</span>
              <span class="text-[10px] px-1.5 py-0.5 rounded-full" :class="timeClass(app.timeQuadrant)">{{ app.timeQuadrant }}</span>
            </div>
            <div class="flex items-center gap-3">
              <span class="text-[10px] text-gray-400">{{ app.capCount }} Capabilities</span>
              <span class="text-[10px] px-1.5 py-0.5 rounded bg-surface-100 text-gray-500">{{ app.roles }}</span>
            </div>
          </a>
        </div>
        <div v-else class="px-5 py-4 text-sm text-gray-400 italic">Keine Applikationen über Capability-Mappings verknüpft.</div>
      </div>

      <!-- Process KPIs -->
      <div v-if="proc.kpis && proc.kpis.length" class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Process KPIs</h3>
        </div>
        <div class="p-5 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <div v-for="kpi in proc.kpis" :key="kpi.id" class="border border-surface-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-medium text-gray-700">{{ kpi.name }}</span>
              <span class="text-[10px] px-1.5 py-0.5 rounded-full"
                    :class="trendClass(kpi.trend)">
                {{ trendIcon(kpi.trend) }}
              </span>
            </div>
            <div class="flex items-baseline gap-2">
              <span class="text-2xl font-bold" :style="{ color: kpiColor(kpi) }">{{ kpi.current }}</span>
              <span class="text-xs text-gray-400">/ {{ kpi.target }} {{ kpi.unit }}</span>
            </div>
            <div class="mt-2 w-full h-1.5 bg-surface-100 rounded-full overflow-hidden">
              <div class="h-full rounded-full transition-all" :style="{ width: kpiProgress(kpi) + '%', backgroundColor: kpiColor(kpi) }"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <process-form v-if="showForm" :edit-process="proc" @close="showForm = false" @saved="showForm = false" />
    </div>
    <div v-else class="text-center py-12 text-gray-500">Process not found.</div>
  `,
  setup () {
    const { ref, computed } = Vue
    const showForm = ref(false)

    const proc = computed(() => store.processById(router.params.id))

    const linkedDomains = computed(() => {
      if (!proc.value || !proc.value.domains) return []
      return proc.value.domains.map(id => store.domainById(id)).filter(Boolean)
    })

    const involvedApps = computed(() => {
      if (!proc.value) return []
      return store.appsForProcess(proc.value.id)
    })

    function statusClass (s) {
      return { active: 'bg-green-100 text-green-700', optimization: 'bg-blue-100 text-blue-700', transformation: 'bg-purple-100 text-purple-700' }[s] || 'bg-gray-100 text-gray-600'
    }
    function timeClass (t) {
      return { Invest: 'bg-green-100 text-green-700', Tolerate: 'bg-yellow-100 text-yellow-700', Migrate: 'bg-blue-100 text-blue-700', Eliminate: 'bg-red-100 text-red-700' }[t] || ''
    }
    function trendClass (t) {
      return { improving: 'bg-green-100 text-green-700', stable: 'bg-gray-100 text-gray-600', declining: 'bg-red-100 text-red-700' }[t] || 'bg-gray-100 text-gray-600'
    }
    function trendIcon (t) { return { improving: '↑', stable: '→', declining: '↓' }[t] || '→' }

    function kpiProgress (kpi) {
      const c = parseFloat(kpi.current) || 0; const t = parseFloat(kpi.target) || 1
      return Math.min(100, (c / t) * 100)
    }
    function kpiColor (kpi) {
      const pct = kpiProgress(kpi)
      if (pct >= 80) return '#10b981'; if (pct >= 50) return '#f59e0b'; return '#ef4444'
    }

    function deleteProc () {
      if (!proc.value) return
      if (confirm('Delete process "' + proc.value.name + '"?')) {
        store.deleteProcess(proc.value.id)
        navigateTo('/processes')
      }
    }

    return { store, router, linkTo, proc, linkedDomains, involvedApps, showForm, statusClass, timeClass, trendClass, trendIcon, kpiProgress, kpiColor, deleteProc }
  }
}


// ── MaturityGap (maturity-gap.js) ──
// maturity-gap.js — Maturity Gap Analysis: Ist vs Soll with Chart.js

const MaturityGap = {
  name: 'MaturityGap',
  template: `
    <div class="space-y-6">
      <!-- Domain Filter -->
      <div class="flex items-center gap-3 flex-wrap">
        <button @click="selectedDomain = null"
                class="px-3 py-1.5 text-xs rounded-lg border transition-colors"
                :class="!selectedDomain ? 'bg-primary-600 text-white border-primary-600' : 'border-surface-200 text-gray-600 hover:bg-surface-50'">All Domains</button>
        <button v-for="d in store.data.domains" :key="d.id"
                @click="selectedDomain = d.id"
                class="px-3 py-1.5 text-xs rounded-lg border transition-colors"
                :class="selectedDomain === d.id ? 'text-white border-transparent' : 'border-surface-200 text-gray-600 hover:bg-surface-50'"
                :style="selectedDomain === d.id ? { backgroundColor: d.color } : {}">
          {{ d.name }}
        </button>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl border border-surface-200 p-4 text-center">
          <div class="text-2xl font-bold text-gray-700">{{ filteredGaps.length }}</div>
          <div class="text-xs text-gray-500">Capabilities</div>
        </div>
        <div class="bg-white rounded-xl border border-surface-200 p-4 text-center">
          <div class="text-2xl font-bold text-amber-500">{{ avgIst }}/5</div>
          <div class="text-xs text-gray-500">Avg Ist</div>
        </div>
        <div class="bg-white rounded-xl border border-surface-200 p-4 text-center">
          <div class="text-2xl font-bold text-indigo-600">{{ avgSoll }}/5</div>
          <div class="text-xs text-gray-500">Avg Soll</div>
        </div>
        <div class="bg-white rounded-xl border border-surface-200 p-4 text-center">
          <div class="text-2xl font-bold" :style="{ color: avgGapVal > 1 ? '#ef4444' : '#f59e0b' }">{{ avgGapVal }}</div>
          <div class="text-xs text-gray-500">Avg Gap</div>
        </div>
      </div>

      <!-- Chart -->
      <div class="bg-white rounded-xl border border-surface-200 p-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-4">Ist vs Soll Maturity</h3>
        <div :style="{ height: chartHeight + 'px' }">
          <canvas ref="gapCanvas"></canvas>
        </div>
        <div class="flex items-center gap-6 mt-3 text-xs text-gray-500">
          <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background:#3b82f6"></span> Ist</span>
          <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background:#818cf8"></span> Soll</span>
        </div>
      </div>

      <!-- Top Gaps Table -->
      <div class="bg-white rounded-xl border border-surface-200 overflow-hidden">
        <div class="px-5 py-3 border-b border-surface-200 bg-surface-50">
          <h3 class="text-sm font-semibold text-gray-700">Top Gaps (Soll − Ist)</h3>
        </div>
        <table class="w-full text-sm">
          <thead class="text-xs text-gray-500 uppercase tracking-wide">
            <tr>
              <th class="px-5 py-2 text-left">Capability</th>
              <th class="px-5 py-2 text-left">Domain</th>
              <th class="px-5 py-2 text-right">Ist</th>
              <th class="px-5 py-2 text-right">Soll</th>
              <th class="px-5 py-2 text-right">Gap</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-surface-100">
            <tr v-for="row in topGaps" :key="row.capId" class="hover:bg-surface-50">
              <td class="px-5 py-2 font-medium">
                <span class="text-[10px] font-mono text-gray-400 mr-1">{{ row.capId }}</span>
                {{ row.capName }}
              </td>
              <td class="px-5 py-2">
                <span class="inline-block w-3 h-3 rounded mr-1 align-middle" :style="{ backgroundColor: row.domainColor }"></span>
                {{ row.domainName }}
              </td>
              <td class="px-5 py-2 text-right font-mono">{{ row.current }}</td>
              <td class="px-5 py-2 text-right font-mono">{{ row.target }}</td>
              <td class="px-5 py-2 text-right font-bold" :style="{ color: row.gap >= 2 ? '#ef4444' : '#f59e0b' }">{{ row.gap }}</td>
            </tr>
          </tbody>
        </table>
        <div v-if="!topGaps.length" class="text-center py-6 text-sm text-gray-400">No gaps detected.</div>
      </div>
    </div>
  `,
  setup () {
    const { ref, computed, watch, onMounted, nextTick } = Vue
    const selectedDomain = ref(null)
    const gapCanvas = ref(null)
    let chartInstance = null

    const filteredGaps = computed(() => {
      const all = store.maturityGaps || []
      if (!selectedDomain.value) return all
      return all.filter(g => {
        const d = store.data.domains.find(d => d.name === g.domainName)
        return d && d.id === selectedDomain.value
      })
    })

    const avgIst = computed(() => {
      const gs = filteredGaps.value
      return gs.length ? (gs.reduce((s, g) => s + g.current, 0) / gs.length).toFixed(1) : '0'
    })
    const avgSoll = computed(() => {
      const gs = filteredGaps.value
      return gs.length ? (gs.reduce((s, g) => s + g.target, 0) / gs.length).toFixed(1) : '0'
    })
    const avgGapVal = computed(() => {
      const gs = filteredGaps.value
      return gs.length ? (gs.reduce((s, g) => s + g.gap, 0) / gs.length).toFixed(1) : '0'
    })

    const topGaps = computed(() => [...filteredGaps.value].filter(g => g.gap > 0).sort((a, b) => b.gap - a.gap).slice(0, 15))

    const chartHeight = computed(() => Math.max(300, filteredGaps.value.length * 28))

    function renderChart () {
      if (!gapCanvas.value) return
      if (chartInstance) chartInstance.destroy()
      const gs = filteredGaps.value
      const labels = gs.map(g => g.capId + ' ' + g.capName)
      chartInstance = new Chart(gapCanvas.value, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Ist', data: gs.map(g => g.current), backgroundColor: '#3b82f6', borderRadius: 3, barPercentage: 0.6 },
            { label: 'Soll', data: gs.map(g => g.target), backgroundColor: '#818cf8', borderRadius: 3, barPercentage: 0.6 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false, indexAxis: 'y',
          scales: { x: { min: 0, max: 5, ticks: { stepSize: 1 } } },
          plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 12 } } }
        }
      })
    }

    onMounted(() => nextTick(renderChart))
    watch(selectedDomain, () => nextTick(renderChart))

    return { store, selectedDomain, filteredGaps, avgIst, avgSoll, avgGapVal, topGaps, chartHeight, gapCanvas }
  }
}


// ── AppLayout (layout.js) ──
// layout.js — App shell with sidebar navigation and header

const AppLayout = {
  name: 'AppLayout',
  template: `
    <div class="flex h-screen overflow-hidden">
      <!-- Mobile Backdrop -->
      <div v-if="store.sidebarOpen" class="fixed inset-0 bg-black/40 z-30 lg:hidden" @click="store.sidebarOpen = false"></div>

      <!-- Sidebar -->
      <aside class="sidebar no-print bg-white border-r border-surface-200 flex flex-col transition-all duration-300
                    fixed inset-y-0 left-0 z-40 w-64 lg:static lg:z-auto"
             :class="store.sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0 lg:w-0 lg:overflow-hidden'">
        <!-- Logo / Brand -->
        <div class="h-16 flex items-center px-4 border-b border-surface-200 shrink-0">
          <div class="w-8 h-8 rounded-lg bg-primary-600 flex items-center justify-center mr-3">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
          </div>
          <div>
            <div class="font-bold text-sm text-gray-900 leading-tight">EA Bebauungsplan</div>
            <div class="text-xs text-gray-500 truncate">{{ store.data.meta.company || 'Enterprise Architecture' }}</div>
          </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-3 px-2 space-y-0.5">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-gray-400 px-3 pt-2 pb-1">Overview</div>
          <a v-for="item in navOverview" :key="item.path"
             :href="linkTo(item.path)" @click="closeMobile()"
             class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-gray-700"
             :class="{ active: isActive(item.path) }">
            <span v-html="item.icon" class="w-5 h-5 shrink-0"></span>
            <span>{{ item.label }}</span>
          </a>

          <div class="text-[10px] font-semibold uppercase tracking-wider text-gray-400 px-3 pt-4 pb-1">Capabilities & Apps</div>
          <a v-for="item in navCapApps" :key="item.path"
             :href="linkTo(item.path)" @click="closeMobile()"
             class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-gray-700"
             :class="{ active: isActive(item.path) }">
            <span v-html="item.icon" class="w-5 h-5 shrink-0"></span>
            <span>{{ item.label }}</span>
          </a>

          <div class="text-[10px] font-semibold uppercase tracking-wider text-gray-400 px-3 pt-4 pb-1">Projects</div>
          <a v-for="item in navProjects" :key="item.path"
             :href="linkTo(item.path)" @click="closeMobile()"
             class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-gray-700"
             :class="{ active: isActive(item.path) }">
            <span v-html="item.icon" class="w-5 h-5 shrink-0"></span>
            <span>{{ item.label }}</span>
          </a>

          <div class="text-[10px] font-semibold uppercase tracking-wider text-gray-400 px-3 pt-4 pb-1">Strategy & KPIs</div>
          <a v-for="item in navStrategy" :key="item.path"
             :href="linkTo(item.path)" @click="closeMobile()"
             class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-gray-700"
             :class="{ active: isActive(item.path) }">
            <span v-html="item.icon" class="w-5 h-5 shrink-0"></span>
            <span>{{ item.label }}</span>
          </a>

          <div class="text-[10px] font-semibold uppercase tracking-wider text-gray-400 px-3 pt-4 pb-1">System</div>
          <a :href="linkTo('/settings')" @click="closeMobile()"
             class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-gray-700"
             :class="{ active: isActive('/settings') }">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span>Settings</span>
          </a>
        </nav>

        <!-- Version info -->
        <div class="border-t border-surface-200 px-4 py-3 text-[10px] text-gray-400 shrink-0">
          v{{ store.data.meta.version }} · Last saved {{ lastSaved }}
        </div>
      </aside>

      <!-- Main content area -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="h-16 bg-white border-b border-surface-200 flex items-center px-4 gap-4 shrink-0 no-print">
          <button @click="store.sidebarOpen = !store.sidebarOpen"
                  class="p-2 rounded-lg hover:bg-surface-100 text-gray-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
          <h1 class="text-lg font-semibold text-gray-900">{{ pageTitle }}</h1>
          <div class="flex-1"></div>
          <span class="text-xs text-gray-400 hidden sm:block">{{ store.data.meta.company }}</span>
        </header>

        <!-- Page content -->
        <main class="flex-1 overflow-y-auto p-3 sm:p-4 lg:p-6 bg-surface-50">
          <div v-if="!store.loaded" class="flex items-center justify-center h-full">
            <div class="text-center">
              <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary-600 mx-auto mb-4"></div>
              <p class="text-gray-500">Loading data…</p>
            </div>
          </div>
          <component v-else :is="currentComponent" :key="router.path"></component>
        </main>
      </div>
    </div>
  `,
  setup () {
    const navOverview = [
      { path: '/', label: 'Dashboard', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>' }
    ]
    const navCapApps = [
      { path: '/domains', label: 'Domains', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>' },
      { path: '/apps', label: 'Applications', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>' },
      { path: '/capability-matrix', label: 'Cap-App Matrix', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>' },
      { path: '/time', label: 'TIME Quadrant', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/></svg>' }
    ]
    const navProjects = [
      { path: '/projects', label: 'Portfolio', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>' },
      { path: '/project-heatmap', label: 'Project Heatmap', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/></svg>' },
      { path: '/dependencies', label: 'Dependencies', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>' }
    ]
    const navStrategy = [
      { path: '/processes', label: 'E2E Processes', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' },
      { path: '/maturity-gap', label: 'Maturity Gap', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>' }
    ]

    const pageTitles = {
      'dashboard-view': 'Dashboard',
      'domain-list': 'Domains & Capabilities',
      'domain-detail': 'Domain Detail',
      'app-list': 'Applications',
      'app-detail': 'Application Detail',
      'cap-app-matrix': 'Capability–Application Matrix',
      'time-quadrant': 'TIME Quadrant',
      'project-list': 'Project Portfolio',
      'project-detail': 'Project Detail',
      'project-heatmap': 'Project–Domain Heatmap',
      'dependency-graph': 'Project Dependencies',
      'process-list': 'E2E Processes',
      'process-detail': 'Process Detail',
      'maturity-gap': 'Maturity Gap Analysis',
      'settings-view': 'Settings'
    }

    const { computed } = Vue
    const currentComponent = computed(() => router.component || 'dashboard-view')
    const pageTitle = computed(() => pageTitles[currentComponent.value] || 'EA Bebauungsplan')
    const lastSaved = computed(() => {
      const d = store.data.meta.lastUpdated
      if (!d) return '—'
      try { return new Date(d).toLocaleDateString('de-AT') } catch { return d }
    })

    function isActive (path) {
      if (path === '/') return router.path === '/'
      return router.path.startsWith(path)
    }

    function closeMobile () {
      if (window.innerWidth < 1024) store.sidebarOpen = false
    }

    // Start with sidebar closed on mobile
    if (window.innerWidth < 1024) store.sidebarOpen = false

    return {
      store, router, linkTo, navigateTo,
      navOverview, navCapApps, navProjects, navStrategy,
      currentComponent, pageTitle, lastSaved, isActive, closeMobile
    }
  }
}


// ══════ APP INIT ══════
const app = Vue.createApp(AppLayout);

app.component('app-layout', AppLayout);
app.component('dashboard-view', DashboardView);
app.component('settings-view', SettingsView);
app.component('domain-list', DomainList);
app.component('domain-detail', DomainDetail);
app.component('domain-form', DomainForm);
app.component('capability-form', CapabilityForm);
app.component('app-list', AppList);
app.component('app-form', AppForm);
app.component('app-detail', AppDetail);
app.component('cap-app-matrix', CapAppMatrix);
app.component('time-quadrant', TimeQuadrant);
app.component('project-list', ProjectList);
app.component('project-form', ProjectForm);
app.component('project-detail', ProjectDetail);
app.component('project-heatmap', ProjectHeatmap);
app.component('dependency-graph', DependencyGraph);
app.component('process-list', ProcessList);
app.component('process-detail', ProcessDetail);
app.component('process-form', ProcessForm);
app.component('maturity-gap', MaturityGap);

initRouter();
loadData();
startWatching();
app.mount('#app');

console.log('[EA Bebauungsplan] App mounted - ' + store.data.meta.company);
  </script>
</body>
</html>
